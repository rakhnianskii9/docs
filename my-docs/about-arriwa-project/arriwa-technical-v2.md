# üöÄ Arriwa - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

> **üìé –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:**
> - [Webhook Payload Specification](../incoming-webhooks/webhook-payload-specification.md) - RAW —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥—è—â–∏—Ö webhook
> - [Subscriber Data Structure](../subscriber/exact-subscriber-data-structure-v2.md) - –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ –≤ –ë–î
> - [WhatsApp Message Types](../wa-types-message.md) - –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
> - [Project Description](../project-description/description.md) - –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–π –æ–±–∑–æ—Ä –û–ë–©–ò–ô –ü–£–¢–¨

---

## ‚úÖ –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò –ö–û–ú–ü–û–ù–ï–ù–¢–´ –°–ò–°–¢–ï–ú–´

### üì± –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞

**`CTWA`** (Click to WhatsApp Ads)  
–†–µ–∫–ª–∞–º–∞ Facebook/Instagram —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º –≤ WhatsApp

**`Direct Message`**  
–ü—Ä—è–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞

**`QR Code`**  
–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞ —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º –≤ —á–∞—Ç

**`Link Share`**  
–ü–µ—Ä–µ—Ö–æ–¥ –ø–æ wa.me —Å—Å—ã–ª–∫–µ

### üéØ –≠—Ç–∞–ø—ã –≤–æ—Ä–æ–Ω–∫–∏

**`Qualification Steps`** (Q1...Qn)  
–ü–æ—à–∞–≥–æ–≤–∞—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –ª–∏–¥–∞

**`Content Funnel`**  
–û–±—É—á–∞—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å–ª–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏

**`Product Showcase`**  
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥

**`Payment Flow`**  
–ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Stripe

### ü§ñ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤

**`valid`**  
–í–∞–ª–∏–¥–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –≤–æ—Ä–æ–Ω–∫–∏ (confidence ‚â• 0.65)

**`noise`**  
–®—É–º/–±—Ä–µ–¥/–Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç (confidence < 0.3)

**`ambiguous`**  
–ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π –æ—Ç–≤–µ—Ç —Ç—Ä–µ–±—É—é—â–∏–π —É—Ç–æ—á–Ω–µ–Ω–∏—è (0.3 ‚â§ confidence < 0.65)

### üîÑ –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

**`GOOD`**  
–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –≤–∞–ª–∏–¥–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

**`NOISE`**  
–ü–æ—Ç–æ–∫ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö/–º—É—Å–æ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

**`ESCALATION`**  
–≠—Å–∫–∞–ª–∞—Ü–∏—è –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

### üõë –ö–æ–¥-—Å–ª–æ–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**`stop`** / **`—Å—Ç–æ–ø`** / **`unsubscribe`**  
–ü–æ–ª–Ω–∞—è –æ—Ç–ø–∏—Å–∫–∞ –æ—Ç —Ä–∞—Å—Å—ã–ª–æ–∫

**`pause`** / **`–ø–∞—É–∑–∞`**  
–í—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞

**`start`** / **`—Å—Ç–∞—Ä—Ç`**  
–í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–∞—É–∑—ã

**`operator`** / **`–æ–ø–µ—Ä–∞—Ç–æ—Ä`**  
–ó–∞–ø—Ä–æ—Å –∂–∏–≤–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

### üìä –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**`CAPI`** (Facebook Conversions API)  
–°–æ–±—ã—Ç–∏—è –∫–æ–Ω–≤–µ—Ä—Å–∏–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**`Pixels`**  
–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π (GOOD –∏ NOISE –ø–æ—Ç–æ–∫–∏ –Ω–∞ —Ä–∞–∑–Ω—ã–µ pixels/datasets)

**`Ads Manager`**  
–¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π

**`Custom Audience`**  
–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, LAL

**`E-commerce –∏ WhatsApp catalog`**  
–¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞–ø—Ä—è–º—É—é –≤ —á–∞—Ç WhatsApp

**`Ads Audience Transporter`**  
–¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–π –≤ Google, TikTok, LinkedIn

**`Enrichment`**  
–¥–ª—è –¥–≤—É—Ö—Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ –æ–±–æ–≥–∞—â–µ–Ω–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–∞–Ω–Ω—ã–º–∏

**`Kommo CRM`**  
–¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞–º–∏ —Å–¥–µ–ª–æ–∫

**`Stripe`**  
–¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç

**`Vuexy`**  
frontend –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –º–æ–¥—É–ª—è–º–∏, –æ—Ç—á–µ—Ç–∞–º–∏ –∏ –ø—Ä

---

## üè¢ –û–Ω–±–æ—Ä–¥–∏–Ω–≥ (–∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞)

–®–∞–≥–∏ (—Å—Ç—Ä–æ–≥–æ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é):
1. https://flows.rakhnianskii.com ‚Äî –ø–µ—Ä–≤–∏—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Facebook (public_profile, business_management, email)
2. /wa-onboarding ‚Äî —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –¥–æ—Å—Ç—É–ø–µ–Ω
3. –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –ø–æ–ª—É—á–µ–Ω–∏–µ/–ø—Ä–∏–≤—è–∑–∫–∞ –Ω–æ–º–µ—Ä–∞)
4. /credentials ‚Äî —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ CAPI, Pixels, –∞—É–¥–∏—Ç–æ—Ä–∏–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (ads_read, ads_management)
5. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è e-commerce –∫–∞—Ç–∞–ª–æ–≥–∞ (commerce_account_read_orders, commerce_account_read_reports, commerce_account_read_settings, catalog_management)
6. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /chatflows

---

## üîß FLOWISE –û–†–ö–ï–°–¢–†–ê–¶–ò–Ø –ò –ò–°–¢–û–ß–ù–ò–ö–ò –ò–°–¢–ò–ù–´

### Agentflow ‚Üí Chatflow –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:**
- **Agentflow** - —É–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–ª–æ–π, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π, –∞–≥–µ–Ω—Ç/–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä (–∫–æ–¥-—Å–ª–æ–≤–∞, —Å—Ç–∞—Ä—Ç/—ç—Å–∫–∞–ª–∞—Ü–∏–∏, –≤—ã–∑–æ–≤ —á–∞—Ç-—Å—Ü–µ–Ω–∞—Ä–∏—è)
- **Chatflow** - –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–ª–æ–π, LLM –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è, –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —à–∞–≥–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–≤–∞–ª–∏–¥–∞—Ç–æ—Ä/–ø–∞—Ä—Å–∏–Ω–≥/–≤–µ—Ç–≤–ª–µ–Ω–∏—è/—ç–º–∏—Å—Å–∏–∏)

**–§–æ—Ä–º–∞—Ç sessionId (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π):**
```
{source}_{details}_{subscriber_id}_{timestamp}
```

–ü—Ä–∏–º–µ—Ä—ã:
- **CTWA**: `ctwa_fb_{subscriber_id}_{timestamp}`
- **QR**: `qr_{product_id}_{subscriber_id}_{timestamp}`  
- **Direct**: `direct_{subscriber_id}_{timestamp}`
- **Link**: `link_{utm_source}_{subscriber_id}_{timestamp}`
- **WhatsApp –ø—Ä–∞–∫—Ç–∏–∫–∞**: `<tenant>:<phone>:<flow>` ‚Äî —á—Ç–æ–±—ã –Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã/–≤–æ—Ä–æ–Ω–∫–∏

### –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–≤: ¬´—Å–µ—Å—Å–∏—è¬ª (sessionId)

- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** —è—Ä–ª—ã–∫, –ø–æ–¥ –∫–æ—Ç–æ—Ä—ã–º Flowise/Arriwa —Ö—Ä–∞–Ω–∏—Ç –∏ —á–∏—Ç–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é *–¥–∞–Ω–Ω–æ–≥–æ* —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —à–∞–≥–∞
- **–ö—Ç–æ –∑–∞–¥–∞—ë—Ç:** sessionId –∑–∞–¥–∞—ë–º **–º—ã**; –≤—Å–µ Memory-–Ω–æ–¥—ã –∏ –∫–∞—Å—Ç–æ–º-—Ç—É–ª—ã —á–∏—Ç–∞—é—Ç/–ø–∏—à—É—Ç –ø–æ –Ω–µ–º—É
- **–ì–¥–µ –∂–∏–≤—ë—Ç:** –≤ Arriwa ‚Äî `Redis` (–∂–∏–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ–∫–Ω–∞/–∫–æ–Ω—Ç–µ–∫—Å—Ç), `PostgreSQL` (–∞—Ä—Ö–∏–≤/—Å–æ—Å—Ç–æ—è–Ω–∏–µ —à–∞–≥–æ–≤), –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å —á–µ—Ä–µ–∑ `pgvector`. –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è Buffer-–ø–∞–º—è—Ç—å Flowise –ø–∏—à–µ—Ç –≤ `chat_message`, –Ω–æ **–Ω–µ** —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã
- **–ü–µ—Ä–µ–¥–∞—á–∞ –≤ —Ä–∞–Ω—Ç–∞–π–º–µ:** Prediction API ‚Üí `overrideConfig.sessionId`; –≤ —É–∑–ª–∞—Ö/—Ç—É–ª–∞—Ö –¥–æ—Å—Ç—É–ø–Ω–æ –∫–∞–∫ `$flow.sessionId`
- **–û—Ç–ª–∏—á–∏–µ –æ—Ç chatId:** chatId ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –±–µ—Å–µ–¥—ã Flowise; sessionId ‚Äî –Ω–∞—à –≤–Ω–µ—à–Ω–∏–π/–ª–æ–≥–∏—á–µ—Å–∫–∏–π ID. –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Å–∫–ª–µ–π–∫–∏ ‚Äî `sessionId`

### –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã (–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ)

- **–ü–æ—Ä–æ–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏:** `0.65` (–µ–¥–∏–Ω—ã–π –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –∏ –ª–æ–≥–∏–∫–∏ –∞–≥–µ–Ω—Ç–∞)
- **–•—Ä–∞–Ω–∏–ª–∏—â–∞:** `Redis` (–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å/–∫–æ–Ω—Ç–µ–∫—Å—Ç + –∫—ç—à), `PostgreSQL` (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã), `pgvector` (—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å/RAG)

### –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥-—Å–ª–æ–≤

**–£—Ä–æ–≤–µ–Ω—å 1: –ë—ç–∫–µ–Ω–¥ (primary source of truth)**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –ö–ê–ñ–î–û–ú –≤—Ö–æ–¥—è—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–æ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –ª–æ–≥–∏–∫–∏
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤ lowercase, –ø–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π (optOut, snooze, escalation)

**–£—Ä–æ–≤–µ–Ω—å 2: Flowise Agentflow (—Å—Ç—Ä–∞—Ö–æ–≤–æ—á–Ω–∞—è —Å–µ—Ç–∫–∞)**
- –î—É–±–ª–∏—Ä—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è edge cases
- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ –∏–ª–∏ —Å–±–æ–µ webhook
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±—ç–∫–µ–Ω–¥–æ–º —á–µ—Ä–µ–∑ API

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏—Å—Ç–∏–Ω—ã –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å

**–ö–æ–¥-—Å–ª–æ–≤–∞**: –±—ç–∫–µ–Ω–¥ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
- Flowise: —Å—Ç—Ä–∞—Ö–æ–≤–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è edge cases (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫, —Å–±–æ–π webhook)

**–°–æ—Å—Ç–æ—è–Ω–∏–µ —à–∞–≥–∞**: Flowise Variables + –ë–î (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)
- Variables: –∂–∏–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏
- –ë–î: –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞

**–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞**: Redis/Valkey (–∂–∏–≤–∞—è) + Postgres (–∞—Ä—Ö–∏–≤)

**–°—á–µ—Ç—á–∏–∫–∏ —Ä–µ–ø—Ä–æ–º–ø—Ç–æ–≤**: Flowise Variables (–≤ —Ä–∞–º–∫–∞—Ö —à–∞–≥–∞)

**–°—á–µ—Ç—á–∏–∫–∏ –Ω—É–¥–∂–µ–π**: –±—ç–∫–µ–Ω–¥ nudge-service (–º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏)

**CTWA –¥–∞–Ω–Ω—ã–µ**: –ë–î (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è)

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ event_id

```javascript
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ event_id
event_id = `{sessionId}-q{n}-{hash(answer_raw)}`
// normalize: trim/lower/collapse spaces/remove urls/phones/emojis

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ outbox –ø–µ—Ä–µ–¥ —ç–º–∏—Å—Å–∏–µ–π
const exists = await db.events_outbox.findUnique({
  where: { event_id }
})

if (exists) {
  return exists.result // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
}
```

---

## üìã –¢–û–ß–ö–ò –í–•–û–î–ê –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø

### CTWA-–∫–ª–∏–∫ –∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ —Ä–µ–∫–ª–∞–º—É Facebook/Instagram
2. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è WhatsApp —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º –±–∏–∑–Ω–µ—Å–∞
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ª—é–±–æ–π —Ç–µ–∫—Å—Ç –∏–ª–∏ —à–∞–±–ª–æ–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ)

**Webhook Gupshup –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ:**
- **–ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è CTWA-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**: campaign_id, adset_id, ad_id, creative_id, utm_*, placement, publisher_platform, click_id
- **–°–æ–∑–¥–∞–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π sessionId**: `ctwa_fb_{subscriber_id}_{timestamp}`
- **–°—Ç–∞—Ä—Ç–æ–≤—ã–π —Ç—Ä–∏–≥–≥–µ—Ä**: –ª—é–±–æ–µ –ø–µ—Ä–≤–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: phone, name, language, country, timezone

### QR Code –≤—Ö–æ–¥ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞)

**QR —Å–æ–¥–µ—Ä–∂–∏—Ç**: `wa.me/79991234567?text=QR_START_PROMO&product_id=SKU001&location_id=MSK`

**–ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**: product_id, location_id, promo_code

**–°–æ–∑–¥–∞–µ—Ç—Å—è —Å–µ—Å—Å–∏—è**: `qr_{product_id}_{subscriber_id}_{timestamp}`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ø–æ–∫–∞–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞/—É—Å–ª—É–≥–∏ –∏–∑ product_id

### –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥-—Å–ª–æ–≤

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –ö–ê–ñ–î–û–ú –≤—Ö–æ–¥—è—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–æ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –ª–æ–≥–∏–∫–∏:**

| –¢—Ä–∏–≥–≥–µ—Ä  | –í–∞—Ä–∏–∞–Ω—Ç—ã                              | –£—Å–ª–æ–≤–∏–µ        | –î–µ–π—Å—Ç–≤–∏–µ                      | –û—Ç–≤–µ—Ç                  | –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è    |
| -------- | ------------------------------------- | -------------- | ----------------------------- | ---------------------- | -------------- |
| –û–ø–µ—Ä–∞—Ç–æ—Ä | –æ–ø–µ—Ä–∞—Ç–æ—Ä/—á–µ–ª–æ–≤–µ–∫/support/agent/–ø–æ–º–æ—â—å | –±–µ–∑ ¬´–Ω–µ¬ª —Ä—è–¥–æ–º | `hold=true`, HITL             | ¬´–ü–æ–¥–∫–ª—é—á–∞—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞‚Ä¶¬ª | SLA, –Ω—É–¥–∂–∏ off |
| –°—Ç–æ–ø     | —Å—Ç–æ–ø/stop/unsubscribe/–æ—Ç–ø–∏—Å–∫–∞         | –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ     | `optOut=true`                 | ¬´–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ‚Ä¶¬ª         | –ë–ª–æ–∫ –∏—Å—Ö–æ–¥—è—â–∏—Ö |
| –ü–∞—É–∑–∞    | –ø–∞—É–∑–∞/–ø–æ–∑–∂–µ/—á–µ—Ä–µ–∑ X                   | ‚Äî              | `snoozeUntil=ts`, `hold=true` | ¬´–ü–∞—É–∑–∞ –¥–æ‚Ä¶¬ª            | –†–µ—Ç—Ä–∞–∏ off     |
| –°—Ç–∞—Ä—Ç    | —Å—Ç–∞—Ä—Ç/–ø—Ä–æ–¥–æ–ª–∂–∏–º/–ø—Ä–æ–¥–æ–ª–∂–∞–π             | –∏–∑ hold        | `hold=false`                  | ¬´–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å qN¬ª      | –¢–∞–π–º–µ—Ä—ã on     |

### –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)

**CAPI Facebook**: —Å–æ–±—ã—Ç–∏–µ Start/OptIn —Å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞
**Custom Audiences**: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∞—É–¥–∏—Ç–æ—Ä–∏—é A1_STARTED_NOT_FINISHED
**Kommo CRM**: —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ–Ω—Ç–∞–∫—Ç –∏ —Å–¥–µ–ª–∫–∞ –≤ —Å—Ç–∞–¥–∏–∏ "–ù–æ–≤—ã–π"
**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å—á–∏–∫ —Å CTWA-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏ raw referral –±–ª–æ–∫–æ–º
**–ú–µ–Ω–µ–¥–∂–µ—Ä**: –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º (round-robin/–Ω–∞–≥—Ä—É–∑–∫–∞/–≥–µ–æ)
**Flowise**: –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è Agentflow —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Å–µ—Å—Å–∏–∏

---

## üéØ N-–®–ê–ì–û–í–´–ô –ö–í–ê–õ–ò–§–ò–ö–ê–¢–û–† + ¬´–ñ–ò–í–û–ô¬ª –ê–ì–ï–ù–¢ + –î–í–ê –ü–û–¢–û–ö–ê (GOOD/NOISE)

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Ä–∞–º–∫–∏

- N —à–∞–≥–æ–≤ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–Ω–µ —Ñ–∏–∫—Å.)
- –ù–∞ **–∫–∞–∂–¥–æ–º –≤–∞–ª–∏–¥–Ω–æ–º –æ—Ç–≤–µ—Ç–µ** ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ —ç–º–∏—Å—Å–∏–∏: **CAPI / –ê—É–¥–∏—Ç–æ—Ä–∏–∏ / CRM / –ë–î**
- **–®—É–º/ambiguous** ‚Äî –Ω–µ –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã; –ª–∏–±–æ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ **noise-–∫–∞–Ω–∞–ª—ã/–∞—É–¥–∏—Ç–æ—Ä–∏–∏**/**–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø–∏–∫—Å–µ–ª—å/–¥–∞—Ç–∞—Å–µ—Ç** (–¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤—Å–µ–≥–¥–∞ –∞–∫—Ç–∏–≤–µ–Ω ¬´–∂–∏–≤–æ–π¬ª –∞–≥–µ–Ω—Ç: –∞–Ω—Ç–∏-—á—É—à—å, –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã (–ë–ó), –∫–æ–¥-—Å–ª–æ–≤–∞, –Ω—É–¥–∂–∏, HITL
- **Persist-all:** —Å–æ—Ö—Ä–∞–Ω—è–µ–º **–≤—Å–µ** –æ—Ç–≤–µ—Ç—ã/—à—É–º—ã –≤ –ë–î (–¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ **lookalike-–∏—Å–∫–ª—é—á–µ–Ω–∏–π**)
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, outbox, —Ä–µ—Ç—Ä–∞–∏ ‚Äî **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**

### –°–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Ñ–ª–∞–≥–∏ (–º–∏–Ω–∏–º—É–º)

`stage‚àà{Q1..Qn,CONTENT,END}`, `askedId`, `expectedType‚àà{free_text,choice}`, `answers{}`, `validity‚àà{valid,noise,ambiguous}`, `quality_score‚àà[0..1]`, `retries[qN]`, `hold`, `optOut`, `snoozeUntil`, –¥–æ—Å—Ç–∞–≤–∫–∞ (`lastOutboundId,lastStatus,lastStatusAt,nudgeCount[qN]`), `parkingLot[]`

### –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏/—Å–ª–æ–≤–∞—Ä–∏

`willCoverLater(topic)‚Üístep`, —Å–∏–Ω–æ–Ω–∏–º—ã/–Ω–µ–≥–∞—Ü–∏–∏ –∫–æ–¥-—Å–ª–æ–≤, —Å–∏–Ω–æ–Ω–∏–º—ã –æ–ø—Ü–∏–π, –∫–∞—Ç–∞–ª–æ–≥–∏ `niche/budget_bucket/channel`, –º–∞—Ä–∫–µ—Ä—ã –≤–∞–∂–Ω–æ—Å—Ç–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ (`high/low`)

### –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö

1. –ö–æ–¥-—Å–ª–æ–≤–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç): `operator`‚ÜíHITL/hold, `stop`‚ÜíoptOut, `pause`‚Üísnooze+hold, `start`‚Üíresume
2. –ï—Å–ª–∏ –Ω–µ –∫–æ–¥-—Å–ª–æ–≤–æ ‚Üí `intent‚àà{funnel_answer,question,smalltalk,noise}`
3. –î–ª—è `funnel_answer` ‚Üí –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å `validity, quality_score`
4. –î–ª—è `question` ‚Üí `relevance to_funnel/off_funnel`, `willCoverLater`, `importance`

### –ú–∞—Ç—Ä–∏—Ü–∞ —Ä–µ—à–µ–Ω–∏–π –ø–æ —à–∞–≥–∞–º

**–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:**
- Q1: "–ö–∞–∫–∞—è —É –≤–∞—Å –æ—Å–Ω–æ–≤–Ω–∞—è –±–æ–ª—å/–∑–∞–¥–∞—á–∞?" / "–ö–∞–∫–∞—è –Ω–∏—à–∞?"
- Q2: "–ö–∞–∫–æ–π —É –≤–∞—Å –º–µ—Å—è—á–Ω—ã–π –±—é–¥–∂–µ—Ç –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥?"
- Q3: "–ö–∞–∫–æ–π –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª –ø—Ä–æ–¥–∞–∂ —Å–µ–π—á–∞—Å?"
- Q4: "–ì–æ—Ç–æ–≤—ã –ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç –ø—Ä–∏ —Ä–æ—Å—Ç–µ –ø—Ä–æ–¥–∞–∂?"
- Q5: "–ö–∞–∫–æ–π –∫–ª—é—á–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å (KPI) —Å—Ç–∞–Ω–µ—Ç –¥–ª—è –≤–∞—Å –º–µ—Ä–∏–ª–æ–º —É—Å–ø–µ—à–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –±–∏–∑–Ω–µ—Å–∞?"

### –ê–Ω—Ç–∏-—á—É—à—å –∏ –ø–∞—Ä—Å–∏–Ω–≥ –ø–æ —à–∞–≥–∞–º

- **Q1 (free_text: niche,pain):** pain ‚â•4 –∑–Ω–∞—á–∏–º—ã—Ö —Å–ª–æ–≤; niche ‚àà –∫–∞—Ç–∞–ª–æ–≥–µ; **–±–ª–∏–∑–æ—Å—Ç—å ‚â•0.7**
- **Q2 (free_text: budget):** –∏–∑–≤–ª–µ—á—å —á–∏—Å–ª–æ/–¥–∏–∞–ø–∞–∑–æ–Ω ‚Üí `bucket‚àà{<1k,1‚Äì5k,5‚Äì20k,20k+}`; **–±–ª–∏–∑–æ—Å—Ç—å ‚â•0.7**
- **Q3 (choice):** —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å –æ–ø—Ü–∏—è–º–∏/—Å–∏–Ω–æ–Ω–∏–º–∞–º–∏ **‚â•0.8**
- **Q4 (choice):** –¥–∞/–Ω–µ—Ç **‚â•0.8**
- –†–µ—Ç—Ä–∞–∏ –∞–Ω—Ç–∏-—á—É—à–∏: 1 ‚Äî —Ä–µ–ø—Ä–æ–º–ø—Ç; 2 ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∏/–∫–Ω–æ–ø–∫–∏; 3 ‚Äî –æ–ø–µ—Ä–∞—Ç–æ—Ä

### –õ–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤

**–ü—Ä–∏ –≤–∞–ª–∏–¥–Ω–æ–º –æ—Ç–≤–µ—Ç–µ (confidence ‚â• 0.65):**
- CAPI ‚Üí —Å–æ–±—ã—Ç–∏–µ QUALIFY_Q{n}
- Custom Audiences ‚Üí –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ CA_QUAL_Q{n} –∏ —Å–µ–≥–º–µ–Ω—Ç–Ω—ã–µ (–±—é–¥–∂–µ—Ç/–∫–∞–Ω–∞–ª/–Ω–∏—à–∞)
- CRM ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ custom fields –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ (cf_niche, cf_budget_month)
- –ë–î ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –∏ confidence score
- –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É

**–ü—Ä–∏ —à—É–º–µ/–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏ (confidence < 0.65):**
- –†–µ–ø—Ä–æ–º–ø—Ç ‚Üí –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —É—Ç–æ—á–Ω–µ–Ω–∏—è –≤ —Ä–∞–º–∫–∞—Ö —à–∞–≥–∞
- NOISE pixel ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–π dataset –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- Custom Audiences ‚Üí CA_EXCLUDE_NOISE
- CRM ‚Üí —Ç–µ–≥ trash/ambiguous
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

### –≠–º–∏—Å—Å–∏–∏ –Ω–∞ **–∫–∞–∂–¥–æ–º –≤–∞–ª–∏–¥–Ω–æ–º** –æ—Ç–≤–µ—Ç–µ

**CAPI (–ø—Ä–∏–º–µ—Ä):**

```json
{
  "event_name": "QUALIFY_Q{N}",
  "event_time": 1736123456,
  "event_id": "sess-123-q2-9a1c...",
  "action_source": "chat",
  "user_data": {
    "external_id": "<sha256(tenantId:subscriberId)>",
    "ph": "<sha256(msisdn)>"
  },
  "custom_data": {
    "step": "q2",
    "answer_raw": "–æ–∫–æ–ª–æ 2500$",
    "answer_parsed": {"budget_month":2500,"bucket":"1‚Äì5k"},
    "quality_score": 0.86,
    "validity": "valid",
    "session_id": "sess-123",
    "tenant_id": "tenant-1",
    "project_id": "project-1",
    "mapping_version": "1.0.0"
  }
}
```

**–ê—É–¥–∏—Ç–æ—Ä–∏–∏:**
- `valid` ‚Üí `CA_QUAL_{stepKey}` + –≤–µ—Ç–≤–µ–≤—ã–µ (`CA_NICHE_*`, `CA_BUDGET_*`, `CA_CHANNEL_*`, `CA_UPLIFT_{yes|no}`)
- `noise/ambiguous` ‚Üí `CA_EXCLUDE_NOISE` **–∏/–∏–ª–∏** ¬´—Ç–µ–Ω–µ–≤–æ–π¬ª –ø–∏–∫—Å–µ–ª—å/–¥–∞—Ç–∞—Å–µ—Ç **NEG**

**CRM:**
Upsert –ª–∏–¥–∞; –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π —à–∞–≥–∞; –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π `QUALIFY_{stepKey}` (raw/parsed/qs)

**–≠–º–∏—Å—Å–∏–∏ –ø–æ —à–∞–≥–∞–º ‚Äî –¥–∞–π–¥–∂–µ—Å—Ç:**
- **Q1:** CAPI `QUALIFY_Q1{niche,pain}`; Aud `CA_QUAL_Q1 + CA_NICHE_*`; CRM `cf_niche/cf_pain`; DB+outbox
- **Q2:** CAPI `QUALIFY_Q2{budget_month,bucket}`; Aud `CA_QUAL_Q2 + CA_BUDGET_*`; CRM `cf_budget_*`; DB
- **Q3:** CAPI `QUALIFY_Q3{main_traffic_channel}`; Aud `CA_QUAL_Q3 + CA_CHANNEL_*`; CRM `cf_main_channel`; DB
- **Q4:** CAPI `QUALIFY_Q4{uplift}`; Aud `CA_QUAL_Q4 + CA_UPLIFT_{yes|no}`; CRM `cf_budget_uplift_ready`; DB

### –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è noise/ambiguous

- **S1 (–∂—ë—Å—Ç–∫–∞—è):** –ë–î + `CA_EXCLUDE_NOISE`, –±–µ–∑ CAPI/CRM
- **S2 (—Ç–µ–Ω–µ–≤–∞—è):** **NEG** CAPI –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–∏–∫—Å–µ–ª—å/–¥–∞—Ç–∞—Å–µ—Ç `NEG_QUALIFY_{stepKey}`; CRM ‚Äî –Ω–µ—Ç
- **S3 (—Å–º–µ—à–∞–Ω–Ω–∞—è):** CRM-–∑–∞–º–µ—Ç–∫–∞ (–±–µ–∑ —Å—Ç–∞–¥–∏–∏) + `CA_EXCLUDE_NOISE`; CAPI ‚Äî –Ω–µ—Ç
**Persist-all:** —Å–æ—Ö—Ä–∞–Ω—è–µ–º **–≤—Å—ë** (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ **lookalike-–∏—Å–∫–ª—é—á–µ–Ω–∏–π**)

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/hold

- –ü–µ—Ä–≤—ã–π `valid` –ø–æ —à–∞–≥—É ‚Üí —à—Ç–∞—Ç–Ω—ã–π –ø–∞–∫–µ—Ç —ç–º–∏—Å—Å–∏–π
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π `valid` ‚Üí `QUALIFY_{stepKey}_UPDATE` (–∏–ª–∏ —Ç–æ—Ç –∂–µ `event_id`)
- `ambiguous/noise` **–Ω–∏–∫–æ–≥–¥–∞** –Ω–µ –∞–ø–¥–µ–π—Ç–∏—Ç `valid`-–∏–≤–µ–Ω—Ç
- `hold=true` (–æ–ø–µ—Ä–∞—Ç–æ—Ä/–ø–∞—É–∑–∞): –≤–æ–ø—Ä–æ—Å—ã –Ω–µ —à–ª—ë–º –∏ –Ω—É–¥–∂–∏ off; **–≤–∞–ª–∏–¥–Ω—ã–µ –≤—Ö–æ–¥—è—â–∏–µ –æ—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ —ç–º–∏—Ç–∏–º**
- `optOut=true`: –≤—Å–µ –∏—Å—Ö–æ–¥—è—â–∏–µ off; –≤–∞–ª–∏–¥–Ω—ã–µ –≤—Ö–æ–¥—è—â–∏–µ ‚Äî **—Ç–æ–ª—å–∫–æ –ë–î** (–±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö —ç–º–∏—Å—Å–∏–π)

### StepValidator (Custom Function –≤ Chatflow)

```javascript
async function validateStep(input, options) {
  const { step, answer, session } = input
  
  // –í—ã–∑–æ–≤ LLM –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
  const validation = await classifyAnswer({
    step,
    question: QUESTIONS[step],
    answer,
    context: session.variables
  })
  
  // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ validity
  let validity = 'ambiguous'
  if (validation.confidence >= 0.65) {
    validity = 'valid'
  } else if (validation.confidence < 0.3) {
    validity = 'noise'
  }
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î —Å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é
  const eventId = generateEventId(session.id, step, answer)
  await db.funnel_answers.upsert({
    where: { event_id: eventId },
    create: {
      tenant_id: session.tenant_id,
      subscriber_id: session.subscriber_id,
      session_id: session.id,
      step,
      answer_raw: answer,
      answer_parsed: validation.parsed,
      validity,
      quality_score: validation.confidence,
      event_id: eventId,
      version: 1
    }
  })
  
  // –≠–º–∏—Å—Å–∏—è —Å–æ–±—ã—Ç–∏–π –¥–ª—è valid
  if (validity === 'valid') {
    await emitToAllChannels({
      event_type: `QUALIFY_${step}`,
      event_id: eventId,
      session,
      answer: validation.parsed
    })
  }
  
  return {
    validity,
    confidence: validation.confidence,
    parsed: validation.parsed,
    nextAction: determineNextAction(validity, session)
  }
}
```

---

## ‚è± –ù–£–î–ñ–ò –ò –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø - STATE MACHINE

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã

- `delivered` (–Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ): `T+15–º` ‚Üí –¥–æ `24—á`, **–ª–∏–º–∏—Ç 2**
- `read` (–ø—Ä–æ—á–∏—Ç–∞–Ω–æ, –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞): `T+2–º` ‚Üí –¥–æ `20–º`, **–ª–∏–º–∏—Ç 2**
- `failed`: —Å—Ä–∞–∑—É; –∑–∞—Ç–µ–º `snooze 24—á` + –∞–ª–µ—Ä—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É

**–ü—Ä–∞–≤–∏–ª–∞:** –º–∏–Ω. –∏–Ω—Ç–µ—Ä–≤–∞–ª ‚â•2 –º–∏–Ω; –ø—Ä–∏ `hold/optOut/snooze` ‚Äî OFF; —É—á–∏—Ç—ã–≤–∞—Ç—å —Ä–∞–±–æ—á–∏–µ –æ–∫–Ω–∞

### State Machine –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π

```
PENDING ‚Üí SENT ‚Üí DELIVERED ‚Üí READ ‚Üí REPLIED
         ‚Üì       ‚Üì           ‚Üì       ‚Üì
       FAILED  NOT_DELIVERED IGNORED PROCESSED
         ‚Üì                    ‚Üì
      RETRY/ESCALATE      NUDGE_SENT
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω—É–¥–∂–µ–π

```json
{
  "nudge_rules": [
    {
      "trigger": "message_sent_not_read",
      "delay": "15m",
      "max_attempts": 2,
      "window": "24h",
      "action": {
        "type": "reminder",
        "template": "nudge_not_read",
        "text": "üëã –í–∏–¥–∏–º–æ –≤—ã –∑–∞–Ω—è—Ç—ã. –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –∂–¥–∞—Ç—å –≤–∞—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞"
      }
    },
    {
      "trigger": "message_read_no_reply", 
      "delay": "2m",
      "max_attempts": 2,
      "window": "20m",
      "action": {
        "type": "follow_up",
        "template": "nudge_no_reply",
        "text": "–í—ã –∑–¥–µ—Å—å? –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –æ—Ç–≤–µ—Ç–æ–º?"
      }
    },
    {
      "trigger": "qualification_abandoned",
      "delay": "1h",
      "max_attempts": 1,
      "window": "24h",
      "action": {
        "type": "re_engage",
        "template": "come_back_template",
        "switch_to_template": true
      }
    }
  ]
}
```

### –†–∞–∑–ª–∏—á–∏–µ: –†–µ–ø—Ä–æ–º–ø—Ç—ã vs –ù—É–¥–∂–∏

**–†–µ–ø—Ä–æ–º–ø—Ç—ã** (–≤ —Ä–∞–º–∫–∞—Ö —à–∞–≥–∞):
- –°—á–µ—Ç—á–∏–∫ –≤ Flowise Variables
- –î–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —Å—Ä–∞–∑—É –≤ –¥–∏–∞–ª–æ–≥–µ
- –ü—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å

**–ù—É–¥–∂–∏** (–º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏):
- –°—á–µ—Ç—á–∏–∫ –≤ –±—ç–∫–µ–Ω–¥ nudge-service
- –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ —Ç–∞–π–º–∏–Ω–≥—É
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ

---

## üôã –í–û–ü–†–û–°–´ –ò –≠–°–ö–ê–õ–ê–¶–ò–Ø

### –í–æ–ø—Ä–æ—Å—ã (–≤ –ª—é–±–æ–π —Ç–æ—á–∫–µ)

- `to_funnel & –±—É–¥–µ—Ç` ‚Üí –Ω–∞–∑–≤–∞—Ç—å —à–∞–≥, –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ `askedId`
- `to_funnel & –Ω–µ –±—É–¥–µ—Ç` ‚Üí `importance`: low‚Üíparking; high‚ÜíKB (‚â•0.7) –∏–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä
- `off_funnel` ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤–∞–∂–Ω–æ—Å—Ç–∏; –ø–æ—Å–ª–µ ‚Äî ¬´–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ {askedId}¬ª

### –ú—É–ª—å—Ç–∏-–∏–Ω—Ç–µ–Ω—Ç

–ï—Å–ª–∏ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç+–≤–æ–ø—Ä–æ—Å: 
1. —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å/—ç–º–∏—Ç–∏—Ç—å valid
2. –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ–ø—Ä–æ—Å (¬ß10)
3. –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É —à–∞–≥—É

### –ü–∞—Ä–∫–∏–Ω–≥/–¥–æ—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å–ª–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏

–í `CONTENT/END`: —Å–Ω–∞—á–∞–ª–∞ high (KB‚â•0.7/–æ–ø–µ—Ä–∞—Ç–æ—Ä), –∑–∞—Ç–µ–º low –±–∞—Ç—á-–æ—Ç–≤–µ—Ç–æ–º

### –≠—Å–∫–∞–ª–∞—Ü–∏—è (HITL)

**–¢—Ä–∏–≥–≥–µ—Ä—ã:** `retries‚â•3`, `KB.conf<0.7` –ø—Ä–∏ high, —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å/–∂–∞–ª–æ–±–∞/—Ä–∏—Å–∫–∏, —è–≤–Ω—ã–π ¬´–æ–ø–µ—Ä–∞—Ç–æ—Ä¬ª

**–ü–∞–∫–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É:** `stage/askedId`, –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π, `importance/relevance/confidence`, –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –ø–æ–ª—è, –æ–±–µ—â–∞–Ω–∏—è

**–ü–æ—Å–ª–µ:** ¬´–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å qN¬ª

---

## üíæ –ü–ê–ú–Ø–¢–¨: –ö–ê–ö –ò –ß–¢–û –ò–°–ü–û–õ–¨–ó–£–ï–ú

### –°–ª–æ–π –ø–∞–º—è—Ç–∏

**–ö–æ—Ä–æ—Ç–∫–∞—è (runtime, 24‚Äì72—á) ‚Üí Redis**
- **–ß—Ç–æ –∫–ª–∞–¥—ë–º:** –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è LLM, –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π, –±—ã—Å—Ç—Ä—ã–µ —Ñ–ª–∞–≥–∏ (`retries/hold/optOut`), –∫–æ–Ω—Ç–µ–∫—Å—Ç —à–∞–≥–∞
- **–ó–∞—á–µ–º:** –¥—ë—à–µ–≤–æ/–±—ã—Å—Ç—Ä–æ, –Ω–∏–∑–∫–∞—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, TTL, –∫–ª—é—á–∏ –ø–æ `sessionId`
- **–ì–¥–µ –≤ Flowise:**
  - **Redis Cache** ‚Äî –∫—ç—à –æ—Ç–≤–µ—Ç–æ–≤ LLM
  - **Redis-Backed Chat Memory** ‚Äî –¥–∏–∞–ª–æ–≥ –¥–ª—è –∞–≥–µ–Ω—Ç–∞

**–î–æ–ª–≥–∞—è (–∞—É–¥–∏—Ç/–∞–Ω–∞–ª–∏—Ç–∏–∫–∞/–ø–æ–∏—Å–∫) ‚Üí Postgres (+pgvector –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)**
- **–ß—Ç–æ –∫–ª–∞–¥—ë–º:** `messages_raw/meta/links`, `funnel_answers`, `events_outbox`, CTWA-–º–µ—Ç–∫–∏, –∑–∞–∫–∞–∑—ã/–æ–ø–ª–∞—Ç—ã, ¬´–≤–µ—á–Ω–∞—è¬ª –ø–∞–º—è—Ç—å —Ñ–∞–∫—Ç–æ–≤
- **–ó–∞—á–µ–º:** –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å, SQL, –æ—Ç—á—ë—Ç—ã, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, RAG (—á–µ—Ä–µ–∑ `pgvector`)

**(–û–ø—Ü.) –í–µ–∫—Ç–æ—Ä–Ω—ã–π —Å–ª–æ–π ‚Üí pgvector** ‚Äî —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Ñ–∞–∫—Ç–æ–≤/–ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π

### –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —É–∑–ª—ã/–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ Chatflow

**Redis Cache**
- Credential: –≤–∞—à Redis/Valkey
- `TTL: 600‚Äì3600s`
- `Key prefix: ws:{{$vars.workspaceId}}:cache:`
- –ü–æ–¥–∫–ª—é—á–∞—Ç—å –∫ ChatOpenAI/–º–æ–¥–µ–ª–∏ –∫–∞–∫ Cache

**Redis-Backed Chat Memory**
- Credential: —Ç–æ—Ç –∂–µ Redis
- `Session Id: {{$vars.sessionId}}`
- `Prefix: ws:{{$vars.workspaceId}}:chat:`
- **Window: 8‚Äì20 —Å–æ–æ–±—â–µ–Ω–∏–π** *(—ç—Ç–æ **–ø—Ä–∏–º–µ—Ä**, –Ω–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞)*
- –ü–æ–¥–∫–ª—é—á–∞—Ç—å –≤ Tool/Conversational Agent ‚Üí Memory

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (Set/Get Variable)**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º: `workspaceId, tenantId, sessionId, stepKey, retries`

**–î–æ–ª–≥–∞—è –ø–∞–º—è—Ç—å** ‚Äî –¥–µ–ª–∞–µ—Ç **–±—ç–∫–µ–Ω–¥** –ø–æ –≤–µ–±—Ö—É–∫–∞–º (Gupshup/Stripe/CRM) –≤ Postgres (+ –∏–Ω–¥–µ–∫—Å –≤ pgvector). –í Chatflow –æ—Ç–¥–µ–ª—å–Ω—ã–π —É–∑–µ–ª –Ω–µ –Ω—É–∂–µ–Ω

### –ü–æ–ª–∏—Ç–∏–∫–∏ –∏ –∏–∑–æ–ª—è—Ü–∏—è

**–ö–ª—é—á–∏:**
- `ws:{workspaceId}:chat:{sessionId}` ‚Äî –∏—Å—Ç–æ—Ä–∏—è
- `ws:{workspaceId}:cache:{hash(prompt)}` ‚Äî –∫—ç—à LLM
- **Redis key prefix:** `org:{tenantId}:prj:{projectId}:sess:{sessionId}`
- **pgvector namespace:** —Ñ–∏–ª—å—Ç—Ä `WHERE tenant_id=? AND project_id=?` (+–∏–Ω–¥–µ–∫—Å—ã)

**TTL:** —á–∞—Ç-–∏—Å—Ç–æ—Ä–∏—è 24‚Äì72—á; –∫—ç—à LLM 10‚Äì60 –º–∏–Ω (–¥–∏–∞–ª–æ–≥–∏) / –¥–æ–ª—å—à–µ –Ω–∞ —Å—Ç–∞—Ç–∏–∫–µ

**–û—á–∏—Å—Ç–∫–∞:** –ø—Ä–∏ `optOut/stop` ‚Äî —Å—Ä–∞–∑—É —á–∏—Å—Ç–∏–º `chat:{sessionId}`

**–°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è (–æ–ø—Ü.):** –≤–æ—Ä–∫–µ—Ä —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –¥–ª–∏–Ω–Ω—ã–µ —á–∞—Ç—ã –≤ Postgres; –≤ Redis –¥–µ—Ä–∂–∏–º `summary+tail`

---

## üì° –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–Ø –ò –û–ù–ë–û–†–î–ò–ù–ì

### –í—Ö–æ–¥ WhatsApp ‚Üî Gupshup ‚Üî Backend ‚Üî Agentflow ‚Üî Chatflow

**¬´–ì–ª–∞–≤–Ω—ã–π¬ª —Ñ–ª–æ—É –∏ —Å—Ç–∞—Ä—Ç:**
- –í—Ö–æ–¥ **–≤—Å–µ–≥–¥–∞** –≤ –±—ç–∫–µ–Ω–¥ (webhook Gupshup)
- –°—Ç–∞—Ä—Ç **–≤—Å–µ–≥–¥–∞** –≤ **Agentflow**

### –†–µ–µ—Å—Ç—Ä –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ (–ë–î `routing`)

**–ü–æ–ª—è:** `tenant_id, bm_id, wa_app_id(–∏–ª–∏ wa_phone), entry_type(default|ctwa|keyword), entry_value(ad_id|adset_id|campaign_id|keyword), agentflow_id, chatflow_id_default(–æ–ø—Ü.), status`

**–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å:** `(wa_app_id, entry_type, entry_value)` ‚Äî `UNIQUE`

**–õ–æ–≥–∏–∫–∞:** –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º –≤—Ö–æ–¥—è—â–µ–≥–æ (–Ω–æ–º–µ—Ä/wa_app_id + CTWA-—Ç–µ–≥–∏) –±–µ–∫ –Ω–∞—Ö–æ–¥–∏—Ç —Å—Ç—Ä–æ–∫—É –∏ –ø–æ–ª—É—á–∞–µ—Ç `agentflow_id` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç Agentflow `/predict`

### –ö–∞–∫ –±–µ–∫ –ø–æ–Ω–∏–º–∞–µ—Ç ¬´—ç—Ç–æ WhatsApp¬ª

–ò–∑ webhook: `provider="gupshup"`, `wa_app_id/phone`, —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è (`message`, `template`, `status: delivered|read|failed`). –≠—Ç–∏ –ø–æ–ª—è –∏–¥—É—Ç –≤ `messages_meta` –∏ –≤ —Ä–æ—É—Ç–∏–Ω–≥

### –ù–µ—Å–∫–æ–ª—å–∫–æ WA-–Ω–æ–º–µ—Ä–æ–≤ –≤ –æ–¥–Ω–æ–º BM + –æ–Ω–±–æ—Ä–¥–∏–Ω–≥

- –ú–∞—Å—Ç–µ—Ä-–æ–Ω–±–æ—Ä–¥–∏–Ω–≥ (–≤ –∞–¥–º–∏–Ω–∫–µ) –∏ –Ω–æ–¥–∞ ¬´Onboarding¬ª –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –ë–î
- –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –¥–µ–ª–∞–µ—Ç: —Å–ø–∏—Å–æ–∫ WA-–∞–∫–∫–∞—É–Ω—Ç–æ–≤/–Ω–æ–º–µ—Ä–æ–≤; –≤—ã–±–æ—Ä ¬´–ø—Ä–∏–≤—è–∑–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π¬ª/¬´–∑–∞–≤–µ—Å—Ç–∏ –Ω–æ–≤—ã–π¬ª; –≤—ã–±–æ—Ä –≥–ª–∞–≤–Ω–æ–≥–æ `Agentflow` (–∏ –æ–ø—Ü. –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ `Chatflow`); –∑–∞–ø–∏—Å—å –≤ `routing`
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: `wa_app_id` **UNIQUE** –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–≤—è–∑–∫–∞—Ö (–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞)

### –ö—Ç–æ ¬´–∫–æ–º—É –∑–≤–æ–Ω–∏—Ç¬ª

- –ë–µ–∫ **–Ω–∏–∫–æ–º—É –≤–Ω—É—Ç—Ä–∏ –∫–∞–Ω–≤—ã –Ω–µ –∑–≤–æ–Ω–∏—Ç** ‚Äî —Ç–æ–ª—å–∫–æ `/predict` —É **Agentflow**
- –û—á–µ—Ä—ë–¥–Ω–æ—Å—Ç—å/step/–ø–æ—Ä–æ–≥–∏ ‚Äî **–≤ Chatflow** (Variables + Memory)
- –ë–µ–∫ –ø–µ—Ä–µ–¥–∞—ë—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç: `tenantId, orgId, workspaceId, sessionId, wa_app_id/phone, ctwa_*`
- –î–∞–ª—å—à–µ Agentflow ‚Üí Execute Flow(Chatflow); –≤–Ω—É—Ç—Ä–∏ Chatflow —Ç—É–ª–∞–º–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è WA-–æ—Ç–ø—Ä–∞–≤–∫–∏/—ç–º–∏—Å—Å–∏–∏

### ¬´–°—Ç—Ä–∞–Ω–∏—Ü–∞ Sequences¬ª –∏ ¬´–Ω–æ–¥–∞ WhatsApp¬ª

- –î–µ–ª–∞–µ–º –≤–Ω–µ—à–Ω—é—é —Å—Ç—Ä–∞–Ω–∏—Ü—É **Sequences** (–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π/–∫–Ω–æ–ø–æ–∫/–ª–∏—Å—Ç–æ–≤ —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- –í Flowise ‚Äî **–æ–¥–Ω–∞** –Ω–æ–¥–∞ **WA Send (Gupshup)** (Custom Tool), –Ω–∞ –≤—Ö–æ–¥ –ø–æ–¥–∞—ë—Ç—Å—è `sequence_id`/`message_id`
- –ù–æ–¥–∞ —Å–∞–º–∞ —Ç—è–Ω–µ—Ç –∏–∑ –ë–î –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞–∫–µ—Ç
- –ü–æ—Ä—è–¥–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø–∞–∫–µ—Ç–µ —Ä–µ—à–∞–µ—Ç –±–µ–∫ (–ø–æ `sequence_id`), –Ω–∞ –∫–∞–Ω–≤–µ –ø–æ—Ä—è–¥–æ–∫ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Ç–æ–∫

### –ì–¥–µ –∂–∏–≤—ë—Ç ¬´–Ω–æ–¥–∞ WhatsApp¬ª

- –û—Ç–ø—Ä–∞–≤–∫–∞ (text/template/buttons/list/‚Ä¶) ‚Äî **–≤ Chatflow** (—á–µ—Ä–µ–∑ Tool Agent ‚Üí WA Send)
- –ö–æ—Ä–æ—Ç–∫–∏–µ ack –Ω–∞ –∫–æ–¥-—Å–ª–æ–≤–∞ –¥–æ –≤—Ö–æ–¥–∞ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Äî –º–æ–∂–Ω–æ –∏ –∏–∑ **Agentflow** —Ç–æ–π –∂–µ –Ω–æ–¥–æ–π
- ¬´–°–ª—É—à–∞—Ç–µ–ª—å¬ª –≤—Ö–æ–¥—è—â–∏—Ö ‚Äî **—Ç–æ–ª—å–∫–æ –±–µ–∫** (webhook)

### ¬´–ù–æ–¥–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è¬ª –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è

- –°–ª—É—à–∞—Ç–µ–ª—å ‚Äî –±–µ–∫
- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Äî –≤–Ω—É—Ç—Ä–∏ **Chatflow** (Tool Agent + –ø—Ä–æ–º–ø—Ç/–ø—Ä–∞–≤–∏–ª–∞) –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–∞—è Intent/Moderation-–Ω–æ–¥–∞
- –°—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç–∞–≤–∫–∏ (delivered/read/failed) –ª–æ–≤–∏—Ç –±–µ–∫ –∏ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –Ω—É–¥–∂–∏ (—á–µ—Ä–µ–∑ —Å–≤–æ–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫)
- –í Flowise ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥–∞ `/nudge/schedule`

### –ò–¥–µ–æ–ª–æ–≥–∏—è

- Start ‚Äî —Ç–æ–ª—å–∫–æ –≤ **Agentflow** (–∫–æ–¥-—Å–ª–æ–≤–∞/–≥–ª–æ–±–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è) ‚Üí Execute Flow(Chatflow)
- –í **Chatflow** ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —à–∞–≥–æ–≤, –≤–∞–ª–∏–¥–∞—Ç–æ—Ä, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (WA Send, CAPI, Audiences, CRM, Stripe, Nudge, Operator)
- –ü–∞–º—è—Ç—å –∏ —à–∞–≥–∏ ‚Äî –≤ Chatflow (Redis-Backed Chat Memory + Variables)
- –ú—É–ª—å—Ç–∏–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ (WA/TG/IG/FBM): –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —Å—Ö–µ–º–∞, –º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–π —Ç—É–ª

### –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏/–∫–∞–Ω–∞–ª—ã

- –ú–æ–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ Chatflow
- –í Agentflow —á–µ—Ä–µ–∑ Condition/–≤–µ—Ç–≤–ª–µ–Ω–∏—è –≤—ã–±–∏—Ä–∞—Ç—å, –∫–∞–∫–æ–π Chatflow –¥–µ—Ä–Ω—É—Ç—å (–ø–æ –Ω–æ–º–µ—Ä—É/CTWA/keyword)
- –û–ø–µ—Ä–∞—Ç–æ—Ä (HITL) ‚Äî –≤ Agentflow (–≤–µ—Ç–∫–∞ operator) + –Ω–æ–¥–∞ ¬´–°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç¬ª + Human Input

### –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—å –∏ –≥–¥–µ (–º–∏–Ω–∏–º—É–º)

**–ë–î:** `routing`, `messages_raw/meta`, `funnel_answers`, `events_outbox`, `sequences`, `wa_accounts`, `projects`

**Redis:** `org:{orgId}:ws:{wsId}:session:{sessionId}` ‚Äî –∏—Å—Ç–æ—Ä–∏—è/—Å–æ—Å—Ç–æ—è–Ω–∏–µ

**Variables (Workspace):** `qual_manifest`, `policy` (–ø–æ—Ä–æ–≥–∏/—Ä–µ—Ç—Ä–∞–∏/–Ω—É–¥–∂–∏), `ids` (–ø–∏–∫—Å–µ–ª—å/–∞—É–¥–∏—Ç–æ—Ä–∏–∏/CRM-–º–∞–ø–ø–∏–Ω–≥), `texts_common`

---

## üì≤ –ù–û–î–ê ¬´WA SEND (GUPSHUP)¬ª ‚Äî ¬´–ù–ê–ß–ò–ù–ö–ê¬ª

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–æ–¥—ã (6 –≥—Ä—É–ø–ø –ø–æ–ª–µ–π)

**1. –ê–¥—Ä–µ—Å–∞—Ü–∏—è**
- `to` (E.164, +7999‚Ä¶ –∏–ª–∏ `contact_id` –∏–∑ CRM)
- `wa_app_id` (–ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–π WA-–∞–∫–∫–∞—É–Ω—Ç Gupshup)
- `project_id / tenant_id / session_id` (–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è/–ª–æ–≥–∏)
- `idempotency_key` *(–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `sessionId-msg-<hash(message_id+vars)>`)*

**2. –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å (–∫–æ–Ω—Ç–µ–Ω—Ç)**
- `mode: message | sequence`
- `message_id | sequence_id` (—Å—Å—ã–ª–∫–∏ –Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π)
- `vars {}` (–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏, –Ω–∞–ø—Ä. `{name:"–ò–≤–∞–Ω", budget:"5k"}`)

**(–û–ø—Ü.) Inline –¥–ª—è —Ä–∞–∑–æ–≤—ã—Ö —Å–ª—É—á–∞–µ–≤:**
- `type:` `text | template | interactive_buttons | interactive_list | media_image | media_video | media_audio | document | location | contact`
- `payload` –ø–æ —Ç–∏–ø—É:
  - `text: { text }`
  - `interactive_buttons: { text, buttons:[{id,title}] }`
  - `interactive_list: { header?, body, sections:[{title, rows:[{id,title,description?}]}] }`
  - `media_*: { url | file_id, caption? }`
  - `template: { template_name, language, components:[‚Ä¶], variables:{‚Ä¶} }`
  - `location: { lat, lng, name?, address? }`
  - `contact: { vcard | fields‚Ä¶ }`

**3. –†–µ–∂–∏–º –¥–æ—Å—Ç–∞–≤–∫–∏ (24 —á–∞—Å–∞)**
- `delivery_mode:` `auto | session_only | template_only`
- `fallback_template?` (–∏–º—è —à–∞–±–ª–æ–Ω–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ 24—á)
- `typing_simulation? on|off, delay_ms?`

**4. –ü–æ–ª–∏—Ç–∏–∫–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è**
- `validate: on|off` (–ª–∏–º–∏—Ç—ã WA: –¥–ª–∏–Ω—ã/–∫–Ω–æ–ø–∫–∏/—Ç–∏–ø—ã)
- `block_if_optout: on|off`
- `respect_quiet_hours: on|off, window:{start,end,tz}`
- `rate_limit_tag?` (—Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥/BSP –ª–∏–º–∏—Ç—ã)

**5. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ–±–∞–≥**
- `trace_id` *(–∞–≤—Ç–æ: `sessionId:stepKey:ts`)*
- `dry_run: on|off` ‚Äî –Ω–µ —à–ª—ë—Ç, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏ –æ—Ç–¥–∞—ë—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π payload
- `return_raw: on|off` ‚Äî –≤–µ—Ä–Ω—É—Ç—å —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç Gupshup

**6. –í—ã—Ö–æ–¥—ã –Ω–æ–¥—ã (outputs)**
- `status: queued | sent | failed`
- `outbound_id` (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π id)
- `provider_message_id` (id —É Gupshup/WA)
- `idempotency_key` (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–π)
- `error: code, message, retry_after?`
- `meta: delivery_mode_used, template_used?, media_info?`

**–ú–∏–Ω–∏-–ø—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞ (—Å—Å—ã–ª–∫–æ–π –Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫—É):**
```
to=+79991234567
wa_app_id=gs_app_01
mode=message
message_id=msg_q2@v7
vars={ "name":"–ò–≤–∞–Ω", "budget":"5k" }
delivery_mode=auto
idempotency_key=session123-msg-7b1c‚Ä¶
```

---

## üèóÔ∏è –ü–†–û–ï–ö–¢–´ –ò –†–û–£–¢–ò–ù–ì

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ + A/B (–ø–æ–∑–∂–µ)

**–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω–∏–º—É–º):**
- `projects(id, tenant_id, name, slug, status, default_agentflow_id, default_chatflow_id, qual_manifest_id, policy_id, created_at)`
- `wa_accounts(id, bm_id, wa_app_id, phone_e164, status, created_at)`
- `routing(id, tenant_id, project_id, wa_app_id, entry_type(default|ctwa|keyword), entry_value, agentflow_id, chatflow_id, status, created_at)`
  ‚Äî `UNIQUE(wa_app_id, entry_type, entry_value)` (–∏—Å–∫–ª—é—á–∞–µ—Ç –¥–≤–æ–π–Ω—É—é –ø—Ä–∏–≤—è–∑–∫—É)

### –†–æ—É—Ç–∏–Ω–≥ –≤—Ö–æ–¥—è—â–∏—Ö

1. Gupshup webhook ‚Üí –∏–∑–≤–ª–µ—á—å `wa_app_id/phone, ctwa_*, message/text`
2. –ù–∞–π—Ç–∏ –≤ `routing` –ø–æ `(wa_app_id, entry_type, entry_value)` (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: `ctwa:ad|adset|campaign` ‚Üí `keyword` ‚Üí `default`)
3. –ü–æ–ª—É—á–∏—Ç—å `project_id, agentflow_id, chatflow_id`; –≤—ã–∑–≤–∞—Ç—å Agentflow `/predict` (`question`, Vars: `projectId, tenantId, wa_app_id, sessionId, ctwa_*`)
4. Agentflow ‚Üí Execute Flow(Chatflow)

### –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –Ω–æ–º–µ—Ä–æ–≤

UI: –≤—ã–±—Ä–∞—Ç—å –ü—Ä–æ–µ–∫—Ç ‚Üí WA –Ω–æ–º–µ—Ä (`wa_accounts`) ‚Üí —Å–æ–∑–¥–∞—Ç—å `routing(default, '*')`. –ï—Å–ª–∏ `wa_app_id` —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫–∞–∫ `default` –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ ‚Äî –∑–∞–ø—Ä–µ—Ç–∏—Ç—å

### –°–æ–±—ã—Ç–∏—è/—ç–º–∏—Å—Å–∏–∏: —É–∫–∞–∑—ã–≤–∞—Ç—å `project_id`

CAPI/custom_data, Audiences payload, CRM note/fields, DB (`funnel_answers`, `events_outbox`) ‚Äî –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è—Ç—å `project_id`

### A/B (–ø–æ–∑–∂–µ, –±–µ–∑ –ª–æ–º–∫–∏)

- `routing_variants{project_id, variant_code, weight, agentflow_id, chatflow_id}`
- Sticky-–±–∞–∫–µ—Ç: —Ö–µ—à —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚Üí `variant_code`
- –í—ã–∑–æ–≤ —Ä–∞–∑–Ω—ã—Ö Chatflow **–∏–ª–∏** –æ–¥–Ω–æ–≥–æ Chatflow —Å —Ä–∞–∑–Ω—ã–º–∏ `qual_manifest_id/policy_id`

### Flowise: –ø–∞–ø–∫–∏/—Ç–µ–≥–∏/–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–Ω–µ–π–º–∏–Ω–≥) + –∏–∑–æ–ª—è—Ü–∏—è

**–¢–µ–≥–∏/–Ω–µ–π–º–∏–Ω–≥:**
- **Agentflow:** `[PRJ:slug] Agent START`
- **Chatflow:** `[PRJ:slug] Chat QUALIFIER`

**Workspace/Prediction Variables:** `projectId, tenantId, wa_app_id, sessionId, ctwa, qual_manifest_id, policy_id`

---

## üîó –ò–ù–¢–ï–ì–†–ê–¶–ò–ò (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)

### CAPI - Facebook Conversions API

**–°–æ–±—ã—Ç–∏—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
```json
{
  "data": [
    {
      "event_name": "QUALIFY_Q2",
      "event_time": 1736123456,
      "event_id": "sess-123-q2-9a1c...",
      "event_source_url": "https://wa.me/79991234567",
      "action_source": "chat",
      "user_data": {
        "external_id": "<sha256(tenantId:subscriberId)>",
        "ph": "<sha256(msisdn)>"
      },
      "custom_data": {
        "step": "q2",
        "answer_raw": "–æ–∫–æ–ª–æ 2500$",
        "answer_parsed": {"budget_month":2500,"bucket":"1‚Äì5k"},
        "quality_score": 0.86,
        "validity": "valid",
        "session_id": "sess-123",
        "tenant_id": "tenant-1",
        "project_id": "project-1",
        "mapping_version": "1.0.0"
      }
    }
  ]
}
```

### Custom Audiences - –†–µ–∫–ª–∞–º–Ω—ã–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏

**–ë–∞–∑–æ–≤—ã–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏:**
- `A1_STARTED_NOT_FINISHED` - –ù–∞—á–∞–ª–∏ –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤–æ—Ä–æ–Ω–∫—É
- `A2_QUALIFIED` - –ü—Ä–æ—à–ª–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é  
- `A3_REJECTED` - –û—Ç–∫–∞–∑–Ω–∏–∫–∏ –∏ —à—É–º

**–°–µ–≥–º–µ–Ω—Ç–Ω—ã–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏:**
- `CA_QUAL_Q1`, `CA_QUAL_Q2` - –ü–æ —à–∞–≥–∞–º –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `CA_BUDGET_10K_50K`, `CA_BUDGET_50K_PLUS` - –ü–æ –±—é–¥–∂–µ—Ç—É
- `CA_CHANNEL_INSTAGRAM` - –ü–æ –∫–∞–Ω–∞–ª—É
- `CA_PURCHASED` - –°–æ–≤–µ—Ä—à–∏–ª–∏ –ø–æ–∫—É–ø–∫—É
- `CA_EXCLUDE_NOISE` - –ò—Å–∫–ª—é—á–µ–Ω–∏—è —à—É–º–∞

### CRM - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏

**–ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π (Kommo):**
```json
{
  "contact": {
    "name": "{{profileName || waPhone}}",
    "phone": "{{waPhone}}",
    "custom_fields": {
      "641289": "{{ctwa.campaign_id}}",
      "641290": "{{ctwa.adset_id}}",
      "641291": "{{ctwa.ad_id}}",
      "641292": "{{answers.Q1.niche}}",
      "641293": "{{answers.Q2.budget}}",
      "641294": "{{answers.Q3.channel}}"
    }
  }
}
```

**–¢—Ä–∏–≥–≥–µ—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**
| –°–æ–±—ã—Ç–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ –≤ CRM |
|---------|---------------|
| CTWA —Å—Ç–∞—Ä—Ç | –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –∏ —Å–¥–µ–ª–∫—É |
| –í–∞–ª–∏–¥–Ω—ã–π Qn | –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—è + –∫–æ–º–º–µ–Ω—Ç |
| –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞ | –°–º–µ–Ω–∏—Ç—å —Å—Ç–∞–¥–∏—é |
| –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞ | –°–º–µ–Ω–∏—Ç—å –Ω–∞ "–û–ø–ª–∞—á–µ–Ω–æ" |

### Stripe - –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

**–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å—Å—ã–ª–∫–∏:**
```javascript
const paymentLink = await stripe.paymentLinks.create({
  line_items: [{
    price: 'price_ABC123',
    quantity: 1
  }],
  metadata: {
    session_id: 'session_123',
    subscriber_id: 'sub_789',
    product_id: 'SKU_001',
    source: 'whatsapp_funnel'
  }
})
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook —Å–æ–±—ã—Ç–∏–π:**
- `checkout.session.completed` ‚Üí Purchase —Å–æ–±—ã—Ç–∏–µ –≤ CAPI
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–π ‚Üí –ø–µ—Ä–µ–Ω–æ—Å –≤ CA_PURCHASED
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CRM ‚Üí —Å–º–µ–Ω–∞ —Å—Ç–∞–¥–∏–∏ –Ω–∞ "–û–ø–ª–∞—á–µ–Ω–æ"
- WhatsApp –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí template —Å —á–µ–∫–æ–º

---

## üìê –°–¢–†–£–ö–¢–£–†–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

**`subscribers`**
```sql
CREATE TABLE subscribers (
  id UUID PRIMARY KEY,
  tenant_id VARCHAR NOT NULL,
  wa_phone VARCHAR UNIQUE NOT NULL,
  phone_hash VARCHAR NOT NULL,
  profile_name VARCHAR,
  first_seen_at TIMESTAMP,
  last_inbound_at TIMESTAMP,
  status VARCHAR DEFAULT 'active',
  optout BOOLEAN DEFAULT false,
  snoozed_until TIMESTAMP,
  conversation_id VARCHAR,
  conversation_expires_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**`funnel_answers`**
```sql
CREATE TABLE funnel_answers (
  id UUID PRIMARY KEY,
  tenant_id BIGINT NOT NULL,
  subscriber_id BIGINT NOT NULL,
  session_id TEXT NOT NULL,
  step_key TEXT NOT NULL,
  validity TEXT NOT NULL CHECK (validity IN ('valid','noise','ambiguous')),
  quality_score NUMERIC(3,2) NOT NULL,
  answer_raw TEXT NOT NULL,
  answer_parsed JSONB NOT NULL DEFAULT '{}'::jsonb,
  version INT NOT NULL DEFAULT 1,
  event_id TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ,
  PRIMARY KEY (tenant_id, subscriber_id, session_id, step_key)
);
```

**`events_outbox`**
```sql
CREATE TABLE events_outbox (
  id BIGSERIAL PRIMARY KEY,
  event_id TEXT NOT NULL UNIQUE,
  channel TEXT NOT NULL CHECK (channel IN ('CAPI','AUDIENCE','CRM')),
  payload JSONB NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','sent','failed','on_hold')),
  retries INT NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_error TEXT
);
```

**`messages_raw`**
```sql
CREATE TABLE messages_raw (
  id UUID PRIMARY KEY,
  message_id VARCHAR UNIQUE NOT NULL,
  session_id VARCHAR,
  direction VARCHAR NOT NULL, -- inbound/outbound
  type VARCHAR NOT NULL, -- text/image/button/list/template
  payload JSONB NOT NULL,
  status VARCHAR, -- sent/delivered/read/failed
  parent_id UUID, -- —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ
  parent_type VARCHAR, -- step/message/none
  created_at TIMESTAMP DEFAULT NOW(),
  delivered_at TIMESTAMP,
  read_at TIMESTAMP,
  replied_at TIMESTAMP
);
```

**–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:** `funnel_answers` + –ø–∞—á–∫–∞ `events_outbox` ‚Üí –∫–æ–º–º–∏—Ç. Worker: –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏, backoff `1‚Üí2‚Üí5‚Üí15` –º–∏–Ω

---

## üìä –ú–ï–¢–†–ò–ö–ò –ò –ê–õ–ï–†–¢–´

–ü–æ —à–∞–≥–∞–º: –¥–æ–ª—è `valid/noise/ambiguous`, —Å—Ä. `quality_score`, % –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

–ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã: latency/–æ—à–∏–±–∫–∏/–ø–æ–≤—Ç–æ—Ä—ã

–ö–∞—á–µ—Å—Ç–≤–æ —Ç—Ä–∞—Ñ–∏–∫–∞: –¥–æ–ª—è `CA_EXCLUDE_NOISE`

HITL: SLA, –≤—Ä–µ–º—è –≤–æ–∑–≤—Ä–∞—Ç–∞

–ù—É–¥–∂–∏: CTR/–æ—Ç–≤–µ—Ç—ã/—ç—Å–∫–∞–ª–∞—Ü–∏–∏

–†–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏—è: % `NOISE‚ÜíGOOD`

---

## üî¢ –ü–û–†–û–ì–û–í–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø

- Free-text ‚â•0.7
- Choice ‚â•0.8
- KB-–æ—Ç–≤–µ—Ç ‚â•0.7
- –ê–Ω—Ç–∏-—á—É—à—å —Ä–µ—Ç—Ä–∞–∏ `1‚Üí2‚Üí3(–æ–ø–µ—Ä–∞—Ç–æ—Ä)`
- –ù—É–¥–∂–∏ `read:2‚Üí20–º(2)`, `delivered:15–º‚Üí24—á(2)`

---

## üîê –ù–ê–î–Å–ñ–ù–û–°–¢–¨ –ò –ü–†–ò–í–ê–¢–ù–û–°–¢–¨

- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (`event_id` + —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ outbox)
- Backoff-—Ä–µ—Ç—Ä–∞–∏
- Hash-PII (sha256) –¥–ª—è `external_id/ph`
- –ê—É–¥–∏—Ç —Ä–µ—à–µ–Ω–∏–π (valid/noise/ambiguous, –Ω—É–¥–∂–∏, –∫–æ–¥-—Å–ª–æ–≤–∞, —ç—Å–∫–∞–ª–∞—Ü–∏–∏)

---

## üîÑ –ú–ò–ù–ò-FSM (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)

```
Qn.wait ‚Üí (–∫–æ–¥-—Å–ª–æ–≤–æ) ‚Üí hold/optOut/snooze
Qn.wait ‚Üí (valid) ‚Üí emit(Qn) ‚Üí Q{n+1}.wait|CONTENT
Qn.wait ‚Üí (ambiguous/noise) ‚Üí retry/assist ‚Üí Qn.wait|operator
any ‚Üí (question) ‚Üí route(¬ß10) ‚Üí return(Qn.wait)
CONTENT ‚Üí END
```

---

## üéÆ AGENTFLOW –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### WhatsApp Send Node - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –Ω–æ–¥–∞

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–æ–¥—ã:**
```javascript
{
  name: "WhatsAppSend_Agentflow",
  type: "WhatsAppSend",
  category: "Agent Flows",
  version: "1.0.0",
  description: "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ WhatsApp",
  inputs: [
    {
      label: "Message Type",
      name: "messageType",
      type: "options",
      options: [
        { value: "text", label: "Text" },
        { value: "image", label: "Image" },
        { value: "button", label: "Interactive Buttons" },
        { value: "list", label: "Interactive List" },
        { value: "template", label: "Template" }
      ],
      default: "text"
    },
    {
      label: "To",
      name: "to",
      type: "string",
      placeholder: "+79991234567",
      acceptVariable: true
    },
    {
      label: "Session ID", 
      name: "sessionId",
      type: "string",
      acceptVariable: true
    },
    {
      label: "Idempotency Key",
      name: "idempotencyKey",
      type: "string",
      acceptVariable: true,
      optional: true
    }
  ]
}
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ session/template:**
- –í –ø—Ä–µ–¥–µ–ª–∞—Ö 24h –æ–∫–Ω–∞ ‚Üí session message
- –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è 24h ‚Üí template message
- –ü—Ä–∏ failed –¥–æ—Å—Ç–∞–≤–∫–µ session ‚Üí retry –∫–∞–∫ template

---

## üèÅ –ö–†–ê–ï–í–´–ï –°–õ–£–ß–ê–ò

- –î–ª–∏–Ω–Ω—ã–µ –ø–æ–ª–æ—Ç–Ω–∞ ‚Üí —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è/–¥–æ–ø—Ä–æ—Å
- –ì–æ–ª–æ—Å/—Ñ–æ—Ç–æ ‚Üí ASR/OCR‚Üí—Ç–µ –∂–µ –ø—Ä–∞–≤–∏–ª–∞
- –î—É–±–ª–∏–∫–∞—Ç—ã ‚Üí –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å `lastOutboundId/event_id`
- `hold=true` ‚Äî –≤–∞–ª–∏–¥–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã **–Ω–µ —Ç–µ—Ä—è–µ–º** –∏ **—ç–º–∏—Ç–∏–º**
- `optOut` ‚Äî –≤—Ö–æ–¥—è—â–∏–µ **—Ç–æ–ª—å–∫–æ –ë–î**, –Ω–∞—Ä—É–∂—É **–Ω–µ** —à–ª—ë–º

---

## ‚öôÔ∏è –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –í–ù–ï–î–†–ï–ù–ò–Æ

- –ö–∞—Ä—Ç–∞ `willCoverLater`
- –°–ª–æ–≤–∞—Ä–∏/–Ω–µ–≥–∞—Ü–∏–∏
- –ü–æ—Ä–æ–≥–∏/–æ–∫–Ω–∞/–ª–∏–º–∏—Ç—ã
- –ë–î/–≤–æ—Ä–∫–µ—Ä—ã/outbox
- –ê—É–¥–∏—Ç–æ—Ä–∏–∏ `CA_QUAL_*` / `CA_EXCLUDE_NOISE`
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥/–∞–ª–µ—Ä—Ç—ã
- –¢–µ—Å—Ç—ã: –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å/—Ä–µ—Ç—Ä–∞–∏/noise/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/–∫–æ–¥-—Å–ª–æ–≤–∞/–Ω—É–¥–∂–∏

---

## üö´ –¢–ò–ü–û–í–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø

### –ü–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ Flowise
**–°–∏–º–ø—Ç–æ–º:** Variables (stepKey, answers, retries) —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –≤ null/undefined
**–ü—Ä–∏—á–∏–Ω–∞:** Flowise –Ω–µ –ø–µ—Ä—Å–∏—Å—Ç–∏—Ç Variables –º–µ–∂–¥—É —Ä–µ—Å—Ç–∞—Ä—Ç–∞–º–∏
**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ –ë–î —á–µ—Ä–µ–∑ Custom Function –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ –ë–î –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏
- Fallback: –Ω–∞—á–∞–ª–æ —Å Q1 –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π CAPI
**–°–∏–º–ø—Ç–æ–º:** –û–¥–Ω–æ —Å–æ–±—ã—Ç–∏–µ QUALIFY_Q{n} –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
**–ü—Ä–∏—á–∏–Ω–∞:** Retry –ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏  
**–†–µ—à–µ–Ω–∏–µ:**
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π event_id = `{sessionId}-q{n}-{hash(answer_raw)}`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ outbox –ø–µ—Ä–µ–¥ —ç–º–∏—Å—Å–∏–µ–π: `SELECT 1 FROM events_outbox WHERE event_id = ?`
- Constraint UNIQUE(event_id) –≤ –ë–î

### –ò—Å—Ç–µ—á–µ–Ω–∏–µ 24h –æ–∫–Ω–∞ WhatsApp
**–°–∏–º–ø—Ç–æ–º:** –û—à–∏–±–∫–∞ 403/400 –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ session message —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
**–ü—Ä–∏—á–∏–Ω–∞:** WhatsApp Policy - session messages —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 24h –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥—è—â–µ–≥–æ
**–†–µ—à–µ–Ω–∏–µ:**
- –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ template message –≤ WA Send node
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `conversation_expires_at` –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- Fallback templates –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

### –ù–∏–∑–∫–∏–π confidence score –≤ LLM
**–°–∏–º–ø—Ç–æ–º:** –ú–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ambiguous (0.3 ‚â§ confidence < 0.65)
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
**–†–µ—à–µ–Ω–∏–µ:**
- –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –≤–∞–ª–∏–¥–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
- Clarification prompts: "–£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞..."
- –°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ confidence –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —à–∞–≥–æ–≤

### –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è CRM
**–°–∏–º–ø—Ç–æ–º:** –ü–æ–ª—è –≤ CRM –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
**–ü—Ä–∏—á–∏–Ω–∞:** Webhook –ø—Ä–æ–ø—É—â–µ–Ω, timeout, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π mapping
**–†–µ—à–µ–Ω–∏–µ:**
- Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è CRM webhooks —Å exponential backoff
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö CRM –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- Fallback –Ω–∞ –ø—Ä—è–º—ã–µ API –≤—ã–∑–æ–≤—ã –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ webhook

### –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º —Ç—Ä–∞—Ñ–∏–∫–µ
**–°–∏–º–ø—Ç–æ–º:** –ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, —Ç–∞–π–º–∞—É—Ç—ã LLM
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤, –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
**–†–µ—à–µ–Ω–∏–µ:**
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ Flowise —á–µ—Ä–µ–∑ Docker replicas
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Queue (Bull/Agenda)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ LLM –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- Circuit breaker –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API (OpenAI, Gupshup)

### –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ CTWA –¥–∞–Ω–Ω—ã—Ö
**–°–∏–º–ø—Ç–æ–º:** campaign_id/ad_id –ø—Ä–∏—Ö–æ–¥—è—Ç –ø—É—Å—Ç—ã–º–∏ –∏–ª–∏ —Å –º—É—Å–æ—Ä–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
**–ü—Ä–∏—á–∏–Ω–∞:** –†–∞–∑–ª–∏—á–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–∞—Ö webhook –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
**–†–µ—à–µ–Ω–∏–µ:**
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤ parser —Å–ª–æ–µ: —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —Ä–µ–≥–µ–∫—Å–∞–º
- Fallback –Ω–∞ utm_* –∏–∑ referral.source_url –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä—è–º—ã—Ö –ø–æ–ª–µ–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ raw webhook –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–æ–≤—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è CTWA

---

## üö¶ –ë–ò–ó–ù–ï–°-–ü–†–ê–í–ò–õ–ê –ò –ò–ù–í–ê–†–ò–ê–ù–¢–´

### –ñ–µ—Å—Ç–∫–∏–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã

**–ü—Ä–∞–≤–∏–ª–æ 1: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —ç–º–∏—Å—Å–∏—è**
```
–ï–°–õ–ò –æ—Ç–≤–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π (confidence ‚â• 0.65)
–¢–û –°–†–ê–ó–£ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ CAPI + Audiences + CRM + –ë–î
–ë–ï–ó –û–ñ–ò–î–ê–ù–ò–Ø –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ—Ä–æ–Ω–∫–∏
```

**–ü—Ä–∞–≤–∏–ª–æ 2: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤**
```
GOOD –ø–æ—Ç–æ–∫ ‚Üí –æ—Å–Ω–æ–≤–Ω–æ–π pixel/dataset
NOISE –ø–æ—Ç–æ–∫ ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–π pixel/dataset –∏–ª–∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø–∏–∫—Å–µ–ª—å/–¥–∞—Ç–∞—Å–µ—Ç NEG
–ù–ò–ö–û–ì–î–ê –Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å –ø–æ—Ç–æ–∫–∏
```

**–ü—Ä–∞–≤–∏–ª–æ 3: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–æ–¥-—Å–ª–æ–≤**
```
–ö–æ–¥-—Å–ª–æ–≤–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –î–û –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –ª–æ–≥–∏–∫–∏
stop/pause/operator (—Å–∏–Ω–æ–Ω–∏–º—ã) –∏–º–µ—é—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
```

**–ü—Ä–∞–≤–∏–ª–æ 4: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**
```
–ö–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π event_id
–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

**–ü—Ä–∞–≤–∏–ª–æ 5: CRM —Å—Ç–∞–¥–∏–∏**
```
–ù–ï –¥–≤–∏–≥–∞–µ–º —Å—Ç–∞–¥–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
–ö–†–û–ú–ï —è–≤–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª (–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞)
```

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏**: 0.65 (–µ–¥–∏–Ω—ã–π –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –æ—Ç–≤–µ—Ç–æ–≤ –∞–≥–µ–Ω—Ç–∞)
2. **–†–µ–ø—Ä–æ–º–ø—Ç—ã**: –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —Å—Ä–∞–∑—É –≤ –¥–∏–∞–ª–æ–≥–µ (—Å—á–µ—Ç—á–∏–∫ per step)
3. **–ù—É–¥–∂–∏**: –¥–æ 2 –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π —Å –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–º —Ç–∞–π–º–∏–Ω–≥–æ–º (—Å—á–µ—Ç—á–∏–∫ per case)
4. **–°—Ç–∞–¥–∏–∏ CRM**: –¥–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ —è–≤–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º (–Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
5. **–≠–º–∏—Å—Å–∏–∏**: –≤—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥ —Å outbox-–ø–∞—Ç—Ç–µ—Ä–Ω–æ–º
6. **–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö**: GOOD –∏ NOISE —Å—Ç—Ä–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã (—Ä–∞–∑–Ω—ã–µ pixels)
7. **24h –æ–∫–Ω–æ**: –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ template messages –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏
8. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π event_id –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
9. **Persist-all**: —Å–æ—Ö—Ä–∞–Ω—è–µ–º **–≤—Å–µ** –æ—Ç–≤–µ—Ç—ã/—à—É–º—ã –≤ –ë–î –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

---

## üîÑ –ü–†–û–¶–ï–°–°–´ –ò –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø

### Qualification Pipeline

```mermaid
graph TD
    A[CTWA Click] --> B[Create Session]
    B --> C[Send Q1]
    C --> D{Validate Answer}
    D -->|Valid| E[Emit CAPI/CRM/CA]
    D -->|Noise| F[Retry/Escalate]
    D -->|Ambiguous| G[Clarify]
    E --> H[<!-- filepath: /home/projects/new-flowise/docs/my-docs/about-arriwa-project/arriwa-technical-v1-updated.md -->
# üöÄ Arriwa - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

> **üìé –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:**
> - [Webhook Payload Specification](../incoming-webhooks/webhook-payload-specification.md) - RAW —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥—è—â–∏—Ö webhook
> - [Subscriber Data Structure](../subscriber/exact-subscriber-data-structure-v2.md) - –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ –≤ –ë–î
> - [WhatsApp Message Types](../wa-types-message.md) - –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
> - [Project Description](../project-description/description.md) - –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–π –æ–±–∑–æ—Ä –û–ë–©–ò–ô –ü–£–¢–¨

---

## ‚úÖ –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò –ö–û–ú–ü–û–ù–ï–ù–¢–´ –°–ò–°–¢–ï–ú–´

### üì± –¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞

**`CTWA`** (Click to WhatsApp Ads)  
–†–µ–∫–ª–∞–º–∞ Facebook/Instagram —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º –≤ WhatsApp

**`Direct Message`**  
–ü—Ä—è–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞

**`QR Code`**  
–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞ —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º –≤ —á–∞—Ç

**`Link Share`**  
–ü–µ—Ä–µ—Ö–æ–¥ –ø–æ wa.me —Å—Å—ã–ª–∫–µ

### üéØ –≠—Ç–∞–ø—ã –≤–æ—Ä–æ–Ω–∫–∏

**`Qualification Steps`** (Q1...Qn)  
–ü–æ—à–∞–≥–æ–≤–∞—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –ª–∏–¥–∞

**`Content Funnel`**  
–û–±—É—á–∞—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å–ª–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏

**`Product Showcase`**  
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥

**`Payment Flow`**  
–ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Stripe

### ü§ñ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤

**`valid`**  
–í–∞–ª–∏–¥–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –≤–æ—Ä–æ–Ω–∫–∏ (confidence ‚â• 0.65)

**`noise`**  
–®—É–º/–±—Ä–µ–¥/–Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç (confidence < 0.3)

**`ambiguous`**  
–ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π –æ—Ç–≤–µ—Ç —Ç—Ä–µ–±—É—é—â–∏–π —É—Ç–æ—á–Ω–µ–Ω–∏—è (0.3 ‚â§ confidence < 0.65)

### üîÑ –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

**`GOOD`**  
–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –≤–∞–ª–∏–¥–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

**`NOISE`**  
–ü–æ—Ç–æ–∫ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö/–º—É—Å–æ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤

**`ESCALATION`**  
–≠—Å–∫–∞–ª–∞—Ü–∏—è –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

### üõë –ö–æ–¥-—Å–ª–æ–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**`stop`** / **`—Å—Ç–æ–ø`** / **`unsubscribe`**  
–ü–æ–ª–Ω–∞—è –æ—Ç–ø–∏—Å–∫–∞ –æ—Ç —Ä–∞—Å—Å—ã–ª–æ–∫

**`pause`** / **`–ø–∞—É–∑–∞`**  
–í—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞

**`start`** / **`—Å—Ç–∞—Ä—Ç`**  
–í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–∞—É–∑—ã

**`operator`** / **`–æ–ø–µ—Ä–∞—Ç–æ—Ä`**  
–ó–∞–ø—Ä–æ—Å –∂–∏–≤–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

### üìä –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

**`CAPI`** (Facebook Conversions API)  
–°–æ–±—ã—Ç–∏—è –∫–æ–Ω–≤–µ—Ä—Å–∏–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**`Pixels`**  
–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π (GOOD –∏ NOISE –ø–æ—Ç–æ–∫–∏ –Ω–∞ —Ä–∞–∑–Ω—ã–µ pixels/datasets)

**`Ads Manager`**  
–¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π

**`Custom Audience`**  
–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, LAL

**`E-commerce –∏ WhatsApp catalog`**  
–¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞–ø—Ä—è–º—É—é –≤ —á–∞—Ç WhatsApp

**`Ads Audience Transporter`**  
–¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–π –≤ Google, TikTok, LinkedIn

**`Enrichment`**  
–¥–ª—è –¥–≤—É—Ö—Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ –æ–±–æ–≥–∞—â–µ–Ω–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–∞–Ω–Ω—ã–º–∏

**`Kommo CRM`**  
–¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞–º–∏ —Å–¥–µ–ª–æ–∫

**`Stripe`**  
–¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç

**`Vuexy`**  
frontend –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –º–æ–¥—É–ª—è–º–∏, –æ—Ç—á–µ—Ç–∞–º–∏ –∏ –ø—Ä

---

## üè¢ –û–Ω–±–æ—Ä–¥–∏–Ω–≥ (–∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞)

–®–∞–≥–∏ (—Å—Ç—Ä–æ–≥–æ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é):
1. https://flows.rakhnianskii.com ‚Äî –ø–µ—Ä–≤–∏—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Facebook (public_profile, business_management, email)
2. /wa-onboarding ‚Äî —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –¥–æ—Å—Ç—É–ø–µ–Ω
3. –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ (—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –ø–æ–ª—É—á–µ–Ω–∏–µ/–ø—Ä–∏–≤—è–∑–∫–∞ –Ω–æ–º–µ—Ä–∞)
4. /credentials ‚Äî —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ CAPI, Pixels, –∞—É–¥–∏—Ç–æ—Ä–∏–∏, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (ads_read, ads_management)
5. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è e-commerce –∫–∞—Ç–∞–ª–æ–≥–∞ (commerce_account_read_orders, commerce_account_read_reports, commerce_account_read_settings, catalog_management)
6. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /chatflows

---

## üîß FLOWISE –û–†–ö–ï–°–¢–†–ê–¶–ò–Ø –ò –ò–°–¢–û–ß–ù–ò–ö–ò –ò–°–¢–ò–ù–´

### Agentflow ‚Üí Chatflow –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:**
- **Agentflow** - —É–ø—Ä–∞–≤–ª—è—é—â–∏–π —Å–ª–æ–π, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π, –∞–≥–µ–Ω—Ç/–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä (–∫–æ–¥-—Å–ª–æ–≤–∞, —Å—Ç–∞—Ä—Ç/—ç—Å–∫–∞–ª–∞—Ü–∏–∏, –≤—ã–∑–æ–≤ —á–∞—Ç-—Å—Ü–µ–Ω–∞—Ä–∏—è)
- **Chatflow** - –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–ª–æ–π, LLM –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è, –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —à–∞–≥–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–≤–∞–ª–∏–¥–∞—Ç–æ—Ä/–ø–∞—Ä—Å–∏–Ω–≥/–≤–µ—Ç–≤–ª–µ–Ω–∏—è/—ç–º–∏—Å—Å–∏–∏)

**–§–æ—Ä–º–∞—Ç sessionId (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π):**
```
{source}_{details}_{subscriber_id}_{timestamp}
```

–ü—Ä–∏–º–µ—Ä—ã:
- **CTWA**: `ctwa_fb_{subscriber_id}_{timestamp}`
- **QR**: `qr_{product_id}_{subscriber_id}_{timestamp}`  
- **Direct**: `direct_{subscriber_id}_{timestamp}`
- **Link**: `link_{utm_source}_{subscriber_id}_{timestamp}`
- **WhatsApp –ø—Ä–∞–∫—Ç–∏–∫–∞**: `<tenant>:<phone>:<flow>` ‚Äî —á—Ç–æ–±—ã –Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã/–≤–æ—Ä–æ–Ω–∫–∏

### –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–≤: ¬´—Å–µ—Å—Å–∏—è¬ª (sessionId)

- **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:** —è—Ä–ª—ã–∫, –ø–æ–¥ –∫–æ—Ç–æ—Ä—ã–º Flowise/Arriwa —Ö—Ä–∞–Ω–∏—Ç –∏ —á–∏—Ç–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é *–¥–∞–Ω–Ω–æ–≥–æ* —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —à–∞–≥–∞
- **–ö—Ç–æ –∑–∞–¥–∞—ë—Ç:** sessionId –∑–∞–¥–∞—ë–º **–º—ã**; –≤—Å–µ Memory-–Ω–æ–¥—ã –∏ –∫–∞—Å—Ç–æ–º-—Ç—É–ª—ã —á–∏—Ç–∞—é—Ç/–ø–∏—à—É—Ç –ø–æ –Ω–µ–º—É
- **–ì–¥–µ –∂–∏–≤—ë—Ç:** –≤ Arriwa ‚Äî `Redis` (–∂–∏–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ–∫–Ω–∞/–∫–æ–Ω—Ç–µ–∫—Å—Ç), `PostgreSQL` (–∞—Ä—Ö–∏–≤/—Å–æ—Å—Ç–æ—è–Ω–∏–µ —à–∞–≥–æ–≤), –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å —á–µ—Ä–µ–∑ `pgvector`. –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è Buffer-–ø–∞–º—è—Ç—å Flowise –ø–∏—à–µ—Ç –≤ `chat_message`, –Ω–æ **–Ω–µ** —Å—á–∏—Ç–∞–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã
- **–ü–µ—Ä–µ–¥–∞—á–∞ –≤ —Ä–∞–Ω—Ç–∞–π–º–µ:** Prediction API ‚Üí `overrideConfig.sessionId`; –≤ —É–∑–ª–∞—Ö/—Ç—É–ª–∞—Ö –¥–æ—Å—Ç—É–ø–Ω–æ –∫–∞–∫ `$flow.sessionId`
- **–û—Ç–ª–∏—á–∏–µ –æ—Ç chatId:** chatId ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –±–µ—Å–µ–¥—ã Flowise; sessionId ‚Äî –Ω–∞—à –≤–Ω–µ—à–Ω–∏–π/–ª–æ–≥–∏—á–µ—Å–∫–∏–π ID. –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Å–∫–ª–µ–π–∫–∏ ‚Äî `sessionId`

### –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã (–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ)

- **–ü–æ—Ä–æ–≥ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏:** `0.65` (–µ–¥–∏–Ω—ã–π –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –∏ –ª–æ–≥–∏–∫–∏ –∞–≥–µ–Ω—Ç–∞)
- **–•—Ä–∞–Ω–∏–ª–∏—â–∞:** `Redis` (–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å/–∫–æ–Ω—Ç–µ–∫—Å—Ç + –∫—ç—à), `PostgreSQL` (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã), `pgvector` (—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å/RAG)

### –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥-—Å–ª–æ–≤

**–£—Ä–æ–≤–µ–Ω—å 1: –ë—ç–∫–µ–Ω–¥ (primary source of truth)**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –ö–ê–ñ–î–û–ú –≤—Ö–æ–¥—è—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–æ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –ª–æ–≥–∏–∫–∏
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤ lowercase, –ø–æ–∏—Å–∫ —Å–∏–Ω–æ–Ω–∏–º–æ–≤
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π (optOut, snooze, escalation)

**–£—Ä–æ–≤–µ–Ω—å 2: Flowise Agentflow (—Å—Ç—Ä–∞—Ö–æ–≤–æ—á–Ω–∞—è —Å–µ—Ç–∫–∞)**
- –î—É–±–ª–∏—Ä—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è edge cases
- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ –∏–ª–∏ —Å–±–æ–µ webhook
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±—ç–∫–µ–Ω–¥–æ–º —á–µ—Ä–µ–∑ API

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏—Å—Ç–∏–Ω—ã –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å

**–ö–æ–¥-—Å–ª–æ–≤–∞**: –±—ç–∫–µ–Ω–¥ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
- Flowise: —Å—Ç—Ä–∞—Ö–æ–≤–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è edge cases (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫, —Å–±–æ–π webhook)

**–°–æ—Å—Ç–æ—è–Ω–∏–µ —à–∞–≥–∞**: Flowise Variables + –ë–î (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)
- Variables: –∂–∏–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏
- –ë–î: –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞

**–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞**: Redis/Valkey (–∂–∏–≤–∞—è) + Postgres (–∞—Ä—Ö–∏–≤)

**–°—á–µ—Ç—á–∏–∫–∏ —Ä–µ–ø—Ä–æ–º–ø—Ç–æ–≤**: Flowise Variables (–≤ —Ä–∞–º–∫–∞—Ö —à–∞–≥–∞)

**–°—á–µ—Ç—á–∏–∫–∏ –Ω—É–¥–∂–µ–π**: –±—ç–∫–µ–Ω–¥ nudge-service (–º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏)

**CTWA –¥–∞–Ω–Ω—ã–µ**: –ë–î (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è)

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ event_id

```javascript
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ event_id
event_id = `{sessionId}-q{n}-{hash(answer_raw)}`
// normalize: trim/lower/collapse spaces/remove urls/phones/emojis

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ outbox –ø–µ—Ä–µ–¥ —ç–º–∏—Å—Å–∏–µ–π
const exists = await db.events_outbox.findUnique({
  where: { event_id }
})

if (exists) {
  return exists.result // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
}
```

---

## üìã –¢–û–ß–ö–ò –í–•–û–î–ê –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø

### CTWA-–∫–ª–∏–∫ –∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ —Ä–µ–∫–ª–∞–º—É Facebook/Instagram
2. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è WhatsApp —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º –±–∏–∑–Ω–µ—Å–∞
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ª—é–±–æ–π —Ç–µ–∫—Å—Ç –∏–ª–∏ —à–∞–±–ª–æ–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ)

**Webhook Gupshup –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ:**
- **–ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è CTWA-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**: campaign_id, adset_id, ad_id, creative_id, utm_*, placement, publisher_platform, click_id
- **–°–æ–∑–¥–∞–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π sessionId**: `ctwa_fb_{subscriber_id}_{timestamp}`
- **–°—Ç–∞—Ä—Ç–æ–≤—ã–π —Ç—Ä–∏–≥–≥–µ—Ä**: –ª—é–±–æ–µ –ø–µ—Ä–≤–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: phone, name, language, country, timezone

### QR Code –≤—Ö–æ–¥ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞)

**QR —Å–æ–¥–µ—Ä–∂–∏—Ç**: `wa.me/79991234567?text=QR_START_PROMO&product_id=SKU001&location_id=MSK`

**–ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã**: product_id, location_id, promo_code

**–°–æ–∑–¥–∞–µ—Ç—Å—è —Å–µ—Å—Å–∏—è**: `qr_{product_id}_{subscriber_id}_{timestamp}`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –ø–æ–∫–∞–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞/—É—Å–ª—É–≥–∏ –∏–∑ product_id

### –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥-—Å–ª–æ–≤

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –ö–ê–ñ–î–û–ú –≤—Ö–æ–¥—è—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–æ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –ª–æ–≥–∏–∫–∏:**

| –¢—Ä–∏–≥–≥–µ—Ä  | –í–∞—Ä–∏–∞–Ω—Ç—ã                              | –£—Å–ª–æ–≤–∏–µ        | –î–µ–π—Å—Ç–≤–∏–µ                      | –û—Ç–≤–µ—Ç                  | –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è    |
| -------- | ------------------------------------- | -------------- | ----------------------------- | ---------------------- | -------------- |
| –û–ø–µ—Ä–∞—Ç–æ—Ä | –æ–ø–µ—Ä–∞—Ç–æ—Ä/—á–µ–ª–æ–≤–µ–∫/support/agent/–ø–æ–º–æ—â—å | –±–µ–∑ ¬´–Ω–µ¬ª —Ä—è–¥–æ–º | `hold=true`, HITL             | ¬´–ü–æ–¥–∫–ª—é—á–∞—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞‚Ä¶¬ª | SLA, –Ω—É–¥–∂–∏ off |
| –°—Ç–æ–ø     | —Å—Ç–æ–ø/stop/unsubscribe/–æ—Ç–ø–∏—Å–∫–∞         | –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ     | `optOut=true`                 | ¬´–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ‚Ä¶¬ª         | –ë–ª–æ–∫ –∏—Å—Ö–æ–¥—è—â–∏—Ö |
| –ü–∞—É–∑–∞    | –ø–∞—É–∑–∞/–ø–æ–∑–∂–µ/—á–µ—Ä–µ–∑ X                   | ‚Äî              | `snoozeUntil=ts`, `hold=true` | ¬´–ü–∞—É–∑–∞ –¥–æ‚Ä¶¬ª            | –†–µ—Ç—Ä–∞–∏ off     |
| –°—Ç–∞—Ä—Ç    | —Å—Ç–∞—Ä—Ç/–ø—Ä–æ–¥–æ–ª–∂–∏–º/–ø—Ä–æ–¥–æ–ª–∂–∞–π             | –∏–∑ hold        | `hold=false`                  | ¬´–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å qN¬ª      | –¢–∞–π–º–µ—Ä—ã on     |

### –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)

**CAPI Facebook**: —Å–æ–±—ã—Ç–∏–µ Start/OptIn —Å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞
**Custom Audiences**: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∞—É–¥–∏—Ç–æ—Ä–∏—é A1_STARTED_NOT_FINISHED
**Kommo CRM**: —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ–Ω—Ç–∞–∫—Ç –∏ —Å–¥–µ–ª–∫–∞ –≤ —Å—Ç–∞–¥–∏–∏ "–ù–æ–≤—ã–π"
**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å—á–∏–∫ —Å CTWA-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏ raw referral –±–ª–æ–∫–æ–º
**–ú–µ–Ω–µ–¥–∂–µ—Ä**: –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º (round-robin/–Ω–∞–≥—Ä—É–∑–∫–∞/–≥–µ–æ)
**Flowise**: –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è Agentflow —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Å–µ—Å—Å–∏–∏

---

## üéØ N-–®–ê–ì–û–í–´–ô –ö–í–ê–õ–ò–§–ò–ö–ê–¢–û–† + ¬´–ñ–ò–í–û–ô¬ª –ê–ì–ï–ù–¢ + –î–í–ê –ü–û–¢–û–ö–ê (GOOD/NOISE)

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Ä–∞–º–∫–∏

- N —à–∞–≥–æ–≤ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–Ω–µ —Ñ–∏–∫—Å.)
- –ù–∞ **–∫–∞–∂–¥–æ–º –≤–∞–ª–∏–¥–Ω–æ–º –æ—Ç–≤–µ—Ç–µ** ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ —ç–º–∏—Å—Å–∏–∏: **CAPI / –ê—É–¥–∏—Ç–æ—Ä–∏–∏ / CRM / –ë–î**
- **–®—É–º/ambiguous** ‚Äî –Ω–µ –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–∞–Ω–∞–ª—ã; –ª–∏–±–æ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ **noise-–∫–∞–Ω–∞–ª—ã/–∞—É–¥–∏—Ç–æ—Ä–∏–∏**/**–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø–∏–∫—Å–µ–ª—å/–¥–∞—Ç–∞—Å–µ—Ç** (–¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤—Å–µ–≥–¥–∞ –∞–∫—Ç–∏–≤–µ–Ω ¬´–∂–∏–≤–æ–π¬ª –∞–≥–µ–Ω—Ç: –∞–Ω—Ç–∏-—á—É—à—å, –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã (–ë–ó), –∫–æ–¥-—Å–ª–æ–≤–∞, –Ω—É–¥–∂–∏, HITL
- **Persist-all:** —Å–æ—Ö—Ä–∞–Ω—è–µ–º **–≤—Å–µ** –æ—Ç–≤–µ—Ç—ã/—à—É–º—ã –≤ –ë–î (–¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ **lookalike-–∏—Å–∫–ª—é—á–µ–Ω–∏–π**)
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, outbox, —Ä–µ—Ç—Ä–∞–∏ ‚Äî **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**

### –°–æ—Å—Ç–æ—è–Ω–∏—è –∏ —Ñ–ª–∞–≥–∏ (–º–∏–Ω–∏–º—É–º)

`stage‚àà{Q1..Qn,CONTENT,END}`, `askedId`, `expectedType‚àà{free_text,choice}`, `answers{}`, `validity‚àà{valid,noise,ambiguous}`, `quality_score‚àà[0..1]`, `retries[qN]`, `hold`, `optOut`, `snoozeUntil`, –¥–æ—Å—Ç–∞–≤–∫–∞ (`lastOutboundId,lastStatus,lastStatusAt,nudgeCount[qN]`), `parkingLot[]`

### –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏/—Å–ª–æ–≤–∞—Ä–∏

`willCoverLater(topic)‚Üístep`, —Å–∏–Ω–æ–Ω–∏–º—ã/–Ω–µ–≥–∞—Ü–∏–∏ –∫–æ–¥-—Å–ª–æ–≤, —Å–∏–Ω–æ–Ω–∏–º—ã –æ–ø—Ü–∏–π, –∫–∞—Ç–∞–ª–æ–≥–∏ `niche/budget_bucket/channel`, –º–∞—Ä–∫–µ—Ä—ã –≤–∞–∂–Ω–æ—Å—Ç–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ (`high/low`)

### –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö

1. –ö–æ–¥-—Å–ª–æ–≤–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç): `operator`‚ÜíHITL/hold, `stop`‚ÜíoptOut, `pause`‚Üísnooze+hold, `start`‚Üíresume
2. –ï—Å–ª–∏ –Ω–µ –∫–æ–¥-—Å–ª–æ–≤–æ ‚Üí `intent‚àà{funnel_answer,question,smalltalk,noise}`
3. –î–ª—è `funnel_answer` ‚Üí –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å `validity, quality_score`
4. –î–ª—è `question` ‚Üí `relevance to_funnel/off_funnel`, `willCoverLater`, `importance`

### –ú–∞—Ç—Ä–∏—Ü–∞ —Ä–µ—à–µ–Ω–∏–π –ø–æ —à–∞–≥–∞–º

**–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:**
- Q1: "–ö–∞–∫–∞—è —É –≤–∞—Å –æ—Å–Ω–æ–≤–Ω–∞—è –±–æ–ª—å/–∑–∞–¥–∞—á–∞?" / "–ö–∞–∫–∞—è –Ω–∏—à–∞?"
- Q2: "–ö–∞–∫–æ–π —É –≤–∞—Å –º–µ—Å—è—á–Ω—ã–π –±—é–¥–∂–µ—Ç –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥?"
- Q3: "–ö–∞–∫–æ–π –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª –ø—Ä–æ–¥–∞–∂ —Å–µ–π—á–∞—Å?"
- Q4: "–ì–æ—Ç–æ–≤—ã –ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å –±—é–¥–∂–µ—Ç –ø—Ä–∏ —Ä–æ—Å—Ç–µ –ø—Ä–æ–¥–∞–∂?"
- Q5: "–ö–∞–∫–æ–π –∫–ª—é—á–µ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å (KPI) —Å—Ç–∞–Ω–µ—Ç –¥–ª—è –≤–∞—Å –º–µ—Ä–∏–ª–æ–º —É—Å–ø–µ—à–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –±–∏–∑–Ω–µ—Å–∞?"

### –ê–Ω—Ç–∏-—á—É—à—å –∏ –ø–∞—Ä—Å–∏–Ω–≥ –ø–æ —à–∞–≥–∞–º

- **Q1 (free_text: niche,pain):** pain ‚â•4 –∑–Ω–∞—á–∏–º—ã—Ö —Å–ª–æ–≤; niche ‚àà –∫–∞—Ç–∞–ª–æ–≥–µ; **–±–ª–∏–∑–æ—Å—Ç—å ‚â•0.7**
- **Q2 (free_text: budget):** –∏–∑–≤–ª–µ—á—å —á–∏—Å–ª–æ/–¥–∏–∞–ø–∞–∑–æ–Ω ‚Üí `bucket‚àà{<1k,1‚Äì5k,5‚Äì20k,20k+}`; **–±–ª–∏–∑–æ—Å—Ç—å ‚â•0.7**
- **Q3 (choice):** —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å –æ–ø—Ü–∏—è–º–∏/—Å–∏–Ω–æ–Ω–∏–º–∞–º–∏ **‚â•0.8**
- **Q4 (choice):** –¥–∞/–Ω–µ—Ç **‚â•0.8**
- –†–µ—Ç—Ä–∞–∏ –∞–Ω—Ç–∏-—á—É—à–∏: 1 ‚Äî —Ä–µ–ø—Ä–æ–º–ø—Ç; 2 ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∏/–∫–Ω–æ–ø–∫–∏; 3 ‚Äî –æ–ø–µ—Ä–∞—Ç–æ—Ä

### –õ–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤

**–ü—Ä–∏ –≤–∞–ª–∏–¥–Ω–æ–º –æ—Ç–≤–µ—Ç–µ (confidence ‚â• 0.65):**
- CAPI ‚Üí —Å–æ–±—ã—Ç–∏–µ QUALIFY_Q{n}
- Custom Audiences ‚Üí –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ CA_QUAL_Q{n} –∏ —Å–µ–≥–º–µ–Ω—Ç–Ω—ã–µ (–±—é–¥–∂–µ—Ç/–∫–∞–Ω–∞–ª/–Ω–∏—à–∞)
- CRM ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ custom fields –≤ –∫–æ–Ω—Ç–∞–∫—Ç–µ (cf_niche, cf_budget_month)
- –ë–î ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –∏ confidence score
- –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É

**–ü—Ä–∏ —à—É–º–µ/–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏ (confidence < 0.65):**
- –†–µ–ø—Ä–æ–º–ø—Ç ‚Üí –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —É—Ç–æ—á–Ω–µ–Ω–∏—è –≤ —Ä–∞–º–∫–∞—Ö —à–∞–≥–∞
- NOISE pixel ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–π dataset –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- Custom Audiences ‚Üí CA_EXCLUDE_NOISE
- CRM ‚Üí —Ç–µ–≥ trash/ambiguous
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

### –≠–º–∏—Å—Å–∏–∏ –Ω–∞ **–∫–∞–∂–¥–æ–º –≤–∞–ª–∏–¥–Ω–æ–º** –æ—Ç–≤–µ—Ç–µ

**CAPI (–ø—Ä–∏–º–µ—Ä):**

```json
{
  "event_name": "QUALIFY_Q{N}",
  "event_time": 1736123456,
  "event_id": "sess-123-q2-9a1c...",
  "action_source": "chat",
  "user_data": {
    "external_id": "<sha256(tenantId:subscriberId)>",
    "ph": "<sha256(msisdn)>"
  },
  "custom_data": {
    "step": "q2",
    "answer_raw": "–æ–∫–æ–ª–æ 2500$",
    "answer_parsed": {"budget_month":2500,"bucket":"1‚Äì5k"},
    "quality_score": 0.86,
    "validity": "valid",
    "session_id": "sess-123",
    "tenant_id": "tenant-1",
    "project_id": "project-1",
    "mapping_version": "1.0.0"
  }
}
```

**–ê—É–¥–∏—Ç–æ—Ä–∏–∏:**
- `valid` ‚Üí `CA_QUAL_{stepKey}` + –≤–µ—Ç–≤–µ–≤—ã–µ (`CA_NICHE_*`, `CA_BUDGET_*`, `CA_CHANNEL_*`, `CA_UPLIFT_{yes|no}`)
- `noise/ambiguous` ‚Üí `CA_EXCLUDE_NOISE` **–∏/–∏–ª–∏** ¬´—Ç–µ–Ω–µ–≤–æ–π¬ª –ø–∏–∫—Å–µ–ª—å/–¥–∞—Ç–∞—Å–µ—Ç **NEG**

**CRM:**
Upsert –ª–∏–¥–∞; –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π —à–∞–≥–∞; –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π `QUALIFY_{stepKey}` (raw/parsed/qs)

**–≠–º–∏—Å—Å–∏–∏ –ø–æ —à–∞–≥–∞–º ‚Äî –¥–∞–π–¥–∂–µ—Å—Ç:**
- **Q1:** CAPI `QUALIFY_Q1{niche,pain}`; Aud `CA_QUAL_Q1 + CA_NICHE_*`; CRM `cf_niche/cf_pain`; DB+outbox
- **Q2:** CAPI `QUALIFY_Q2{budget_month,bucket}`; Aud `CA_QUAL_Q2 + CA_BUDGET_*`; CRM `cf_budget_*`; DB
- **Q3:** CAPI `QUALIFY_Q3{main_traffic_channel}`; Aud `CA_QUAL_Q3 + CA_CHANNEL_*`; CRM `cf_main_channel`; DB
- **Q4:** CAPI `QUALIFY_Q4{uplift}`; Aud `CA_QUAL_Q4 + CA_UPLIFT_{yes|no}`; CRM `cf_budget_uplift_ready`; DB

### –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è noise/ambiguous

- **S1 (–∂—ë—Å—Ç–∫–∞—è):** –ë–î + `CA_EXCLUDE_NOISE`, –±–µ–∑ CAPI/CRM
- **S2 (—Ç–µ–Ω–µ–≤–∞—è):** **NEG** CAPI –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–∏–∫—Å–µ–ª—å/–¥–∞—Ç–∞—Å–µ—Ç `NEG_QUALIFY_{stepKey}`; CRM ‚Äî –Ω–µ—Ç
- **S3 (—Å–º–µ—à–∞–Ω–Ω–∞—è):** CRM-–∑–∞–º–µ—Ç–∫–∞ (–±–µ–∑ —Å—Ç–∞–¥–∏–∏) + `CA_EXCLUDE_NOISE`; CAPI ‚Äî –Ω–µ—Ç
**Persist-all:** —Å–æ—Ö—Ä–∞–Ω—è–µ–º **–≤—Å—ë** (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ **lookalike-–∏—Å–∫–ª—é—á–µ–Ω–∏–π**)

### –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/hold

- –ü–µ—Ä–≤—ã–π `valid` –ø–æ —à–∞–≥—É ‚Üí —à—Ç–∞—Ç–Ω—ã–π –ø–∞–∫–µ—Ç —ç–º–∏—Å—Å–∏–π
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π `valid` ‚Üí `QUALIFY_{stepKey}_UPDATE` (–∏–ª–∏ —Ç–æ—Ç –∂–µ `event_id`)
- `ambiguous/noise` **–Ω–∏–∫–æ–≥–¥–∞** –Ω–µ –∞–ø–¥–µ–π—Ç–∏—Ç `valid`-–∏–≤–µ–Ω—Ç
- `hold=true` (–æ–ø–µ—Ä–∞—Ç–æ—Ä/–ø–∞—É–∑–∞): –≤–æ–ø—Ä–æ—Å—ã –Ω–µ —à–ª—ë–º –∏ –Ω—É–¥–∂–∏ off; **–≤–∞–ª–∏–¥–Ω—ã–µ –≤—Ö–æ–¥—è—â–∏–µ –æ—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ —ç–º–∏—Ç–∏–º**
- `optOut=true`: –≤—Å–µ –∏—Å—Ö–æ–¥—è—â–∏–µ off; –≤–∞–ª–∏–¥–Ω—ã–µ –≤—Ö–æ–¥—è—â–∏–µ ‚Äî **—Ç–æ–ª—å–∫–æ –ë–î** (–±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö —ç–º–∏—Å—Å–∏–π)

### StepValidator (Custom Function –≤ Chatflow)

```javascript
async function validateStep(input, options) {
  const { step, answer, session } = input
  
  // –í—ã–∑–æ–≤ LLM –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
  const validation = await classifyAnswer({
    step,
    question: QUESTIONS[step],
    answer,
    context: session.variables
  })
  
  // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ validity
  let validity = 'ambiguous'
  if (validation.confidence >= 0.65) {
    validity = 'valid'
  } else if (validation.confidence < 0.3) {
    validity = 'noise'
  }
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î —Å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é
  const eventId = generateEventId(session.id, step, answer)
  await db.funnel_answers.upsert({
    where: { event_id: eventId },
    create: {
      tenant_id: session.tenant_id,
      subscriber_id: session.subscriber_id,
      session_id: session.id,
      step,
      answer_raw: answer,
      answer_parsed: validation.parsed,
      validity,
      quality_score: validation.confidence,
      event_id: eventId,
      version: 1
    }
  })
  
  // –≠–º–∏—Å—Å–∏—è —Å–æ–±—ã—Ç–∏–π –¥–ª—è valid
  if (validity === 'valid') {
    await emitToAllChannels({
      event_type: `QUALIFY_${step}`,
      event_id: eventId,
      session,
      answer: validation.parsed
    })
  }
  
  return {
    validity,
    confidence: validation.confidence,
    parsed: validation.parsed,
    nextAction: determineNextAction(validity, session)
  }
}
```

---

## ‚è± –ù–£–î–ñ–ò –ò –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø - STATE MACHINE

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã

- `delivered` (–Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ): `T+15–º` ‚Üí –¥–æ `24—á`, **–ª–∏–º–∏—Ç 2**
- `read` (–ø—Ä–æ—á–∏—Ç–∞–Ω–æ, –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞): `T+2–º` ‚Üí –¥–æ `20–º`, **–ª–∏–º–∏—Ç 2**
- `failed`: —Å—Ä–∞–∑—É; –∑–∞—Ç–µ–º `snooze 24—á` + –∞–ª–µ—Ä—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É

**–ü—Ä–∞–≤–∏–ª–∞:** –º–∏–Ω. –∏–Ω—Ç–µ—Ä–≤–∞–ª ‚â•2 –º–∏–Ω; –ø—Ä–∏ `hold/optOut/snooze` ‚Äî OFF; —É—á–∏—Ç—ã–≤–∞—Ç—å —Ä–∞–±–æ—á–∏–µ –æ–∫–Ω–∞

### State Machine –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π

```
PENDING ‚Üí SENT ‚Üí DELIVERED ‚Üí READ ‚Üí REPLIED
         ‚Üì       ‚Üì           ‚Üì       ‚Üì
       FAILED  NOT_DELIVERED IGNORED PROCESSED
         ‚Üì                    ‚Üì
      RETRY/ESCALATE      NUDGE_SENT
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω—É–¥–∂–µ–π

```json
{
  "nudge_rules": [
    {
      "trigger": "message_sent_not_read",
      "delay": "15m",
      "max_attempts": 2,
      "window": "24h",
      "action": {
        "type": "reminder",
        "template": "nudge_not_read",
        "text": "üëã –í–∏–¥–∏–º–æ –≤—ã –∑–∞–Ω—è—Ç—ã. –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –∂–¥–∞—Ç—å –≤–∞—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞"
      }
    },
    {
      "trigger": "message_read_no_reply", 
      "delay": "2m",
      "max_attempts": 2,
      "window": "20m",
      "action": {
        "type": "follow_up",
        "template": "nudge_no_reply",
        "text": "–í—ã –∑–¥–µ—Å—å? –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –æ—Ç–≤–µ—Ç–æ–º?"
      }
    },
    {
      "trigger": "qualification_abandoned",
      "delay": "1h",
      "max_attempts": 1,
      "window": "24h",
      "action": {
        "type": "re_engage",
        "template": "come_back_template",
        "switch_to_template": true
      }
    }
  ]
}
```

### –†–∞–∑–ª–∏—á–∏–µ: –†–µ–ø—Ä–æ–º–ø—Ç—ã vs –ù—É–¥–∂–∏

**–†–µ–ø—Ä–æ–º–ø—Ç—ã** (–≤ —Ä–∞–º–∫–∞—Ö —à–∞–≥–∞):
- –°—á–µ—Ç—á–∏–∫ –≤ Flowise Variables
- –î–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —Å—Ä–∞–∑—É –≤ –¥–∏–∞–ª–æ–≥–µ
- –ü—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –æ—Ç–≤–µ—Ç–µ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å

**–ù—É–¥–∂–∏** (–º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏):
- –°—á–µ—Ç—á–∏–∫ –≤ –±—ç–∫–µ–Ω–¥ nudge-service
- –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ —Ç–∞–π–º–∏–Ω–≥—É
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ

---

## üôã –í–û–ü–†–û–°–´ –ò –≠–°–ö–ê–õ–ê–¶–ò–Ø

### –í–æ–ø—Ä–æ—Å—ã (–≤ –ª—é–±–æ–π —Ç–æ—á–∫–µ)

- `to_funnel & –±—É–¥–µ—Ç` ‚Üí –Ω–∞–∑–≤–∞—Ç—å —à–∞–≥, –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ `askedId`
- `to_funnel & –Ω–µ –±—É–¥–µ—Ç` ‚Üí `importance`: low‚Üíparking; high‚ÜíKB (‚â•0.7) –∏–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä
- `off_funnel` ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤–∞–∂–Ω–æ—Å—Ç–∏; –ø–æ—Å–ª–µ ‚Äî ¬´–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ {askedId}¬ª

### –ú—É–ª—å—Ç–∏-–∏–Ω—Ç–µ–Ω—Ç

–ï—Å–ª–∏ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç+–≤–æ–ø—Ä–æ—Å: 
1. —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å/—ç–º–∏—Ç–∏—Ç—å valid
2. –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ–ø—Ä–æ—Å (¬ß10)
3. –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É —à–∞–≥—É

### –ü–∞—Ä–∫–∏–Ω–≥/–¥–æ—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å–ª–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏

–í `CONTENT/END`: —Å–Ω–∞—á–∞–ª–∞ high (KB‚â•0.7/–æ–ø–µ—Ä–∞—Ç–æ—Ä), –∑–∞—Ç–µ–º low –±–∞—Ç—á-–æ—Ç–≤–µ—Ç–æ–º

### –≠—Å–∫–∞–ª–∞—Ü–∏—è (HITL)

**–¢—Ä–∏–≥–≥–µ—Ä—ã:** `retries‚â•3`, `KB.conf<0.7` –ø—Ä–∏ high, —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å/–∂–∞–ª–æ–±–∞/—Ä–∏—Å–∫–∏, —è–≤–Ω—ã–π ¬´–æ–ø–µ—Ä–∞—Ç–æ—Ä¬ª

**–ü–∞–∫–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É:** `stage/askedId`, –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π, `importance/relevance/confidence`, –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ –ø–æ–ª—è, –æ–±–µ—â–∞–Ω–∏—è

**–ü–æ—Å–ª–µ:** ¬´–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å qN¬ª

---

## üíæ –ü–ê–ú–Ø–¢–¨: –ö–ê–ö –ò –ß–¢–û –ò–°–ü–û–õ–¨–ó–£–ï–ú

### –°–ª–æ–π –ø–∞–º—è—Ç–∏

**–ö–æ—Ä–æ—Ç–∫–∞—è (runtime, 24‚Äì72—á) ‚Üí Redis**
- **–ß—Ç–æ –∫–ª–∞–¥—ë–º:** –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è LLM, –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π, –±—ã—Å—Ç—Ä—ã–µ —Ñ–ª–∞–≥–∏ (`retries/hold/optOut`), –∫–æ–Ω—Ç–µ–∫—Å—Ç —à–∞–≥–∞
- **–ó–∞—á–µ–º:** –¥—ë—à–µ–≤–æ/–±—ã—Å—Ç—Ä–æ, –Ω–∏–∑–∫–∞—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, TTL, –∫–ª—é—á–∏ –ø–æ `sessionId`
- **–ì–¥–µ –≤ Flowise:**
  - **Redis Cache** ‚Äî –∫—ç—à –æ—Ç–≤–µ—Ç–æ–≤ LLM
  - **Redis-Backed Chat Memory** ‚Äî –¥–∏–∞–ª–æ–≥ –¥–ª—è –∞–≥–µ–Ω—Ç–∞

**–î–æ–ª–≥–∞—è (–∞—É–¥–∏—Ç/–∞–Ω–∞–ª–∏—Ç–∏–∫–∞/–ø–æ–∏—Å–∫) ‚Üí Postgres (+pgvector –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)**
- **–ß—Ç–æ –∫–ª–∞–¥—ë–º:** `messages_raw/meta/links`, `funnel_answers`, `events_outbox`, CTWA-–º–µ—Ç–∫–∏, –∑–∞–∫–∞–∑—ã/–æ–ø–ª–∞—Ç—ã, ¬´–≤–µ—á–Ω–∞—è¬ª –ø–∞–º—è—Ç—å —Ñ–∞–∫—Ç–æ–≤
- **–ó–∞—á–µ–º:** –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å, SQL, –æ—Ç—á—ë—Ç—ã, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, RAG (—á–µ—Ä–µ–∑ `pgvector`)

**(–û–ø—Ü.) –í–µ–∫—Ç–æ—Ä–Ω—ã–π —Å–ª–æ–π ‚Üí pgvector** ‚Äî —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —Ñ–∞–∫—Ç–æ–≤/–ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π

### –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —É–∑–ª—ã/–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ Chatflow

**Redis Cache**
- Credential: –≤–∞—à Redis/Valkey
- `TTL: 600‚Äì3600s`
- `Key prefix: ws:{{$vars.workspaceId}}:cache:`
- –ü–æ–¥–∫–ª—é—á–∞—Ç—å –∫ ChatOpenAI/–º–æ–¥–µ–ª–∏ –∫–∞–∫ Cache

**Redis-Backed Chat Memory**
- Credential: —Ç–æ—Ç –∂–µ Redis
- `Session Id: {{$vars.sessionId}}`
- `Prefix: ws:{{$vars.workspaceId}}:chat:`
- **Window: 8‚Äì20 —Å–æ–æ–±—â–µ–Ω–∏–π** *(—ç—Ç–æ **–ø—Ä–∏–º–µ—Ä**, –Ω–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞)*
- –ü–æ–¥–∫–ª—é—á–∞—Ç—å –≤ Tool/Conversational Agent ‚Üí Memory

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (Set/Get Variable)**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º: `workspaceId, tenantId, sessionId, stepKey, retries`

**–î–æ–ª–≥–∞—è –ø–∞–º—è—Ç—å** ‚Äî –¥–µ–ª–∞–µ—Ç **–±—ç–∫–µ–Ω–¥** –ø–æ –≤–µ–±—Ö—É–∫–∞–º (Gupshup/Stripe/CRM) –≤ Postgres (+ –∏–Ω–¥–µ–∫—Å –≤ pgvector). –í Chatflow –æ—Ç–¥–µ–ª—å–Ω—ã–π —É–∑–µ–ª –Ω–µ –Ω—É–∂–µ–Ω

### –ü–æ–ª–∏—Ç–∏–∫–∏ –∏ –∏–∑–æ–ª—è—Ü–∏—è

**–ö–ª—é—á–∏:**
- `ws:{workspaceId}:chat:{sessionId}` ‚Äî –∏—Å—Ç–æ—Ä–∏—è
- `ws:{workspaceId}:cache:{hash(prompt)}` ‚Äî –∫—ç—à LLM
- **Redis key prefix:** `org:{tenantId}:prj:{projectId}:sess:{sessionId}`
- **pgvector namespace:** —Ñ–∏–ª—å—Ç—Ä `WHERE tenant_id=? AND project_id=?` (+–∏–Ω–¥–µ–∫—Å—ã)

**TTL:** —á–∞—Ç-–∏—Å—Ç–æ—Ä–∏—è 24‚Äì72—á; –∫—ç—à LLM 10‚Äì60 –º–∏–Ω (–¥–∏–∞–ª–æ–≥–∏) / –¥–æ–ª—å—à–µ –Ω–∞ —Å—Ç–∞—Ç–∏–∫–µ

**–û—á–∏—Å—Ç–∫–∞:** –ø—Ä–∏ `optOut/stop` ‚Äî —Å—Ä–∞–∑—É —á–∏—Å—Ç–∏–º `chat:{sessionId}`

**–°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è (–æ–ø—Ü.):** –≤–æ—Ä–∫–µ—Ä —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –¥–ª–∏–Ω–Ω—ã–µ —á–∞—Ç—ã –≤ Postgres; –≤ Redis –¥–µ—Ä–∂–∏–º `summary+tail`

---

## üì° –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–Ø –ò –û–ù–ë–û–†–î–ò–ù–ì

### –í—Ö–æ–¥ WhatsApp ‚Üî Gupshup ‚Üî Backend ‚Üî Agentflow ‚Üî Chatflow

**¬´–ì–ª–∞–≤–Ω—ã–π¬ª —Ñ–ª–æ—É –∏ —Å—Ç–∞—Ä—Ç:**
- –í—Ö–æ–¥ **–≤—Å–µ–≥–¥–∞** –≤ –±—ç–∫–µ–Ω–¥ (webhook Gupshup)
- –°—Ç–∞—Ä—Ç **–≤—Å–µ–≥–¥–∞** –≤ **Agentflow**

### –†–µ–µ—Å—Ç—Ä –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ (–ë–î `routing`)

**–ü–æ–ª—è:** `tenant_id, bm_id, wa_app_id(–∏–ª–∏ wa_phone), entry_type(default|ctwa|keyword), entry_value(ad_id|adset_id|campaign_id|keyword), agentflow_id, chatflow_id_default(–æ–ø—Ü.), status`

**–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å:** `(wa_app_id, entry_type, entry_value)` ‚Äî `UNIQUE`

**–õ–æ–≥–∏–∫–∞:** –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º –≤—Ö–æ–¥—è—â–µ–≥–æ (–Ω–æ–º–µ—Ä/wa_app_id + CTWA-—Ç–µ–≥–∏) –±–µ–∫ –Ω–∞—Ö–æ–¥–∏—Ç —Å—Ç—Ä–æ–∫—É –∏ –ø–æ–ª—É—á–∞–µ—Ç `agentflow_id` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç Agentflow `/predict`

### –ö–∞–∫ –±–µ–∫ –ø–æ–Ω–∏–º–∞–µ—Ç ¬´—ç—Ç–æ WhatsApp¬ª

–ò–∑ webhook: `provider="gupshup"`, `wa_app_id/phone`, —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è (`message`, `template`, `status: delivered|read|failed`). –≠—Ç–∏ –ø–æ–ª—è –∏–¥—É—Ç –≤ `messages_meta` –∏ –≤ —Ä–æ—É—Ç–∏–Ω–≥

### –ù–µ—Å–∫–æ–ª—å–∫–æ WA-–Ω–æ–º–µ—Ä–æ–≤ –≤ –æ–¥–Ω–æ–º BM + –æ–Ω–±–æ—Ä–¥–∏–Ω–≥

- –ú–∞—Å—Ç–µ—Ä-–æ–Ω–±–æ—Ä–¥–∏–Ω–≥ (–≤ –∞–¥–º–∏–Ω–∫–µ) –∏ –Ω–æ–¥–∞ ¬´Onboarding¬ª –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –ë–î
- –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –¥–µ–ª–∞–µ—Ç: —Å–ø–∏—Å–æ–∫ WA-–∞–∫–∫–∞—É–Ω—Ç–æ–≤/–Ω–æ–º–µ—Ä–æ–≤; –≤—ã–±–æ—Ä ¬´–ø—Ä–∏–≤—è–∑–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π¬ª/¬´–∑–∞–≤–µ—Å—Ç–∏ –Ω–æ–≤—ã–π¬ª; –≤—ã–±–æ—Ä –≥–ª–∞–≤–Ω–æ–≥–æ `Agentflow` (–∏ –æ–ø—Ü. –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ `Chatflow`); –∑–∞–ø–∏—Å—å –≤ `routing`
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: `wa_app_id` **UNIQUE** –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–≤—è–∑–∫–∞—Ö (–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞)

### –ö—Ç–æ ¬´–∫–æ–º—É –∑–≤–æ–Ω–∏—Ç¬ª

- –ë–µ–∫ **–Ω–∏–∫–æ–º—É –≤–Ω—É—Ç—Ä–∏ –∫–∞–Ω–≤—ã –Ω–µ –∑–≤–æ–Ω–∏—Ç** ‚Äî —Ç–æ–ª—å–∫–æ `/predict` —É **Agentflow**
- –û—á–µ—Ä—ë–¥–Ω–æ—Å—Ç—å/step/–ø–æ—Ä–æ–≥–∏ ‚Äî **–≤ Chatflow** (Variables + Memory)
- –ë–µ–∫ –ø–µ—Ä–µ–¥–∞—ë—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç: `tenantId, orgId, workspaceId, sessionId, wa_app_id/phone, ctwa_*`
- –î–∞–ª—å—à–µ Agentflow ‚Üí Execute Flow(Chatflow); –≤–Ω—É—Ç—Ä–∏ Chatflow —Ç—É–ª–∞–º–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è WA-–æ—Ç–ø—Ä–∞–≤–∫–∏/—ç–º–∏—Å—Å–∏–∏

### ¬´–°—Ç—Ä–∞–Ω–∏—Ü–∞ Sequences¬ª –∏ ¬´–Ω–æ–¥–∞ WhatsApp¬ª

- –î–µ–ª–∞–µ–º –≤–Ω–µ—à–Ω—é—é —Å—Ç—Ä–∞–Ω–∏—Ü—É **Sequences** (–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π/–∫–Ω–æ–ø–æ–∫/–ª–∏—Å—Ç–æ–≤ —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- –í Flowise ‚Äî **–æ–¥–Ω–∞** –Ω–æ–¥–∞ **WA Send (Gupshup)** (Custom Tool), –Ω–∞ –≤—Ö–æ–¥ –ø–æ–¥–∞—ë—Ç—Å—è `sequence_id`/`message_id`
- –ù–æ–¥–∞ —Å–∞–º–∞ —Ç—è–Ω–µ—Ç –∏–∑ –ë–î –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞–∫–µ—Ç
- –ü–æ—Ä—è–¥–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø–∞–∫–µ—Ç–µ —Ä–µ—à–∞–µ—Ç –±–µ–∫ (–ø–æ `sequence_id`), –Ω–∞ –∫–∞–Ω–≤–µ –ø–æ—Ä—è–¥–æ–∫ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Ç–æ–∫

### –ì–¥–µ –∂–∏–≤—ë—Ç ¬´–Ω–æ–¥–∞ WhatsApp¬ª

- –û—Ç–ø—Ä–∞–≤–∫–∞ (text/template/buttons/list/‚Ä¶) ‚Äî **–≤ Chatflow** (—á–µ—Ä–µ–∑ Tool Agent ‚Üí WA Send)
- –ö–æ—Ä–æ—Ç–∫–∏–µ ack –Ω–∞ –∫–æ–¥-—Å–ª–æ–≤–∞ –¥–æ –≤—Ö–æ–¥–∞ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Äî –º–æ–∂–Ω–æ –∏ –∏–∑ **Agentflow** —Ç–æ–π –∂–µ –Ω–æ–¥–æ–π
- ¬´–°–ª—É—à–∞—Ç–µ–ª—å¬ª –≤—Ö–æ–¥—è—â–∏—Ö ‚Äî **—Ç–æ–ª—å–∫–æ –±–µ–∫** (webhook)

### ¬´–ù–æ–¥–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è¬ª –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è

- –°–ª—É—à–∞—Ç–µ–ª—å ‚Äî –±–µ–∫
- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Äî –≤–Ω—É—Ç—Ä–∏ **Chatflow** (Tool Agent + –ø—Ä–æ–º–ø—Ç/–ø—Ä–∞–≤–∏–ª–∞) –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–∞—è Intent/Moderation-–Ω–æ–¥–∞
- –°—Ç–∞—Ç—É—Å—ã –¥–æ—Å—Ç–∞–≤–∫–∏ (delivered/read/failed) –ª–æ–≤–∏—Ç –±–µ–∫ –∏ —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –Ω—É–¥–∂–∏ (—á–µ—Ä–µ–∑ —Å–≤–æ–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫)
- –í Flowise ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥–∞ `/nudge/schedule`

### –ò–¥–µ–æ–ª–æ–≥–∏—è

- Start ‚Äî —Ç–æ–ª—å–∫–æ –≤ **Agentflow** (–∫–æ–¥-—Å–ª–æ–≤–∞/–≥–ª–æ–±–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è) ‚Üí Execute Flow(Chatflow)
- –í **Chatflow** ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —à–∞–≥–æ–≤, –≤–∞–ª–∏–¥–∞—Ç–æ—Ä, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (WA Send, CAPI, Audiences, CRM, Stripe, Nudge, Operator)
- –ü–∞–º—è—Ç—å –∏ —à–∞–≥–∏ ‚Äî –≤ Chatflow (Redis-Backed Chat Memory + Variables)
- –ú—É–ª—å—Ç–∏–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ (WA/TG/IG/FBM): –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —Å—Ö–µ–º–∞, –º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–π —Ç—É–ª

### –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏/–∫–∞–Ω–∞–ª—ã

- –ú–æ–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ Chatflow
- –í Agentflow —á–µ—Ä–µ–∑ Condition/–≤–µ—Ç–≤–ª–µ–Ω–∏—è –≤—ã–±–∏—Ä–∞—Ç—å, –∫–∞–∫–æ–π Chatflow –¥–µ—Ä–Ω—É—Ç—å (–ø–æ –Ω–æ–º–µ—Ä—É/CTWA/keyword)
- –û–ø–µ—Ä–∞—Ç–æ—Ä (HITL) ‚Äî –≤ Agentflow (–≤–µ—Ç–∫–∞ operator) + –Ω–æ–¥–∞ ¬´–°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç¬ª + Human Input

### –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—å –∏ –≥–¥–µ (–º–∏–Ω–∏–º—É–º)

**–ë–î:** `routing`, `messages_raw/meta`, `funnel_answers`, `events_outbox`, `sequences`, `wa_accounts`, `projects`

**Redis:** `org:{orgId}:ws:{wsId}:session:{sessionId}` ‚Äî –∏—Å—Ç–æ—Ä–∏—è/—Å–æ—Å—Ç–æ—è–Ω–∏–µ

**Variables (Workspace):** `qual_manifest`, `policy` (–ø–æ—Ä–æ–≥–∏/—Ä–µ—Ç—Ä–∞–∏/–Ω—É–¥–∂–∏), `ids` (–ø–∏–∫—Å–µ–ª—å/–∞—É–¥–∏—Ç–æ—Ä–∏–∏/CRM-–º–∞–ø–ø–∏–Ω–≥), `texts_common`

---

## üì≤ –ù–û–î–ê ¬´WA SEND (GUPSHUP)¬ª ‚Äî ¬´–ù–ê–ß–ò–ù–ö–ê¬ª

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–æ–¥—ã (6 –≥—Ä—É–ø–ø –ø–æ–ª–µ–π)

**1. –ê–¥—Ä–µ—Å–∞—Ü–∏—è**
- `to` (E.164, +7999‚Ä¶ –∏–ª–∏ `contact_id` –∏–∑ CRM)
- `wa_app_id` (–ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–π WA-–∞–∫–∫–∞—É–Ω—Ç Gupshup)
- `project_id / tenant_id / session_id` (–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è/–ª–æ–≥–∏)
- `idempotency_key` *(–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `sessionId-msg-<hash(message_id+vars)>`)*

**2. –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å (–∫–æ–Ω—Ç–µ–Ω—Ç)**
- `mode: message | sequence`
- `message_id | sequence_id` (—Å—Å—ã–ª–∫–∏ –Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π)
- `vars {}` (–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏, –Ω–∞–ø—Ä. `{name:"–ò–≤–∞–Ω", budget:"5k"}`)

**(–û–ø—Ü.) Inline –¥–ª—è —Ä–∞–∑–æ–≤—ã—Ö —Å–ª—É—á–∞–µ–≤:**
- `type:` `text | template | interactive_buttons | interactive_list | media_image | media_video | media_audio | document | location | contact`
- `payload` –ø–æ —Ç–∏–ø—É:
  - `text: { text }`
  - `interactive_buttons: { text, buttons:[{id,title}] }`
  - `interactive_list: { header?, body, sections:[{title, rows:[{id,title,description?}]}] }`
  - `media_*: { url | file_id, caption? }`
  - `template: { template_name, language, components:[‚Ä¶], variables:{‚Ä¶} }`
  - `location: { lat, lng, name?, address? }`
  - `contact: { vcard | fields‚Ä¶ }`

**3. –†–µ–∂–∏–º –¥–æ—Å—Ç–∞–≤–∫–∏ (24 —á–∞—Å–∞)**
- `delivery_mode:` `auto | session_only | template_only`
- `fallback_template?` (–∏–º—è —à–∞–±–ª–æ–Ω–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ 24—á)
- `typing_simulation? on|off, delay_ms?`

**4. –ü–æ–ª–∏—Ç–∏–∫–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è**
- `validate: on|off` (–ª–∏–º–∏—Ç—ã WA: –¥–ª–∏–Ω—ã/–∫–Ω–æ–ø–∫–∏/—Ç–∏–ø—ã)
- `block_if_optout: on|off`
- `respect_quiet_hours: on|off, window:{start,end,tz}`
- `rate_limit_tag?` (—Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥/BSP –ª–∏–º–∏—Ç—ã)

**5. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ–±–∞–≥**
- `trace_id` *(–∞–≤—Ç–æ: `sessionId:stepKey:ts`)*
- `dry_run: on|off` ‚Äî –Ω–µ —à–ª—ë—Ç, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏ –æ—Ç–¥–∞—ë—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π payload
- `return_raw: on|off` ‚Äî –≤–µ—Ä–Ω—É—Ç—å —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç Gupshup

**6. –í—ã—Ö–æ–¥—ã –Ω–æ–¥—ã (outputs)**
- `status: queued | sent | failed`
- `outbound_id` (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π id)
- `provider_message_id` (id —É Gupshup/WA)
- `idempotency_key` (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–π)
- `error: code, message, retry_after?`
- `meta: delivery_mode_used, template_used?, media_info?`

**–ú–∏–Ω–∏-–ø—Ä–∏–º–µ—Ä –≤—ã–∑–æ–≤–∞ (—Å—Å—ã–ª–∫–æ–π –Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫—É):**
```
to=+79991234567
wa_app_id=gs_app_01
mode=message
message_id=msg_q2@v7
vars={ "name":"–ò–≤–∞–Ω", "budget":"5k" }
delivery_mode=auto
idempotency_key=session123-msg-7b1c‚Ä¶
```

---

## üèóÔ∏è –ü–†–û–ï–ö–¢–´ –ò –†–û–£–¢–ò–ù–ì

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ + A/B (–ø–æ–∑–∂–µ)

**–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω–∏–º—É–º):**
- `projects(id, tenant_id, name, slug, status, default_agentflow_id, default_chatflow_id, qual_manifest_id, policy_id, created_at)`
- `wa_accounts(id, bm_id, wa_app_id, phone_e164, status, created_at)`
- `routing(id, tenant_id, project_id, wa_app_id, entry_type(default|ctwa|keyword), entry_value, agentflow_id, chatflow_id, status, created_at)`
  ‚Äî `UNIQUE(wa_app_id, entry_type, entry_value)` (–∏—Å–∫–ª—é—á–∞–µ—Ç –¥–≤–æ–π–Ω—É—é –ø—Ä–∏–≤—è–∑–∫—É)

### –†–æ—É—Ç–∏–Ω–≥ –≤—Ö–æ–¥—è—â–∏—Ö

1. Gupshup webhook ‚Üí –∏–∑–≤–ª–µ—á—å `wa_app_id/phone, ctwa_*, message/text`
2. –ù–∞–π—Ç–∏ –≤ `routing` –ø–æ `(wa_app_id, entry_type, entry_value)` (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: `ctwa:ad|adset|campaign` ‚Üí `keyword` ‚Üí `default`)
3. –ü–æ–ª—É—á–∏—Ç—å `project_id, agentflow_id, chatflow_id`; –≤—ã–∑–≤–∞—Ç—å Agentflow `/predict` (`question`, Vars: `projectId, tenantId, wa_app_id, sessionId, ctwa_*`)
4. Agentflow ‚Üí Execute Flow(Chatflow)

### –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –Ω–æ–º–µ—Ä–æ–≤

UI: –≤—ã–±—Ä–∞—Ç—å –ü—Ä–æ–µ–∫—Ç ‚Üí WA –Ω–æ–º–µ—Ä (`wa_accounts`) ‚Üí —Å–æ–∑–¥–∞—Ç—å `routing(default, '*')`. –ï—Å–ª–∏ `wa_app_id` —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫–∞–∫ `default` –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ ‚Äî –∑–∞–ø—Ä–µ—Ç–∏—Ç—å

### –°–æ–±—ã—Ç–∏—è/—ç–º–∏—Å—Å–∏–∏: —É–∫–∞–∑—ã–≤–∞—Ç—å `project_id`

CAPI/custom_data, Audiences payload, CRM note/fields, DB (`funnel_answers`, `events_outbox`) ‚Äî –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è—Ç—å `project_id`

### A/B (–ø–æ–∑–∂–µ, –±–µ–∑ –ª–æ–º–∫–∏)

- `routing_variants{project_id, variant_code, weight, agentflow_id, chatflow_id}`
- Sticky-–±–∞–∫–µ—Ç: —Ö–µ—à —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚Üí `variant_code`
- –í—ã–∑–æ–≤ —Ä–∞–∑–Ω—ã—Ö Chatflow **–∏–ª–∏** –æ–¥–Ω–æ–≥–æ Chatflow —Å —Ä–∞–∑–Ω—ã–º–∏ `qual_manifest_id/policy_id`

### Flowise: –ø–∞–ø–∫–∏/—Ç–µ–≥–∏/–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–Ω–µ–π–º–∏–Ω–≥) + –∏–∑–æ–ª—è—Ü–∏—è

**–¢–µ–≥–∏/–Ω–µ–π–º–∏–Ω–≥:**
- **Agentflow:** `[PRJ:slug] Agent START`
- **Chatflow:** `[PRJ:slug] Chat QUALIFIER`

**Workspace/Prediction Variables:** `projectId, tenantId, wa_app_id, sessionId, ctwa, qual_manifest_id, policy_id`

---

## üîó –ò–ù–¢–ï–ì–†–ê–¶–ò–ò (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)

### CAPI - Facebook Conversions API

**–°–æ–±—ã—Ç–∏—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
```json
{
  "data": [
    {
      "event_name": "QUALIFY_Q2",
      "event_time": 1736123456,
      "event_id": "sess-123-q2-9a1c...",
      "event_source_url": "https://wa.me/79991234567",
      "action_source": "chat",
      "user_data": {
        "external_id": "<sha256(tenantId:subscriberId)>",
        "ph": "<sha256(msisdn)>"
      },
      "custom_data": {
        "step": "q2",
        "answer_raw": "–æ–∫–æ–ª–æ 2500$",
        "answer_parsed": {"budget_month":2500,"bucket":"1‚Äì5k"},
        "quality_score": 0.86,
        "validity": "valid",
        "session_id": "sess-123",
        "tenant_id": "tenant-1",
        "project_id": "project-1",
        "mapping_version": "1.0.0"
      }
    }
  ]
}
```

### Custom Audiences - –†–µ–∫–ª–∞–º–Ω—ã–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏

**–ë–∞–∑–æ–≤—ã–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏:**
- `A1_STARTED_NOT_FINISHED` - –ù–∞—á–∞–ª–∏ –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≤–æ—Ä–æ–Ω–∫—É
- `A2_QUALIFIED` - –ü—Ä–æ—à–ª–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é  
- `A3_REJECTED` - –û—Ç–∫–∞–∑–Ω–∏–∫–∏ –∏ —à—É–º

**–°–µ–≥–º–µ–Ω—Ç–Ω—ã–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏:**
- `CA_QUAL_Q1`, `CA_QUAL_Q2` - –ü–æ —à–∞–≥–∞–º –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `CA_BUDGET_10K_50K`, `CA_BUDGET_50K_PLUS` - –ü–æ –±—é–¥–∂–µ—Ç—É
- `CA_CHANNEL_INSTAGRAM` - –ü–æ –∫–∞–Ω–∞–ª—É
- `CA_PURCHASED` - –°–æ–≤–µ—Ä—à–∏–ª–∏ –ø–æ–∫—É–ø–∫—É
- `CA_EXCLUDE_NOISE` - –ò—Å–∫–ª—é—á–µ–Ω–∏—è —à—É–º–∞

### CRM - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏

**–ú–∞–ø–ø–∏–Ω–≥ –ø–æ–ª–µ–π (Kommo):**
```json
{
  "contact": {
    "name": "{{profileName || waPhone}}",
    "phone": "{{waPhone}}",
    "custom_fields": {
      "641289": "{{ctwa.campaign_id}}",
      "641290": "{{ctwa.adset_id}}",
      "641291": "{{ctwa.ad_id}}",
      "641292": "{{answers.Q1.niche}}",
      "641293": "{{answers.Q2.budget}}",
      "641294": "{{answers.Q3.channel}}"
    }
  }
}
```

**–¢—Ä–∏–≥–≥–µ—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:**
| –°–æ–±—ã—Ç–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ –≤ CRM |
|---------|---------------|
| CTWA —Å—Ç–∞—Ä—Ç | –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –∏ —Å–¥–µ–ª–∫—É |
| –í–∞–ª–∏–¥–Ω—ã–π Qn | –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—è + –∫–æ–º–º–µ–Ω—Ç |
| –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞ | –°–º–µ–Ω–∏—Ç—å —Å—Ç–∞–¥–∏—é |
| –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞ | –°–º–µ–Ω–∏—Ç—å –Ω–∞ "–û–ø–ª–∞—á–µ–Ω–æ" |

### Stripe - –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

**–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å—Å—ã–ª–∫–∏:**
```javascript
const paymentLink = await stripe.paymentLinks.create({
  line_items: [{
    price: 'price_ABC123',
    quantity: 1
  }],
  metadata: {
    session_id: 'session_123',
    subscriber_id: 'sub_789',
    product_id: 'SKU_001',
    source: 'whatsapp_funnel'
  }
})
```

**–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook —Å–æ–±—ã—Ç–∏–π:**
- `checkout.session.completed` ‚Üí Purchase —Å–æ–±—ã—Ç–∏–µ –≤ CAPI
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–π ‚Üí –ø–µ—Ä–µ–Ω–æ—Å –≤ CA_PURCHASED
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CRM ‚Üí —Å–º–µ–Ω–∞ —Å—Ç–∞–¥–∏–∏ –Ω–∞ "–û–ø–ª–∞—á–µ–Ω–æ"
- WhatsApp –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí template —Å —á–µ–∫–æ–º

---

## üìê –°–¢–†–£–ö–¢–£–†–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

**`subscribers`**
```sql
CREATE TABLE subscribers (
  id UUID PRIMARY KEY,
  tenant_id VARCHAR NOT NULL,
  wa_phone VARCHAR UNIQUE NOT NULL,
  phone_hash VARCHAR NOT NULL,
  profile_name VARCHAR,
  first_seen_at TIMESTAMP,
  last_inbound_at TIMESTAMP,
  status VARCHAR DEFAULT 'active',
  optout BOOLEAN DEFAULT false,
  snoozed_until TIMESTAMP,
  conversation_id VARCHAR,
  conversation_expires_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**`funnel_answers`**
```sql
CREATE TABLE funnel_answers (
  id UUID PRIMARY KEY,
  tenant_id BIGINT NOT NULL,
  subscriber_id BIGINT NOT NULL,
  session_id TEXT NOT NULL,
  step_key TEXT NOT NULL,
  validity TEXT NOT NULL CHECK (validity IN ('valid','noise','ambiguous')),
  quality_score NUMERIC(3,2) NOT NULL,
  answer_raw TEXT NOT NULL,
  answer_parsed JSONB NOT NULL DEFAULT '{}'::jsonb,
  version INT NOT NULL DEFAULT 1,
  event_id TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ,
  PRIMARY KEY (tenant_id, subscriber_id, session_id, step_key)
);
```

**`events_outbox`**
```sql
CREATE TABLE events_outbox (
  id BIGSERIAL PRIMARY KEY,
  event_id TEXT NOT NULL UNIQUE,
  channel TEXT NOT NULL CHECK (channel IN ('CAPI','AUDIENCE','CRM')),
  payload JSONB NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','sent','failed','on_hold')),
  retries INT NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_error TEXT
);
```

**`messages_raw`**
```sql
CREATE TABLE messages_raw (
  id UUID PRIMARY KEY,
  message_id VARCHAR UNIQUE NOT NULL,
  session_id VARCHAR,
  direction VARCHAR NOT NULL, -- inbound/outbound
  type VARCHAR NOT NULL, -- text/image/button/list/template
  payload JSONB NOT NULL,
  status VARCHAR, -- sent/delivered/read/failed
  parent_id UUID, -- —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ
  parent_type VARCHAR, -- step/message/none
  created_at TIMESTAMP DEFAULT NOW(),
  delivered_at TIMESTAMP,
  read_at TIMESTAMP,
  replied_at TIMESTAMP
);
```

**–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:** `funnel_answers` + –ø–∞—á–∫–∞ `events_outbox` ‚Üí –∫–æ–º–º–∏—Ç. Worker: –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏, backoff `1‚Üí2‚Üí5‚Üí15` –º–∏–Ω

---

## üìä –ú–ï–¢–†–ò–ö–ò –ò –ê–õ–ï–†–¢–´

–ü–æ —à–∞–≥–∞–º: –¥–æ–ª—è `valid/noise/ambiguous`, —Å—Ä. `quality_score`, % –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

–ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã: latency/–æ—à–∏–±–∫–∏/–ø–æ–≤—Ç–æ—Ä—ã

–ö–∞—á–µ—Å—Ç–≤–æ —Ç—Ä–∞—Ñ–∏–∫–∞: –¥–æ–ª—è `CA_EXCLUDE_NOISE`

HITL: SLA, –≤—Ä–µ–º—è –≤–æ–∑–≤—Ä–∞—Ç–∞

–ù—É–¥–∂–∏: CTR/–æ—Ç–≤–µ—Ç—ã/—ç—Å–∫–∞–ª–∞—Ü–∏–∏

–†–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏—è: % `NOISE‚ÜíGOOD`

---

## üî¢ –ü–û–†–û–ì–û–í–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø

- Free-text ‚â•0.7
- Choice ‚â•0.8
- KB-–æ—Ç–≤–µ—Ç ‚â•0.7
- –ê–Ω—Ç–∏-—á—É—à—å —Ä–µ—Ç—Ä–∞–∏ `1‚Üí2‚Üí3(–æ–ø–µ—Ä–∞—Ç–æ—Ä)`
- –ù—É–¥–∂–∏ `read:2‚Üí20–º(2)`, `delivered:15–º‚Üí24—á(2)`

---

## üîê –ù–ê–î–Å–ñ–ù–û–°–¢–¨ –ò –ü–†–ò–í–ê–¢–ù–û–°–¢–¨

- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (`event_id` + —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ outbox)
- Backoff-—Ä–µ—Ç—Ä–∞–∏
- Hash-PII (sha256) –¥–ª—è `external_id/ph`
- –ê—É–¥–∏—Ç —Ä–µ—à–µ–Ω–∏–π (valid/noise/ambiguous, –Ω—É–¥–∂–∏, –∫–æ–¥-—Å–ª–æ–≤–∞, —ç—Å–∫–∞–ª–∞—Ü–∏–∏)

---

## üîÑ –ú–ò–ù–ò-FSM (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)

```
Qn.wait ‚Üí (–∫–æ–¥-—Å–ª–æ–≤–æ) ‚Üí hold/optOut/snooze
Qn.wait ‚Üí (valid) ‚Üí emit(Qn) ‚Üí Q{n+1}.wait|CONTENT
Qn.wait ‚Üí (ambiguous/noise) ‚Üí retry/assist ‚Üí Qn.wait|operator
any ‚Üí (question) ‚Üí route(¬ß10) ‚Üí return(Qn.wait)
CONTENT ‚Üí END
```

---

## üéÆ AGENTFLOW –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø

### WhatsApp Send Node - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –Ω–æ–¥–∞

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–æ–¥—ã:**
```javascript
{
  name: "WhatsAppSend_Agentflow",
  type: "WhatsAppSend",
  category: "Agent Flows",
  version: "1.0.0",
  description: "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ WhatsApp",
  inputs: [
    {
      label: "Message Type",
      name: "messageType",
      type: "options",
      options: [
        { value: "text", label: "Text" },
        { value: "image", label: "Image" },
        { value: "button", label: "Interactive Buttons" },
        { value: "list", label: "Interactive List" },
        { value: "template", label: "Template" }
      ],
      default: "text"
    },
    {
      label: "To",
      name: "to",
      type: "string",
      placeholder: "+79991234567",
      acceptVariable: true
    },
    {
      label: "Session ID", 
      name: "sessionId",
      type: "string",
      acceptVariable: true
    },
    {
      label: "Idempotency Key",
      name: "idempotencyKey",
      type: "string",
      acceptVariable: true,
      optional: true
    }
  ]
}
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ session/template:**
- –í –ø—Ä–µ–¥–µ–ª–∞—Ö 24h –æ–∫–Ω–∞ ‚Üí session message
- –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è 24h ‚Üí template message
- –ü—Ä–∏ failed –¥–æ—Å—Ç–∞–≤–∫–µ session ‚Üí retry –∫–∞–∫ template

---

## üèÅ –ö–†–ê–ï–í–´–ï –°–õ–£–ß–ê–ò

- –î–ª–∏–Ω–Ω—ã–µ –ø–æ–ª–æ—Ç–Ω–∞ ‚Üí —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è/–¥–æ–ø—Ä–æ—Å
- –ì–æ–ª–æ—Å/—Ñ–æ—Ç–æ ‚Üí ASR/OCR‚Üí—Ç–µ –∂–µ –ø—Ä–∞–≤–∏–ª–∞
- –î—É–±–ª–∏–∫–∞—Ç—ã ‚Üí –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å `lastOutboundId/event_id`
- `hold=true` ‚Äî –≤–∞–ª–∏–¥–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã **–Ω–µ —Ç–µ—Ä—è–µ–º** –∏ **—ç–º–∏—Ç–∏–º**
- `optOut` ‚Äî –≤—Ö–æ–¥—è—â–∏–µ **—Ç–æ–ª—å–∫–æ –ë–î**, –Ω–∞—Ä—É–∂—É **–Ω–µ** —à–ª—ë–º

---

## ‚öôÔ∏è –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –í–ù–ï–î–†–ï–ù–ò–Æ

- –ö–∞—Ä—Ç–∞ `willCoverLater`
- –°–ª–æ–≤–∞—Ä–∏/–Ω–µ–≥–∞—Ü–∏–∏
- –ü–æ—Ä–æ–≥–∏/–æ–∫–Ω–∞/–ª–∏–º–∏—Ç—ã
- –ë–î/–≤–æ—Ä–∫–µ—Ä—ã/outbox
- –ê—É–¥–∏—Ç–æ—Ä–∏–∏ `CA_QUAL_*` / `CA_EXCLUDE_NOISE`
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥/–∞–ª–µ—Ä—Ç—ã
- –¢–µ—Å—Ç—ã: –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å/—Ä–µ—Ç—Ä–∞–∏/noise/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è/–∫–æ–¥-—Å–ª–æ–≤–∞/–Ω—É–¥–∂–∏

---

## üö´ –¢–ò–ü–û–í–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø

### –ü–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ Flowise
**–°–∏–º–ø—Ç–æ–º:** Variables (stepKey, answers, retries) —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –≤ null/undefined
**–ü—Ä–∏—á–∏–Ω–∞:** Flowise –Ω–µ –ø–µ—Ä—Å–∏—Å—Ç–∏—Ç Variables –º–µ–∂–¥—É —Ä–µ—Å—Ç–∞—Ä—Ç–∞–º–∏
**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ –ë–î —á–µ—Ä–µ–∑ Custom Function –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ –ë–î –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏
- Fallback: –Ω–∞—á–∞–ª–æ —Å Q1 –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π CAPI
**–°–∏–º–ø—Ç–æ–º:** –û–¥–Ω–æ —Å–æ–±—ã—Ç–∏–µ QUALIFY_Q{n} –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
**–ü—Ä–∏—á–∏–Ω–∞:** Retry –ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏  
**–†–µ—à–µ–Ω–∏–µ:**
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π event_id = `{sessionId}-q{n}-{hash(answer_raw)}`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ outbox –ø–µ—Ä–µ–¥ —ç–º–∏—Å—Å–∏–µ–π: `SELECT 1 FROM events_outbox WHERE event_id = ?`
- Constraint UNIQUE(event_id) –≤ –ë–î

### –ò—Å—Ç–µ—á–µ–Ω–∏–µ 24h –æ–∫–Ω–∞ WhatsApp
**–°–∏–º–ø—Ç–æ–º:** –û—à–∏–±–∫–∞ 403/400 –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ session message —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
**–ü—Ä–∏—á–∏–Ω–∞:** WhatsApp Policy - session messages —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 24h –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥—è—â–µ–≥–æ
**–†–µ—à–µ–Ω–∏–µ:**
- –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ template message –≤ WA Send node
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `conversation_expires_at` –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- Fallback templates –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

### –ù–∏–∑–∫–∏–π confidence score –≤ LLM
**–°–∏–º–ø—Ç–æ–º:** –ú–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ambiguous (0.3 ‚â§ confidence < 0.65)
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –∫–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
**–†–µ—à–µ–Ω–∏–µ:**
- –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –≤–∞–ª–∏–¥–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
- Clarification prompts: "–£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞..."
- –°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ confidence –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —à–∞–≥–æ–≤

### –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è CRM
**–°–∏–º–ø—Ç–æ–º:** –ü–æ–ª—è –≤ CRM –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
**–ü—Ä–∏—á–∏–Ω–∞:** Webhook –ø—Ä–æ–ø—É—â–µ–Ω, timeout, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π mapping
**–†–µ—à–µ–Ω–∏–µ:**
- Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è CRM webhooks —Å exponential backoff
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö CRM –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- Fallback –Ω–∞ –ø—Ä—è–º—ã–µ API –≤—ã–∑–æ–≤—ã –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ webhook

### –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º —Ç—Ä–∞—Ñ–∏–∫–µ
**–°–∏–º–ø—Ç–æ–º:** –ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, —Ç–∞–π–º–∞—É—Ç—ã LLM
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤, –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
**–†–µ—à–µ–Ω–∏–µ:**
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ Flowise —á–µ—Ä–µ–∑ Docker replicas
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Queue (Bull/Agenda)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ LLM –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- Circuit breaker –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API (OpenAI, Gupshup)

### –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ CTWA –¥–∞–Ω–Ω—ã—Ö
**–°–∏–º–ø—Ç–æ–º:** campaign_id/ad_id –ø—Ä–∏—Ö–æ–¥—è—Ç –ø—É—Å—Ç—ã–º–∏ –∏–ª–∏ —Å –º—É—Å–æ—Ä–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
**–ü—Ä–∏—á–∏–Ω–∞:** –†–∞–∑–ª–∏—á–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–∞—Ö webhook –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
**–†–µ—à–µ–Ω–∏–µ:**
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤ parser —Å–ª–æ–µ: —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —Ä–µ–≥–µ–∫—Å–∞–º
- Fallback –Ω–∞ utm_* –∏–∑ referral.source_url –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä—è–º—ã—Ö –ø–æ–ª–µ–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ raw webhook –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–æ–≤—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è CTWA

---

## üö¶ –ë–ò–ó–ù–ï–°-–ü–†–ê–í–ò–õ–ê –ò –ò–ù–í–ê–†–ò–ê–ù–¢–´

### –ñ–µ—Å—Ç–∫–∏–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã

**–ü—Ä–∞–≤–∏–ª–æ 1: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —ç–º–∏—Å—Å–∏—è**
```
–ï–°–õ–ò –æ—Ç–≤–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π (confidence ‚â• 0.65)
–¢–û –°–†–ê–ó–£ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ CAPI + Audiences + CRM + –ë–î
–ë–ï–ó –û–ñ–ò–î–ê–ù–ò–Ø –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ—Ä–æ–Ω–∫–∏
```

**–ü—Ä–∞–≤–∏–ª–æ 2: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤**
```
GOOD –ø–æ—Ç–æ–∫ ‚Üí –æ—Å–Ω–æ–≤–Ω–æ–π pixel/dataset
NOISE –ø–æ—Ç–æ–∫ ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–π pixel/dataset –∏–ª–∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø–∏–∫—Å–µ–ª—å/–¥–∞—Ç–∞—Å–µ—Ç NEG
–ù–ò–ö–û–ì–î–ê –Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å –ø–æ—Ç–æ–∫–∏
```

**–ü—Ä–∞–≤–∏–ª–æ 3: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–æ–¥-—Å–ª–æ–≤**
```
–ö–æ–¥-—Å–ª–æ–≤–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –î–û –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –ª–æ–≥–∏–∫–∏
stop/pause/operator (—Å–∏–Ω–æ–Ω–∏–º—ã) –∏–º–µ—é—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
```

**–ü—Ä–∞–≤–∏–ª–æ 4: –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**
```
–ö–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π event_id
–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

**–ü—Ä–∞–≤–∏–ª–æ 5: CRM —Å—Ç–∞–¥–∏–∏**
```
–ù–ï –¥–≤–∏–≥–∞–µ–º —Å—Ç–∞–¥–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
–ö–†–û–ú–ï —è–≤–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª (–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞)
```

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏**: 0.65 (–µ–¥–∏–Ω—ã–π –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –æ—Ç–≤–µ—Ç–æ–≤ –∞–≥–µ–Ω—Ç–∞)
2. **–†–µ–ø—Ä–æ–º–ø—Ç—ã**: –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —Å—Ä–∞–∑—É –≤ –¥–∏–∞–ª–æ–≥–µ (—Å—á–µ—Ç—á–∏–∫ per step)
3. **–ù—É–¥–∂–∏**: –¥–æ 2 –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π —Å –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–º —Ç–∞–π–º–∏–Ω–≥–æ–º (—Å—á–µ—Ç—á–∏–∫ per case)
4. **–°—Ç–∞–¥–∏–∏ CRM**: –¥–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ —è–≤–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º (–Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
5. **–≠–º–∏—Å—Å–∏–∏**: –≤—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥ —Å outbox-–ø–∞—Ç—Ç–µ—Ä–Ω–æ–º
6. **–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö**: GOOD –∏ NOISE —Å—Ç—Ä–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã (—Ä–∞–∑–Ω—ã–µ pixels)
7. **24h –æ–∫–Ω–æ**: –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ template messages –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏
8. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π event_id –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
9. **Persist-all**: —Å–æ—Ö—Ä–∞–Ω—è–µ–º **–≤—Å–µ** –æ—Ç–≤–µ—Ç—ã/—à—É–º—ã –≤ –ë–î –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

---

## üîÑ –ü–†–û–¶–ï–°–°–´ –ò –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø

### Qualification Pipeline

```mermaid
graph TD
    A[CTWA Click] --> B[Create Session]
    B --> C[Send Q1]
    C --> D{Validate Answer}
    D -->|Valid ‚â•0.65| E[Emit CAPI/CRM/CA]
    D -->|Noise <0.3| F[Retry/Escalate]
    D -->|Ambiguous 0.3-0.65| G[Clarify]
    E --> H[Send Q2]
    F --> I{Retry < 3?}
    I -->|Yes| C
    I -->|No| J[Escalate to Operator]
    G --> K[Wait for Clarification]
    K --> D
    H --> L[Continue Steps...]


    –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ —à–∞–≥–∞–º (–∏–∑ v2):
  const STEP_VALIDATION_RULES = {
  Q1: {
    type: 'free_text',
    fields: ['niche', 'pain'],
    rules: {
      pain: '–º–∏–Ω–∏–º—É–º 4 –∑–Ω–∞—á–∏–º—ã—Ö —Å–ª–æ–≤–∞',
      niche: '–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –∫–∞—Ç–∞–ª–æ–≥–µ',
      similarity_threshold: 0.7
    }
  },
  Q2: {
    type: 'free_text', 
    fields: ['budget'],
    parser: 'extractBudgetBucket',
    buckets: ['<1k', '1-5k', '5-20k', '20k+'],
    similarity_threshold: 0.7
  },
  Q3: {
    type: 'choice',
    options: ['instagram', 'facebook', 'google', 'tiktok'],
    allow_synonyms: true,
    similarity_threshold: 0.8
  },
  Q4: {
    type: 'choice',
    options: ['yes', 'no'],
    similarity_threshold: 0.8
  }
}


Nudge State Machine (—Ä–∞—Å—à–∏—Ä–µ–Ω–æ –∏–∑ v2)
stateDiagram-v2
    [*] --> Sent
    Sent --> Delivered: WhatsApp delivered
    Sent --> Failed: Delivery failed
    Delivered --> Read: WhatsApp read
    Delivered --> NotRead: 15min timeout
    Read --> Replied: User replied
    Read --> NoReply: 2min timeout
    NotRead --> Nudge1: Send reminder (limit 2)
    NoReply --> Nudge2: Send follow-up (limit 2)
    Nudge1 --> Delivered
    Nudge2 --> Read
    Failed --> Retry: Immediate
    Failed --> Snooze24h: After retry
    Retry --> Sent: Retry attempt
    Retry --> Escalate: Max retries
    Snooze24h --> AlertOperator


    –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω—É–¥–∂–µ–π —Å –ª–∏–º–∏—Ç–∞–º–∏ (–∏–∑ v2):

delivered (–Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ): T+15–º ‚Üí –¥–æ 24—á, –ª–∏–º–∏—Ç 2
read (–ø—Ä–æ—á–∏—Ç–∞–Ω–æ, –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞): T+2–º ‚Üí –¥–æ 20–º, –ª–∏–º–∏—Ç 2
failed: —Å—Ä–∞–∑—É retry; –∑–∞—Ç–µ–º snooze 24—á + –∞–ª–µ—Ä—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –Ω—É–¥–∂–∞–º–∏: ‚â•2 –º–∏–Ω
–ü—Ä–∏ hold/optOut/snooze ‚Äî –Ω—É–¥–∂–∏ OFF
üìä –ü–ê–ú–Ø–¢–¨ –ò –•–†–ê–ù–ò–õ–ò–©–ê (–∏–∑ v2 #input3)
–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–∞–º—è—Ç–∏
–ö–æ—Ä–æ—Ç–∫–∞—è –ø–∞–º—è—Ç—å (Redis) - runtime, 24-72—á:
const REDIS_MEMORY_CONFIG = {
  chat_history: {
    key_pattern: 'ws:{workspaceId}:chat:{sessionId}',
    ttl: 86400 * 3, // 72 —á–∞—Å–∞
    window_size: 20, // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π
    content: ['messages', 'context', 'flags']
  },
  llm_cache: {
    key_pattern: 'ws:{workspaceId}:cache:{hash(prompt)}',
    ttl: 3600, // 1 —á–∞—Å –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
    static_ttl: 86400 // 24 —á–∞—Å–∞ –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏
  },
  session_state: {
    key_pattern: 'org:{tenantId}:prj:{projectId}:sess:{sessionId}',
    ttl: 86400,
    content: ['retries', 'hold', 'optOut', 'stepContext']
  }
}


–î–æ–ª–≥–∞—è –ø–∞–º—è—Ç—å (PostgreSQL + pgvector):
-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ö–µ–º–∞ –∏–∑ v2

-- –ü–∞–º—è—Ç—å —Ñ–∞–∫—Ç–æ–≤ —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –ø–æ–∏—Å–∫–æ–º
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE subscriber_facts (
  id UUID PRIMARY KEY,
  tenant_id BIGINT NOT NULL,
  subscriber_id BIGINT NOT NULL,
  fact_type VARCHAR NOT NULL, -- preference/behavior/purchase
  fact_text TEXT NOT NULL,
  fact_embedding vector(1536), -- –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞
  confidence DECIMAL(3,2),
  extracted_at TIMESTAMP,
  session_id VARCHAR,
  created_at TIMESTAMP DEFAULT NOW(),
  INDEX idx_vector_search ON subscriber_facts 
    USING ivfflat (fact_embedding vector_cosine_ops)
    WITH (lists = 100)
);


–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Flowise Memory Nodes
Redis-Backed Chat Memory:
{
  credential: 'Redis/Valkey Connection',
  sessionId: '{{$vars.sessionId}}',
  prefix: 'ws:{{$vars.workspaceId}}:chat:',
  windowSize: 20, // –ù–ï —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞, –ø—Ä–∏–º–µ—Ä
  ttl: 259200 // 72 —á–∞—Å–∞
}


Variables –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:
const WORKSPACE_VARIABLES = {
  workspaceId: context.workspace.id,
  tenantId: context.tenant.id,
  projectId: context.project.id,
  sessionId: generateSessionId(),
  stepKey: 'Q1',
  retries: {},
  qual_manifest_id: context.manifest.id,
  policy_id: context.policy.id
}


üö¶ –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–Ø –ò –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–ï –ù–û–ú–ï–†–ê (–∏–∑ v2 #input4)
–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

  agentflow_id VARCHAR NOT NULL,
  chatflow_id VARCHAR,
  status VARCHAR DEFAULT 'active',
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(wa_app_id, entry_type, entry_value)
);

CREATE TABLE wa_accounts (
  id BIGSERIAL PRIMARY KEY,
  bm_id VARCHAR NOT NULL,
  wa_app_id VARCHAR NOT NULL UNIQUE,
  phone_e164 VARCHAR NOT NULL,
  status VARCHAR DEFAULT 'active',
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE projects (
  id BIGSERIAL PRIMARY KEY,
  tenant_id BIGINT NOT NULL,
  name VARCHAR NOT NULL,
  slug VARCHAR NOT NULL,
  status VARCHAR DEFAULT 'active',
  default_agentflow_id VARCHAR,
  default_chatflow_id VARCHAR,
  qual_manifest_id VARCHAR,
  policy_id VARCHAR,
  created_at TIMESTAMP DEFAULT NOW()
);


Pipeline –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
async function routeIncomingMessage(webhook: GupshupWebhook) {
  // 1. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  const waAppId = webhook.app.id
  const ctwaParams = extractCTWA(webhook.referral)
  
  // 2. –ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
  const route = await findRoute(waAppId, ctwaParams) || 
                 await findRoute(waAppId, 'keyword', webhook.text) ||
                 await findRoute(waAppId, 'default', '*')
  
  if (!route) {
    throw new Error(`No route found for ${waAppId}`)
  }
  
  // 3. –°–æ–∑–¥–∞–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
  const sessionId = generateSessionId({
    source: ctwaParams ? 'ctwa' : 'direct',
    details: ctwaParams?.ad_id || '',
    subscriberId: webhook.sender,
    timestamp: Date.now()
  })
  
  // 4. –í—ã–∑–æ–≤ Agentflow (–≤—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞)
  const response = await callAgentflow({
    agentflowId: route.agentflow_id,
    sessionId,
    message: webhook.text,
    variables: {
      projectId: route.project_id,
      tenantId: route.tenant_id,
      waAppId,
      ctwa: ctwaParams,
      qual_manifest_id: route.qual_manifest_id,
      policy_id: route.policy_id
    }
  })
  
  return response
}


üì§ WHATSAPP SEND NODE - –ü–û–õ–ù–ê–Ø –°–ü–ï–¶–ò–§–ò–ö–ê–¶–ò–Ø (–∏–∑ v2 #input5)
–í–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–æ–¥—ã WA Send (Gupshup)
class WhatsAppSendTool extends Tool {
  constructor() {
    super()
    this.name = 'WA Send (Gupshup)'
    this.description = '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ WhatsApp —Å–æ–æ–±—â–µ–Ω–∏–π'
    this.inputs = {
      // 1. –ê–¥—Ä–µ—Å–∞—Ü–∏—è
      to: { type: 'string', required: true }, // E.164 –∏–ª–∏ contact_id
      wa_app_id: { type: 'string', required: true },
      project_id: { type: 'string' },
      tenant_id: { type: 'string' },
      session_id: { type: 'string' },
      idempotency_key: { type: 'string' }, // auto: sessionId-msg-<hash>
      
      // 2. –ö–æ–Ω—Ç–µ–Ω—Ç
      mode: { type: 'enum', values: ['message', 'sequence'] },
      message_id: { type: 'string' },
      sequence_id: { type: 'string' },
      vars: { type: 'object' }, // –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ {name: "–ò–≤–∞–Ω"}
      
      // Inline payload (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      type: { 
        type: 'enum', 
        values: ['text', 'template', 'interactive_buttons', 
                 'interactive_list', 'media_image', 'media_video', 
                 'media_audio', 'document', 'location', 'contact']
      },
      payload: { type: 'object' },
      
      // 3. –†–µ–∂–∏–º –¥–æ—Å—Ç–∞–≤–∫–∏
      delivery_mode: { 
        type: 'enum', 
        values: ['auto', 'session_only', 'template_only'],
        default: 'auto'
      },
      fallback_template: { type: 'string' },
      typing_simulation: { type: 'boolean', default: false },
      delay_ms: { type: 'number' },
      
      // 4. –ü–æ–ª–∏—Ç–∏–∫–∏
      validate: { type: 'boolean', default: true },
      block_if_optout: { type: 'boolean', default: true },
      respect_quiet_hours: { type: 'boolean', default: true },
      quiet_window: { type: 'object' }, // {start, end, tz}
      rate_limit_tag: { type: 'string' },
      
      // 5. Debug
      trace_id: { type: 'string' }, // auto: sessionId:stepKey:ts
      dry_run: { type: 'boolean', default: false },
      return_raw: { type: 'boolean', default: false }
    }
  }
  
  async execute(inputs) {
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è idempotency_key –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω
    if (!inputs.idempotency_key) {
      inputs.idempotency_key = generateIdempotencyKey(
        inputs.session_id,
        inputs.message_id || inputs.sequence_id,
        inputs.vars
      )
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ optout —Å—Ç–∞—Ç—É—Å–∞
    if (inputs.block_if_optout) {
      const subscriber = await getSubscriber(inputs.to)
      if (subscriber.optout) {
        return {
          status: 'blocked',
          reason: 'subscriber_opted_out'
        }
      }
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ session/template
    if (inputs.delivery_mode === 'auto') {
      const canUseSession = await checkSessionWindow(inputs.to)
      inputs.delivery_mode = canUseSession ? 'session' : 'template'
      
      if (!canUseSession && inputs.fallback_template) {
        inputs.type = 'template'
        inputs.payload = { template_name: inputs.fallback_template }
      }
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Gupshup API
    const result = await gupshupClient.send(inputs)
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ outbox –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏
    await saveToOutbox({
      event_id: inputs.idempotency_key,
      channel: 'WHATSAPP',
      payload: inputs,
      status: result.success ? 'sent' : 'failed',
      provider_message_id: result.messageId
    })
    
    return {
      status: result.success ? 'sent' : 'failed',
      outbound_id: result.outboundId,
      provider_message_id: result.messageId,
      idempotency_key: inputs.idempotency_key,
      error: result.error,
      meta: {
        delivery_mode_used: inputs.delivery_mode,
        template_used: inputs.payload?.template_name
      }
    }
  }
}


–ü—Ä–∏–º–µ—Ä—ã –≤—ã–∑–æ–≤–∞ –Ω–æ–¥—ã
// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫—É
{
  to: '+79991234567',
  wa_app_id: 'gs_app_01',
  mode: 'message',
  message_id: 'msg_q2@v7',
  vars: { name: '–ò–≤–∞–Ω', budget: '5k' },
  delivery_mode: 'auto',
  session_id: 'session123'
}

// Inline –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏
{
  to: '+79991234567',
  wa_app_id: 'gs_app_01',
  type: 'interactive_buttons',
  payload: {
    text: '–í—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª –ø—Ä–æ–¥–∞–∂:',
    buttons: [
      { id: 'instagram', title: 'Instagram' },
      { id: 'facebook', title: 'Facebook' },
      { id: 'google', title: 'Google Ads' }
    ]
  },
  delivery_mode: 'auto'
}
````

---

## üéØ A/B –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ò –í–ê–†–ò–ê–ù–¢–´

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è A/B –±–µ–∑ –ª–æ–º–∫–∏ —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏

````sql
CREATE TABLE routing_variants (
  id BIGSERIAL PRIMARY KEY,
  project_id BIGINT NOT NULL,
  variant_code VARCHAR NOT NULL,
  weight DECIMAL(3,2) NOT NULL, -- –≤–µ—Å –≤–∞—Ä–∏–∞–Ω—Ç–∞ 0.00-1.00
  agentflow_id VARCHAR NOT NULL,
  chatflow_id VARCHAR,
  qual_manifest_id VARCHAR,
  policy_id VARCHAR,
  status VARCHAR DEFAULT 'active',
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(project_id, variant_code)
);

-- Sticky assignment –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
CREATE TABLE subscriber_variants (
  subscriber_id BIGINT PRIMARY KEY,
  project_id BIGINT NOT NULL,
  variant_code VARCHAR NOT NULL,
  assigned_at TIMESTAMP DEFAULT NOW(),
  INDEX idx_project_variant (project_id, variant_code)
);
````

---

## üìà –ú–ï–¢–†–ò–ö–ò –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ —à–∞–≥–∞–º

````javascript
const QUALIFICATION_METRICS = {
  step_performance: {
    valid_rate: 'COUNT(validity="valid") / COUNT(*)',
    noise_rate: 'COUNT(validity="noise") / COUNT(*)', 
    ambiguous_rate: 'COUNT(validity="ambiguous") / COUNT(*)',
    avg_quality_score: 'AVG(quality_score) WHERE validity="valid"',
    update_rate: 'COUNT(version > 1) / COUNT(*)'
  },
  
  connectors: {
    capi_latency: 'p95(response_time) WHERE channel="CAPI"',
    capi_error_rate: 'COUNT(status="failed") / COUNT(*)',
    retry_rate: 'COUNT(retries > 0) / COUNT(*)'
  },
  
  traffic_quality: {
    noise_audience_size: 'COUNT(DISTINCT subscriber_id) IN CA_EXCLUDE_NOISE',
    noise_to_good_recovery: 'COUNT(transitioned from noise to valid)'
  },
  
  hitl_sla: {
    escalation_rate: 'COUNT(escalated) / COUNT(*)',
    resolution_time: 'AVG(resolved_at - escalated_at)',
    return_to_bot_rate: 'COUNT(returned_to_bot) / COUNT(escalated)'
  },
  
  nudge_effectiveness: {
    delivered_ctr: 'COUNT(replied after nudge) / COUNT(nudged)',
    read_response_rate: 'COUNT(replied) / COUNT(read)',
    escalation_after_nudge: 'COUNT(escalated) / COUNT(nudged)'
  }
}
````

### –ê–ª–µ—Ä—Ç—ã –∏ –ø–æ—Ä–æ–≥–∏

````yaml
alerts:
  qualification:
    - name: low_valid_rate
      condition: valid_rate < 0.5
      severity: warning
      notification: slack
    
    - name: high_noise_rate  
      condition: noise_rate > 0.3
      severity: critical
      notification: [slack, email]
    
    - name: capi_failures
      condition: error_rate > 0.05
      window: 5m
      severity: critical
      notification: pagerduty
  
  system:
    - name: hitl_queue_overflow
      condition: unassigned_tickets > 10
      severity: warning
      
    - name: nudge_limit_exceeded
      condition: nudge_count > configured_limit
      severity: info
````




