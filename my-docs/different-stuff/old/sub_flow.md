# üåê –§–ª–æ—É –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ —Ç–µ–Ω–∞–Ω—Ç–∞ WhatsApp

> **üìé –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:**
> - [Webhook Payload Specification](../incoming-webhooks/webhook-payload-specification.md) - RAW —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥—è—â–∏—Ö webhook
> - [Subscriber Data Structure](../subscriber/exact-subscriber-data-structure-v2.md) - –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ –≤ –ë–î
> - [Arriwa Logic V2](../arriwa-logic-v2.md) - –æ–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã
> - –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç: –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π flow –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è JSON-—Å—Ç—Ä—É–∫—Ç—É—Ä

---

## 1. –¢–û–ß–ö–ê –í–•–û–î–ê –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø

### 1.1 CTWA-–∫–ª–∏–∫ –∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç –Ω–∞ —Ä–µ–∫–ª–∞–º—É Facebook/Instagram
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è WhatsApp —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º –±–∏–∑–Ω–µ—Å–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ª—é–±–æ–π —Ç–µ–∫—Å—Ç –∏–ª–∏ —à–∞–±–ª–æ–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ)

### 1.1.1 QR Code –≤—Ö–æ–¥ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫–∞–Ω–∏—Ä—É–µ—Ç QR –∫–æ–¥ —Å —É–ø–∞–∫–æ–≤–∫–∏/–ø–æ—Å—Ç–µ—Ä–∞/–≤–∏–∑–∏—Ç–∫–∏
- QR —Å–æ–¥–µ—Ä–∂–∏—Ç: `wa.me/79991234567?text=QR_START_PROMO&product_id=SKU001&location_id=MSK`
- –ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: product_id, location_id, promo_code
- –°–æ–∑–¥–∞–µ—Ç—Å—è —Å–µ—Å—Å–∏—è –±–µ–∑ CTWA-–¥–∞–Ω–Ω—ã—Ö: `qr_{product_id}_{subscriber_id}_{timestamp}`
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ø–æ–∫–∞–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞/—É—Å–ª—É–≥–∏ –∏–∑ product_id

### 1.1.2 –§–æ—Ä–º–∞—Ç sessionId (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π)
–û–±—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω: `{source}_{details}_{subscriber_id}_{timestamp}`
- **CTWA**: `ctwa_fb_{subscriber_id}_{timestamp}`
- **QR**: `qr_{product_id}_{subscriber_id}_{timestamp}`  
- **Direct**: `direct_{subscriber_id}_{timestamp}`
- **Link**: `link_{utm_source}_{subscriber_id}_{timestamp}`

–ì–¥–µ:
- source: —Ç–∏–ø —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞
- details: —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (product_id, utm_source, etc)
- subscriber_id: UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- timestamp: Unix timestamp –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö

### 1.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ (–±—ç–∫–µ–Ω–¥)
- **Webhook Gupshup** –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
- **–ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è CTWA-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã**: campaign_id, adset_id, ad_id, creative_id, utm_*, placement, publisher_platform, click_id
- **–°–æ–∑–¥–∞–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–π sessionId**: `ctwa_fb_{subscriber_id}_{timestamp}`
- **–°—Ç–∞—Ä—Ç–æ–≤—ã–π —Ç—Ä–∏–≥–≥–µ—Ä**: –ª—é–±–æ–µ –ø–µ—Ä–≤–æ–µ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–ª–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–ª–æ–≤–æ, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ); –∫–æ–¥-—Å–ª–æ–≤–∞ –Ω–µ –æ–∂–∏–¥–∞—é—Ç—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º —à–∞–≥–µ
- **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: phone, name, language, country, timezone

### 1.2.1 –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–¥-—Å–ª–æ–≤
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞ –ö–ê–ñ–î–û–ú –≤—Ö–æ–¥—è—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–æ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –ª–æ–≥–∏–∫–∏
- –°–ª–æ–≤–∞ / —Å–∏–Ω–æ–Ω–∏–º—ã (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤ lowercase):
  - stop | —Å—Ç–æ–ø | unsubscribe ‚Üí –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ—Ç–ø–∏—Å–∫–∞ (optOut=true)
  - pause | –ø–∞—É–∑–∞ | snooze ‚Üí —É—Å—Ç–∞–Ω–æ–≤–∫–∞ `snoozed_until`
  - operator | –æ–ø–µ—Ä–∞—Ç–æ—Ä | human ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è HITL
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –ª—é–±—ã–µ —Ç–µ–∫—É—â–∏–µ —à–∞–≥–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏
- Flowise –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –∫–æ–¥-—Å–ª–æ–≤–æ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: audit trail –≤ messages_meta (type=keyword_interrupt)

### 1.3 –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
- **–ë–î**: —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ messages_meta —Å CTWA-–¥–∞–Ω–Ω—ã–º–∏ + —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞
- **CRM**: —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ + –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ CTWA-–ø–æ–ª–µ–π + —Å–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏ –≤ —Å—Ç–∞–¥–∏–∏ "–ù–æ–≤—ã–π/–í—Ö–æ–¥—è—â–∏–π"
- **–ú–µ–Ω–µ–¥–∂–µ—Ä**: –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º (round-robin/–Ω–∞–≥—Ä—É–∑–∫–∞/–≥–µ–æ)
- **CAPI**: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è Start/OptIn —á–µ—Ä–µ–∑ outbox —Å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º event_id
- **–ê—É–¥–∏—Ç–æ—Ä–∏–∏**: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ A1_STARTED_NOT_FINISHED
- **–ü–µ—Ä–µ—Ö–æ–¥ –≤ Flowise**: –≤—ã–∑–æ–≤ Agentflow —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Å–µ—Å—Å–∏–∏

---

## 2. FLOWISE: –û–†–ö–ï–°–¢–†–ê–¶–ò–Ø –ò –õ–û–ì–ò–ö–ê

### 2.1 Agentflow V2 (–≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å)
```
Start ‚Üí Init Variables ‚Üí Condition (—Å—Ç—Ä–∞—Ö–æ–≤–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥-—Å–ª–æ–≤) ‚Üí Execute Flow (Chatflow) ‚Üí End
         ‚Üì                ‚Üì
    (sessionId,      (–≤–µ—Ç–∫–∏ stop/pause/
     phone, ctwa)     operator —Å WA Send)
```

**–î—É–±–ª–∏—Ä—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥-—Å–ª–æ–≤** –≤ Condition node (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –¥–ª—è —Ä—É—á–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤)

### 2.2 Chatflow (–æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏)

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:**
- Set Variable: `stepKey="Q1"`, `retries=0`, `answers={}`, `confidence_scores={}`
- Buffer Memory: –∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ sessionId (–∏–∑ Redis/Valkey - –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è)
- Mem0: –∑–∞–≥—Ä—É–∑–∫–∞ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ñ–∞–∫—Ç—ã, –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏)

**–¶–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ —à–∞–≥–∞:**
1. Custom JS: –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤–æ–ø—Ä–æ—Å–∞ –∏–∑ qual_manifest –ø–æ stepKey
2. WA Send (Gupshup): –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏/—Å–ø–∏—Å–∫–æ–º
3. –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. LLM Chain: –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ ‚Üí `{validity: valid/ambiguous/noise, confidence, answer_parsed, quality_score}`
5. –í–µ—Ç–≤–ª–µ–Ω–∏–µ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### 2.3 –ú–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π –ø–æ confidence

| Confidence | Validity | –î–µ–π—Å—Ç–≤–∏—è | Stream | –ü–µ—Ä–µ—Ö–æ–¥ |
|------------|----------|----------|--------|---------|
| ‚â•0.65 | valid | emit_all, next_step | GOOD | –ö —Å–ª–µ–¥—É—é—â–µ–º—É Q |
| 0.3-0.65 | ambiguous | clarify, retry++ (–º–∞–∫—Å 3) | PENDING | –£—Ç–æ—á–Ω–µ–Ω–∏–µ |
| <0.3 | noise | reprompt/escalate (–º–∞–∫—Å 3) | NOISE | –†–µ–ø—Ä–æ–º–ø—Ç/—ç—Å–∫–∞–ª–∞—Ü–∏—è |

**–ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–µ–¥–∏–Ω—ã–µ –¥–ª—è –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã):**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞: 0.65
- –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∞–≥–µ–Ω—Ç–∞: 0.65  
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π noise: 0.3
- –ú–∞–∫—Å–∏–º—É–º —Ä–µ–ø—Ä–æ–º–ø—Ç–æ–≤ per step: 3
- –ú–∞–∫—Å–∏–º—É–º –Ω—É–¥–∂–µ–π per case: 2

---

## 3. –û–ë–†–ê–ë–û–¢–ö–ê –û–¢–í–ï–¢–û–í –ò –≠–ú–ò–°–°–ò–ò

### 3.1 –í–∞–ª–∏–¥–Ω—ã–π –æ—Ç–≤–µ—Ç (confidence ‚â• 0.65)

**–ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ —ç–º–∏—Å—Å–∏–∏ —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥ /emit (outbox-–ø–∞—Ç—Ç–µ—Ä–Ω):**
- **CAPI**: —Å–æ–±—ã—Ç–∏–µ QUALIFY_Q{n} —Å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º event_id = `sessionId-q{n}-hash(answer_raw)`
- **–ê—É–¥–∏—Ç–æ—Ä–∏–∏**: 
  - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ CA_QUAL_Q{n}
  - –í–µ—Ç–≤–µ–≤—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã (CA_BUDGET_10K_50K, CA_CHANNEL_INSTAGRAM –∏ —Ç.–¥.)
- **CRM**: 
  - Upsert –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ (cf_niche, cf_budget_month –∏ —Ç.–¥.)
  - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —Å –æ—Ç–≤–µ—Ç–æ–º –∏ confidence score
- **–ë–î**: –∑–∞–ø–∏—Å—å –≤ funnel_answers + events_outbox

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ Flowise:**
- Set Variable: `answers[stepKey] = answer_parsed`
- `confidence_scores[stepKey] = confidence`
- `stepKey = nextStep` (–∏–∑ RouterMatrix)
- `retries = 0`

**–ü–µ—Ä–µ—Ö–æ–¥**: –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É –∏–ª–∏ —Ñ–∏–Ω–∞–ª—É –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏

### 3.2 –ù–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π –æ—Ç–≤–µ—Ç (0.3 ‚â§ confidence < 0.65)

**–†–µ–ø—Ä–æ–º–ø—Ç (–¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —Å—Ä–∞–∑—É –≤ –¥–∏–∞–ª–æ–≥–µ):**
- `retries++`
- WA Send: —É—Ç–æ—á–Ω—è—é—â–∏–π —Ç–µ–∫—Å—Ç —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- –í–æ–∑–≤—Ä–∞—Ç –∫ –æ–∂–∏–¥–∞–Ω–∏—é –æ—Ç–≤–µ—Ç–∞

**–ï—Å–ª–∏ retries >= 3:**
- –≠–º–∏—Å—Å–∏—è –≤ NOISE-–ø–æ—Ç–æ–∫: NEG_QUALIFY_Q{n} (–æ—Ç–¥–µ–ª—å–Ω—ã–π pixel/dataset)
- –ê—É–¥–∏—Ç–æ—Ä–∏–∏: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ CA_EXCLUDE_NOISE
- CRM: —Ç–µ–≥ trash|ambiguous
- –≠—Å–∫–∞–ª–∞—Ü–∏—è –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

### 3.3 –®—É–º–Ω—ã–π –æ—Ç–≤–µ—Ç (confidence < 0.3)

**–ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
- –≠–º–∏—Å—Å–∏—è –≤ NOISE-–ø–æ—Ç–æ–∫: NEG_QUALIFY_Q{n}
- –ï—Å–ª–∏ retries < 3: —Ä–µ–ø—Ä–æ–º–ø—Ç —Å –±–∞–∑–æ–≤—ã–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
- –ï—Å–ª–∏ retries >= 3: —ç—Å–∫–∞–ª–∞—Ü–∏—è –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

### 3.4 –í–æ–ø—Ä–æ—Å –≤–Ω–µ —Å—Ü–µ–Ω–∞—Ä–∏—è

- –ü—Ä–æ–≤–µ—Ä–∫–∞ confidence –∞–≥–µ–Ω—Ç–∞ –Ω–∞ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
- –ï—Å–ª–∏ ‚â• 0.65: –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç + –≤–æ–∑–≤—Ä–∞—Ç –∫ —Ç–µ–∫—É—â–µ–º—É —à–∞–≥—É
- –ï—Å–ª–∏ < 0.65: —Å–æ–æ–±—â–µ–Ω–∏–µ "–æ—Ç–≤–µ—Ç–∏–º –ø–æ–∑–∂–µ" –∏–ª–∏ —ç—Å–∫–∞–ª–∞—Ü–∏—è

---

## 4. –ù–£–î–ñ–ò (–û–¢–õ–û–ñ–ï–ù–ù–´–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø)

**–û—Ç–ª–∏—á–∏–µ –æ—Ç —Ä–µ–ø—Ä–æ–º–ø—Ç–æ–≤**: –Ω—É–¥–∂–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –¥–æ—Å—Ç–∞–≤–∫–∏, –∞ –Ω–µ –ø–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤

### 4.1 –¢—Ä–∏–≥–≥–µ—Ä—ã (–∏–∑ —Å—Ç–∞—Ç—É—Å–æ–≤ Gupshup webhook)
- **Delivered, –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ**: –∑–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ T+15 –º–∏–Ω
- **Read, –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞**: –∑–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ T+2 –º–∏–Ω  
- **Failed**: –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π retry + —ç—Å–∫–∞–ª–∞—Ü–∏—è –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫
- **Qualification abandoned**: T+1 —á–∞—Å (–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ template message)

### 4.1.1 State Machine —Å–æ–æ–±—â–µ–Ω–∏—è
```
[PENDING] ‚îÄ‚îÄsend‚îÄ‚îÄ> [SENT] ‚îÄ‚îÄdelivered‚îÄ‚îÄ> [DELIVERED]
    ‚îÇ                 ‚îÇ                        ‚îÇ
    ‚îî‚îÄretry‚îÄ‚îê         ‚îî‚îÄfail‚îÄ‚îÄ> [FAILED]      ‚îî‚îÄread‚îÄ‚îÄ> [READ]
            ‚îÇ                      ‚îÇ                      ‚îÇ
            v                      v                      v
        [RETRYING]            [ESCALATED]            [REPLIED]
            ‚îÇ                      ‚îÇ                      ‚îÇ
            ‚îî‚îÄsuccess‚îÄ> [SENT]     ‚îî‚îÄmanual‚îÄ‚îÄ> [RESOLVED]  ‚îî‚îÄqualify‚îÄ‚îÄ> [VALIDATED]
```

**–ü–µ—Ä–µ—Ö–æ–¥—ã:**
- PENDING‚ÜíSENT: —É—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
- SENT‚ÜíDELIVERED: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏
- DELIVERED‚ÜíREAD: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—á–∏—Ç–∞–ª
- READ‚ÜíREPLIED: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª
- FAILED‚ÜíRETRYING: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry
- RETRYING‚ÜíESCALATED: –∏—Å—á–µ—Ä–ø–∞–Ω—ã –ø–æ–ø—ã—Ç–∫–∏

### 4.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ (–±—ç–∫–µ–Ω–¥ nudge-service)
- –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ optOut/pause
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞: ‚â§ 2 –Ω—É–¥–∂–∞ –Ω–∞ –∫–µ–π—Å
- –ü—Ä–æ–≤–µ—Ä–∫–∞ 24h –æ–∫–Ω–∞ (–∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ template –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
- –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ WA Send —Å –º—è–≥–∫–∏–º —Ç–µ–∫—Å—Ç–æ–º
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –Ω—É–¥–∂–µ–π –≤ –ë–î

### 4.3 –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–≤—Ç–æ—Ä–æ–≤ (Exponential Backoff)
**–î–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏:**
- –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 1 —Å–µ–∫—É–Ω–¥–∞
- –ú–Ω–æ–∂–∏—Ç–µ–ª—å: 2
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 16 —Å–µ–∫—É–Ω–¥
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 1s ‚Üí 2s ‚Üí 4s ‚Üí 8s ‚Üí 16s
- –ü–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–∫–∏: —ç—Å–∫–∞–ª–∞—Ü–∏—è –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è: —Ç–æ–ª—å–∫–æ –¥–ª—è Failed —Å—Ç–∞—Ç—É—Å–æ–≤, –Ω–µ –¥–ª—è validation

---

## 5. –§–ò–ù–ê–õ –ö–í–ê–õ–ò–§–ò–ö–ê–¶–ò–ò

### 5.1 –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ A1_STARTED_NOT_FINISHED
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ A2_QUALIFIED
- CRM: –ø–µ—Ä–µ–≤–æ–¥ —Å–¥–µ–ª–∫–∏ –≤ —Å—Ç–∞–¥–∏—é "–ö–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω" (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ)
- CAPI: —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ QUALIFY_COMPLETE
- –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–Ω—É—é –≤–æ—Ä–æ–Ω–∫—É

### 5.2 –ù–µ—É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (noise/–æ—Ç–∫–∞–∑)
- –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ A1_STARTED_NOT_FINISHED
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ A3_REJECTED
- CRM: —Ç–µ–≥ trash|noise, —Å–¥–µ–ª–∫–∞ –Ω–µ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç—Å—è
- –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π

---

## 6. –ö–û–ù–¢–ï–ù–¢–ù–ê–Ø –í–û–†–û–ù–ö–ê –ò E-COMMERCE

### 6.1 –ü–æ–∫–∞–∑ —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥
- –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö/–ë–î
- WA Send: –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ (interactive buttons/list —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏)
- CAPI: ViewContent –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∫–∞–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏

### 6.2 –ü—Ä–æ–≥—Ä–µ–≤–∞—é—â–∞—è —Å–µ—Ä–∏—è (Nurturing Sequence)
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –ø–æ—Å–ª–µ –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–µ—Å–∞ –∫ —Ç–æ–≤–∞—Ä—É
- CAPI: —Å–æ–±—ã—Ç–∏—è ContentView —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ content_type –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏
- –õ–æ–≥–∏–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Ç–≤–µ—Ç–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ–¥-—Å–ª–æ–≤–∞—Ö –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ –æ–ø–ª–∞—Ç–µ

### 6.3 –í—ã–±–æ—Ä –∏ –æ–ø–ª–∞—Ç–∞
- –ü—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–µ: —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
- –°–æ–∑–¥–∞–Ω–∏–µ Stripe Checkout/Payment Link —Å metadata (session_id, subscriber_id)
- WA Send: —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É
- CAPI: InitiateCheckout

### 6.4 –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã (Stripe webhook)
- `checkout.session.completed` ‚Üí CAPI Purchase
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–π: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ CA_PURCHASERS, —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ A2_QUALIFIED
- CRM: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É–º–º—ã –ø–æ–∫—É–ø–∫–∏, —Å–º–µ–Ω–∞ —Å—Ç–∞–¥–∏–∏ –Ω–∞ "–û–ø–ª–∞—á–µ–Ω–æ"
- WA Send: template message —Å —á–µ–∫–æ–º –∏ –¥–æ—Å—Ç—É–ø–∞–º–∏

---

## 7. –ö–û–î-–°–õ–û–í–ê (–ü–†–ò–û–†–ò–¢–ï–¢–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê)

**–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞**: –ø–µ—Ä–≤–∏—á–Ω–∞—è –≤ –±—ç–∫–µ–Ω–¥–µ (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã) + –¥—É–±–ª–∏—Ä—É—é—â–∞—è –≤ Flowise

### 7.1 Stop/–û—Ç–ø–∏—Å–∫–∞/Unsubscribe
- –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ `optOut=true`
- –ü—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ –≤—Å–µ—Ö –∏—Å—Ö–æ–¥—è—â–∏—Ö
- –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—É–¥–∏—Ç–æ—Ä–∏–π
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### 7.2 Pause/–ü–∞—É–∑–∞
- –ü–∞—Ä—Å–∏–Ω–≥ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 —á–∞—Å, –º–∞–∫—Å 24 —á–∞—Å–∞)
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `snoozeUntil`
- –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω—É–¥–∂–µ–π –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –≤—Ä–µ–º–µ–Ω–µ–º –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### 7.3 Start/Resume
- –°–Ω—è—Ç–∏–µ snooze –∏ optOut —Ñ–ª–∞–≥–æ–≤
- –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å —Ç–µ–∫—É—â–µ–≥–æ stepKey
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ —Å–µ—Å—Å–∏–∏

### 7.4 Operator/–û–ø–µ—Ä–∞—Ç–æ—Ä
- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- WA Send: "–ü–æ–¥–∫–ª—é—á–∞—é –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ HITL (Human In The Loop)
- –ü–∞—É–∑–∞ –±–æ—Ç–∞ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞

---

## 8. –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ò –°–û–ì–õ–ê–°–û–í–ê–ù–ù–û–°–¢–¨

### 8.1 –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏—Å—Ç–∏–Ω—ã
- **–ö–æ–¥-—Å–ª–æ–≤–∞**: –±—ç–∫–µ–Ω–¥ (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
  - Flowise: —Å—Ç—Ä–∞—Ö–æ–≤–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è edge cases (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫, —Å–±–æ–π webhook)
- **–°–æ—Å—Ç–æ—è–Ω–∏–µ —à–∞–≥–∞**: Flowise Variables + –ë–î (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)
- **–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞**: Redis/Valkey (–∂–∏–≤–∞—è) + Postgres (–∞—Ä—Ö–∏–≤)
- **–°—á–µ—Ç—á–∏–∫–∏ —Ä–µ–ø—Ä–æ–º–ø—Ç–æ–≤**: Flowise Variables (–≤ —Ä–∞–º–∫–∞—Ö —à–∞–≥–∞)
- **–°—á–µ—Ç—á–∏–∫–∏ –Ω—É–¥–∂–µ–π**: –±—ç–∫–µ–Ω–¥ nudge-service (–º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏)
- **CTWA –¥–∞–Ω–Ω—ã–µ**: –ë–î (–Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è)

### 8.2 –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- event_id = `sessionId-q{n}-hash(answer_raw)`
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –≤ –ë–î –Ω–∞ event_id
- Outbox-–ø–∞—Ç—Ç–µ—Ä–Ω —Å —Å—Ç–∞—Ç—É—Å–∞–º–∏: pending ‚Üí sent ‚Üí failed
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–µ—Ä–µ–¥ —ç–º–∏—Å—Å–∏–µ–π

---

## 9. –ú–ï–¢–†–ò–ö–ò –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê

### 9.1 Ads-—Å–∫–ª–µ–π–∫–∞
- –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –≤—ã–≥—Ä—É–∑–∫–∞ –∏–∑ Facebook Ads API
- –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ campaign_id/adset_id/ad_id/creative_id —Å CTWA
- –†–∞—Å—á–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫:
  - CPL = spend / count(QUALIFY_COMPLETE)
  - CAC = spend / count(purchases)
  - ROAS = revenue / spend
  - Qualification Rate –ø–æ —à–∞–≥–∞–º

### 9.2 –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –∏–∑ CRM
- Webhook –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–∏/–º–µ–Ω–µ–¥–∂–µ—Ä–∞
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞—É–¥–∏—Ç–æ—Ä–∏–π –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–¥–µ–ª–æ–∫
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ –∏ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
- –ë–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö WA-—Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –ø–æ —è–≤–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º)

### 9.3 –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞—à–±–æ—Ä–¥—ã
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ —á–µ—Ä–µ–∑ polling –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –≤–æ—Ä–æ–Ω–∫–∞–º
- Drill-down –¥–æ —É—Ä–æ–≤–Ω—è —Å–æ–æ–±—â–µ–Ω–∏—è
- ROI –ø–æ –∫—Ä–µ–∞—Ç–∏–≤–∞–º –∏ –∫–∞–º–ø–∞–Ω–∏—è–º
- –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV/Excel –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤

---

## 10. –¢–ò–ü–û–í–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø

### 10.1 –ü–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ Flowise
**–°–∏–º–ø—Ç–æ–º:** Variables (stepKey, answers, retries) —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –≤ null/undefined
**–ü—Ä–∏—á–∏–Ω–∞:** Flowise –Ω–µ –ø–µ—Ä—Å–∏—Å—Ç–∏—Ç Variables –º–µ–∂–¥—É —Ä–µ—Å—Ç–∞—Ä—Ç–∞–º–∏
**–†–µ—à–µ–Ω–∏–µ:** 
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ –ë–î —á–µ—Ä–µ–∑ Custom Function –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ –ë–î –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏
- Fallback: –Ω–∞—á–∞–ª–æ —Å Q1 –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### 10.2 –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π CAPI
**–°–∏–º–ø—Ç–æ–º:** –û–¥–Ω–æ —Å–æ–±—ã—Ç–∏–µ QUALIFY_Q{n} –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
**–ü—Ä–∏—á–∏–Ω–∞:** Retry –ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
**–†–µ—à–µ–Ω–∏–µ:**
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π event_id = `{sessionId}-q{n}-{hash(answer_raw)}`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ outbox –ø–µ—Ä–µ–¥ —ç–º–∏—Å—Å–∏–µ–π: `SELECT 1 FROM events_outbox WHERE event_id = ?`
- Constraint UNIQUE(event_id) –≤ –ë–î

### 10.3 –ò—Å—Ç–µ—á–µ–Ω–∏–µ 24h –æ–∫–Ω–∞ WhatsApp
**–°–∏–º–ø—Ç–æ–º:** –û—à–∏–±–∫–∞ 403/400 –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ session message —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞
**–ü—Ä–∏—á–∏–Ω–∞:** WhatsApp Policy - session messages —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 24h –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥—è—â–µ–≥–æ
**–†–µ—à–µ–Ω–∏–µ:**
- –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ template message –≤ WA Send node
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Custom Function: `last_inbound_timestamp + 24h > now()`
- –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ template –≤ Gupshup –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

### 10.4 –ù–∏–∑–∫–∏–π confidence –Ω–∞ –≤–∞–ª–∏–¥–Ω—ã—Ö –æ—Ç–≤–µ—Ç–∞—Ö
**–°–∏–º–ø—Ç–æ–º:** –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ noise (confidence < 0.3)
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ –ø—Ä–æ–º–ø—Ç–µ StepValidator
**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–æ–º–ø—Ç 5-10 –ø—Ä–∏–º–µ—Ä–æ–≤ –≤–∞–ª–∏–¥–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ false negatives: `confidence < 0.65 AND manual_review = 'valid'`
- A/B —Ç–µ—Å—Ç —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ —Å –º–µ—Ç—Ä–∏–∫–æ–π –∫–∞—á–µ—Å—Ç–≤–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏

### 10.5 –ó–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–ø—Ä–æ–º–ø—Ç–∞—Ö
**–°–∏–º–ø—Ç–æ–º:** –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
**–ü—Ä–∏—á–∏–Ω–∞:** –õ–æ–≥–∏—á–µ—Å–∫–∏–π –±–∞–≥ –≤ —Å—á–µ—Ç—á–∏–∫–µ retries –∏–ª–∏ —É—Å–ª–æ–≤–∏–∏ –≤—ã—Ö–æ–¥–∞
**–†–µ—à–µ–Ω–∏–µ:**
- –ñ–µ—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç: `retries >= 3` ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è
- –¢–∞–π–º–∞—É—Ç –Ω–∞ —à–∞–≥: 30 –º–∏–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º
- Circuit breaker: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ 5+ —ç—Å–∫–∞–ª–∞—Ü–∏—è—Ö –ø–æ–¥—Ä—è–¥

### 10.6 –î–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞—É–¥–∏—Ç–æ—Ä–∏–π Facebook
**–°–∏–º–ø—Ç–æ–º:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ Custom Audience –∏–ª–∏ –ø–æ–ø–∞–¥–∞–µ—Ç —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
**–ü—Ä–∏—á–∏–Ω–∞:** Rate limits Facebook API, –±–∞—Ç—á–∏–Ω–≥, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏
**–†–µ—à–µ–Ω–∏–µ:**
- Retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff: 1s, 2s, 4s, 8s
- Batch API –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ Audience Insights API
- Fallback: Lookalike –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö

### 10.7 –ü–æ—Ç–µ—Ä—è CTWA –∞—Ç—Ä–∏–±—É—Ü–∏–∏
**–°–∏–º–ø—Ç–æ–º:** –ö–æ–Ω–≤–µ—Ä—Å–∏—è –Ω–µ —Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å –∏—Å—Ö–æ–¥–Ω–æ–π —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–µ–π
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ—Ç–µ—Ä—è utm_* –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ campaign_id
**–†–µ—à–µ–Ω–∏–µ:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è CTWA –ø–æ–ª–µ–π –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ subscriber
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ raw referral –±–ª–æ–∫–∞ –≤ –ë–î –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–≤–µ—Ä–∫–∞ —Å Facebook Ads API –ø–æ click_id
- Manual mapping –¥–ª—è –Ω–µ—Ä–∞–∑–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–æ–Ω–≤–µ—Ä—Å–∏–π

### 10.8 –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
**–°–∏–º–ø—Ç–æ–º:** –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è, —Å—Ç–∞—Ç—É—Å "Failed" –±–µ–∑ retry
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞, –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ WhatsApp –∞–∫–∫–∞—É–Ω—Ç—ã
**–†–µ—à–µ–Ω–∏–µ:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ libphonenumber –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ WhatsApp presence —á–µ—Ä–µ–∑ Gupshup Check Contact API
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ exclude-—Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ 3 failed
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –æ –ø—Ä–æ–±–ª–µ–º–Ω–æ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ

### 10.9 –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ Flowise –ø—Ä–∏ –ø–∏–∫–æ–≤—ã—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö
**–°–∏–º–ø—Ç–æ–º:** –¢–∞–π–º–∞—É—Ç—ã, –º–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—á–µ—Ä–µ–¥–∏
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤, –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ LLM –≤—ã–∑–æ–≤—ã
**–†–µ—à–µ–Ω–∏–µ:**
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ Flowise —á–µ—Ä–µ–∑ Docker replicas
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Queue (Bull/Agenda)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ LLM –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- Circuit breaker –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö API (OpenAI, Gupshup)

### 10.10 –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ CTWA –¥–∞–Ω–Ω—ã—Ö
**–°–∏–º–ø—Ç–æ–º:** campaign_id/ad_id –ø—Ä–∏—Ö–æ–¥—è—Ç –ø—É—Å—Ç—ã–º–∏ –∏–ª–∏ —Å –º—É—Å–æ—Ä–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
**–ü—Ä–∏—á–∏–Ω–∞:** –†–∞–∑–ª–∏—á–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–∞—Ö webhook –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
**–†–µ—à–µ–Ω–∏–µ:**
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤ parser —Å–ª–æ–µ: —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ —Ä–µ–≥–µ–∫—Å–∞–º
- Fallback –Ω–∞ utm_* –∏–∑ referral.source_url –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä—è–º—ã—Ö –ø–æ–ª–µ–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ raw webhook –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–æ–≤—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è CTWA

---

## üîë –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∏ —Ä–∞–∑–≤–∏–ª–∫–∏

1. **–ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏**: 0.65 (–µ–¥–∏–Ω—ã–π –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –æ—Ç–≤–µ—Ç–æ–≤ –∞–≥–µ–Ω—Ç–∞)
2. **–†–µ–ø—Ä–æ–º–ø—Ç—ã**: –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫ —Å—Ä–∞–∑—É –≤ –¥–∏–∞–ª–æ–≥–µ (—Å—á–µ—Ç—á–∏–∫ per step)
3. **–ù—É–¥–∂–∏**: –¥–æ 2 –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π —Å –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–º —Ç–∞–π–º–∏–Ω–≥–æ–º (—Å—á–µ—Ç—á–∏–∫ per case)
4. **–°—Ç–∞–¥–∏–∏ CRM**: –¥–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ —è–≤–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º (–Ω–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
5. **–≠–º–∏—Å—Å–∏–∏**: –≤—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥ —Å outbox-–ø–∞—Ç—Ç–µ—Ä–Ω–æ–º
6. **–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö**: GOOD –∏ NOISE —Å—Ç—Ä–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã (—Ä–∞–∑–Ω—ã–µ pixels)
7. **24h –æ–∫–Ω–æ**: –∞–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ template messages –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏
8. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π event_id –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è