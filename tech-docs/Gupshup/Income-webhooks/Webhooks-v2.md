# Gupshup Webhooks - Comprehensive Technical Documentation

## Table of Contents

1. [Overview](#overview)
2. [Inbound Events Classification](#inbound-events-classification)
3. [User Events](#user-events)
4. [System Events](#system-events)
5. [Message Events](#message-events)
6. [Event Payload Structure](#event-payload-structure)
7. [Implementation Guidelines](#implementation-guidelines)
8. [Error Handling](#error-handling)
9. [Security Considerations](#security-considerations)
10. [Testing and Validation](#testing-and-validation)

## Overview

Gupshup webhooks are HTTP callbacks that deliver real-time notifications about events occurring within your WhatsApp Business API integration. These events provide crucial information about message statuses, user interactions, system updates, and account changes.

### Key Characteristics

-   **Real-time notifications**: Events are delivered immediately when they occur
-   **HTTP POST requests**: All webhooks are delivered via HTTP POST to your callback URL
-   **JSON payload**: Event data is structured in JSON format
-   **Reliable delivery**: Multiple retry attempts ensure delivery
-   **Version 2 format**: Current implementation uses v2 payload structure

### Event Categories

Gupshup webhooks are classified into four main categories:

1. **User Events**: User-initiated actions (opt-in, opt-out, sandbox interactions)
2. **System Events**: Platform-generated events (template status, account updates)
3. **Message Events**: Message delivery and status updates
4. **Billing Events**: Account billing and payment notifications _(excluded from this document)_

## Inbound Events Classification

```
Inbound Events
├── User Events
│   ├── sandbox-start
│   ├── opted-in
│   └── opted-out
├── System Events
│   ├── Template Events
│   │   ├── status-update
│   │   ├── category-update
│   │   └── quality-update
│   └── Account Events
│       ├── review-event
│       ├── status-event
│       ├── pndn-event
│       ├── tier-event
│       └── capability-event
├── Message Events
│   ├── enqueued
│   ├── failed (sync/async)
│   ├── sent
│   ├── delivered
│   ├── read
│   ├── deleted
│   ├── mismatch
│   ├── referral (CTX)
│   └── others
└── Billing Events (not covered)
```

## User Events

User events are triggered by end-user actions within the WhatsApp ecosystem. These events help track user engagement and manage subscription preferences.

### Base Payload Structure

```json
{
    "app": "DemoApp",
    "timestamp": 1580142086287,
    "version": 2,
    "type": "user-event",
    "payload": {
        "phone": "918x98xx21x4",
        "type": "sandbox-start|opted-in|opted-out"
    }
}
```

### Payload Field Descriptions

| Field           | Description                             | Example        | Type   |
| --------------- | --------------------------------------- | -------------- | ------ |
| `app`           | Application name configured in Gupshup  | "DemoApp"      | String |
| `timestamp`     | Unix timestamp when event was generated | 1580142086287  | Number |
| `version`       | Webhook version (always 2)              | 2              | Number |
| `type`          | Event category identifier               | "user-event"   | String |
| `payload.phone` | User's phone number in E.164 format     | "918x98xx21x4" | String |
| `payload.type`  | Specific user event type                | "opted-in"     | String |

### User Event Types

#### 1. Sandbox Start

Triggered when interacting with sandbox environment.

```json
{
    "app": "DemoApp",
    "timestamp": 1580142086287,
    "version": 2,
    "type": "user-event",
    "payload": {
        "phone": "callbackSetPhone",
        "type": "sandbox-start"
    }
}
```

**Trigger Conditions:**

-   App is in Sandbox mode with callback URL configured
-   Gupshup proxy bot invoked using command `Proxy {{app_name}}`

#### 2. Opted In

Triggered when user opts in to receive business notifications.

```json
{
    "app": "DemoApp",
    "timestamp": 1580142086287,
    "version": 2,
    "type": "user-event",
    "payload": {
        "phone": "918x98xx21x4",
        "type": "opted-in"
    }
}
```

**Trigger Conditions:**

-   User explicitly opts in to receive notifications
-   User sends initial message to business (24-hour window opens)

#### 3. Opted Out

Triggered when user opts out from receiving business notifications.

```json
{
    "app": "DemoApp",
    "timestamp": 1580142086287,
    "version": 2,
    "type": "user-event",
    "payload": {
        "phone": "918x98xx21x4",
        "type": "opted-out"
    }
}
```

**Trigger Conditions:**

-   User explicitly opts out from notifications
-   User blocks the business number
-   User reports business as spam

## System Events

System events are generated by the Gupshup platform when administrative actions occur, such as template approvals, account status changes, and platform updates.

### Base Payload Structure

```json
{
    "app": "jeet20",
    "timestamp": 1636986446609,
    "version": 2,
    "type": "template-event|account-event",
    "payload": {
        // Event-specific payload
    }
}
```

### Template Events

Template events notify about WhatsApp message template status changes and updates.

#### Template Status Update

```json
{
    "app": "jeet20",
    "timestamp": 1636986446609,
    "version": 2,
    "type": "template-event",
    "payload": {
        "type": "status-update",
        "id": "4dacef15-6c04-12db-b393-6190ac567eff",
        "status": "rejected|approved|paused|deleted|disabled",
        "elementName": "abcd",
        "languageCode": "en_US",
        "rejectedReason": "INVALID_FORMAT"
    }
}
```

#### Template Paused Event

```json
{
    "app": "jeet20",
    "timestamp": 1636986446609,
    "version": 2,
    "type": "template-event",
    "payload": {
        "type": "status-update",
        "id": "4dacef15-6c04-12db-b393-6190ac567eff",
        "status": "paused",
        "elementName": "abcd",
        "languageCode": "en_US",
        "description": "Your WhatsApp message template has been paused for 3 hours until Apr 25 at 8:07 AM UTC because it had issues."
    }
}
```

#### Template Category Update - Alert

```json
{
    "app": "jeet20",
    "timestamp": 1717249875000,
    "version": 2,
    "type": "template-event",
    "payload": {
        "type": "category-update",
        "id": "4dacef15-6c04-12db-b393-6190ac567eff",
        "elementName": "abcd",
        "languageCode": "en_US",
        "category": {
            "current": "MARKETING",
            "correct": "UTILITY"
        }
    }
}
```

#### Template Category Update - Final

```json
{
    "app": "jeet20",
    "timestamp": 1719815415000,
    "version": 2,
    "type": "template-event",
    "payload": {
        "type": "category-update",
        "id": "4dacef15-6c04-12db-b393-6190ac567eff",
        "elementName": "abcd",
        "languageCode": "en_US",
        "category": {
            "old": "MARKETING",
            "new": "UTILITY"
        }
    }
}
```

#### Template Quality Update

```json
{
    "app": "jeet20",
    "timestamp": 1636986446609,
    "version": 2,
    "type": "template-event",
    "payload": {
        "type": "quality-update",
        "id": "4dacef15-6c04-12db-b393-6190ac567eff",
        "status": "Active|Quality Pending|High Quality|Medium Quality|Low Quality",
        "elementName": "abcd",
        "languageCode": "en_US"
    }
}
```

### Template Event Field Descriptions

| Field              | Description                      | Possible Values                                | Example                                |
| ------------------ | -------------------------------- | ---------------------------------------------- | -------------------------------------- |
| `type`             | Template event type              | status-update, category-update, quality-update | "status-update"                        |
| `id`               | Unique template identifier       | UUID                                           | "4dacef15-6c04-12db-b393-6190ac567eff" |
| `status`           | Template status                  | REJECTED, APPROVED, DELETED, DISABLED, PAUSED  | "APPROVED"                             |
| `elementName`      | Template name                    | String                                         | "order_update"                         |
| `languageCode`     | Template language                | Language codes                                 | "en_US"                                |
| `rejectedReason`   | Rejection reason (if applicable) | Error codes                                    | "INVALID_FORMAT"                       |
| `category.current` | Current template category        | AUTHENTICATION, MARKETING, UTILITY             | "MARKETING"                            |
| `category.correct` | Correct template category        | AUTHENTICATION, MARKETING, UTILITY             | "UTILITY"                              |
| `category.old`     | Previous template category       | AUTHENTICATION, MARKETING, UTILITY             | "MARKETING"                            |
| `category.new`     | New template category            | AUTHENTICATION, MARKETING, UTILITY             | "UTILITY"                              |

### Account Events

Account events notify about WhatsApp Business Account (WABA) status changes and administrative updates.

#### Review Event

```json
{
    "app": "jeet20",
    "timestamp": 1636986446609,
    "version": 2,
    "type": "account-event",
    "payload": {
        "type": "review-event",
        "payload": {
            "status": "approved|rejected",
            "actionDate": "January 31, 2021"
        }
    }
}
```

#### Account Status Event

```json
{
    "app": "jeet20",
    "timestamp": 1636986446609,
    "version": 2,
    "type": "account-event",
    "payload": {
        "type": "status-event",
        "payload": {
            "status": "ACCOUNT_VIOLATION|ACCOUNT_DISABLE|ACCOUNT_VERIFIED|ACCOUNT_RESTRICTED",
            "reason": "Policy violation details",
            "restrictions": [
                {
                    "type": "RESTRICTION_ADD_PHONE_NUMBER_ACTION",
                    "expiry": "2024-12-31T23:59:59Z"
                }
            ]
        }
    }
}
```

#### MM Lite Onboarding Event

```json
{
    "app": "ShipxxxxxxxxxxxxxxxxxxWapp",
    "appId": "e4c9dbe0-b1ef-4add-97a2-a8fdba0666ad",
    "timestamp": 1717061550941,
    "version": 2,
    "type": "account-event",
    "payload": {
        "type": "status-event",
        "payload": {
            "status": "AD_ACCOUNT_LINKED",
            "waba_id": "<WABA_ID>",
            "owner_business_id": "<BUSINESS_PORTFOLIO_ID>",
            "ad_account_id": "<AD_ACCOUNT_ID>"
        }
    }
}
```

#### Phone Number Display Name Event

```json
{
    "app": "jeet20",
    "timestamp": 1636986446609,
    "version": 2,
    "type": "account-event",
    "payload": {
        "type": "pndn-event",
        "payload": {
            "status": "INVALID_FORMAT|NAME_END_CLIENT_VIOLATION|NAME_FORMAT_UNACCEPTABLE|NAME_NOT_CONSISTENT|NAME_INDIVIDUAL_ISSUE|NAME_ENDCLIENT_NOTRELATED",
            "phoneNumber": "+1234567890",
            "displayName": "Business Name"
        }
    }
}
```

#### Tier Event

```json
{
    "app": "jeet20",
    "timestamp": 1636986446609,
    "version": 2,
    "type": "account-event",
    "payload": {
        "type": "tier-event",
        "payload": {
            "event": "ONBOARDING|UPGRADE|DOWNGRADE|UNFLAGGED|FLAGGED",
            "currentTier": "TIER_250|TIER_1K|TIER_10K|TIER_100K|TIER_UNLIMITED",
            "newTier": "TIER_1K",
            "phoneNumber": "+1234567890"
        }
    }
}
```

#### Capability Event

```json
{
    "app": "jeet20",
    "timestamp": 1636986446609,
    "version": 2,
    "type": "account-event",
    "payload": {
        "type": "capability-event",
        "payload": {
            "maxDailyConversationPerPhone": 1000,
            "maxPhoneNumbersPerBusiness": 5,
            "phoneNumber": "+1234567890"
        }
    }
}
```

### Account Event Field Descriptions

| Field                                           | Description                  | Possible Values                          | Example                    |
| ----------------------------------------------- | ---------------------------- | ---------------------------------------- | -------------------------- |
| `review-event.status`                           | WABA review result           | approved, rejected                       | "approved"                 |
| `status-event.status`                           | Account status change        | ACCOUNT_VIOLATION, ACCOUNT_DISABLE, etc. | "ACCOUNT_VERIFIED"         |
| `pndn-event.status`                             | Phone/Display name status    | Various error codes                      | "NAME_FORMAT_UNACCEPTABLE" |
| `tier-event.event`                              | Tier change type             | ONBOARDING, UPGRADE, DOWNGRADE, etc.     | "UPGRADE"                  |
| `tier-event.currentTier`                        | Current messaging limit tier | TIER_250 to TIER_UNLIMITED               | "TIER_1K"                  |
| `capability-event.maxDailyConversationPerPhone` | Daily conversation limit     | Numeric                                  | 1000                       |
| `waba_id`                                       | WhatsApp Business Account ID | String                                   | "123456789"                |
| `ad_account_id`                                 | Meta Ad Account ID           | String                                   | "987654321"                |

## Message Events

Message events provide status updates for messages sent via the Gupshup API to WhatsApp users. These events track the complete message lifecycle from sending to delivery confirmation.

### Base Payload Structure

```json
{
    "app": "DemoAPI",
    "timestamp": 1580546677791,
    "version": 2,
    "type": "message-event",
    "payload": {
        "id": "59f8db90-c37e-4408-90ab-cc54ef8246ad",
        "gsId": "ee4a68a0-1203-4c85-8dc3-49d0b3226a35",
        "type": "enqueued|failed|sent|delivered|read|deleted",
        "destination": "91XX985XX10X",
        "payload": {},
        "ts": 1585344475,
        "timestamp": 1580546677791
    }
}
```

### Common Field Descriptions

| Field         | Description             | Example                                | Notes                                                      |
| ------------- | ----------------------- | -------------------------------------- | ---------------------------------------------------------- |
| `id`          | Message identifier      | "59f8db90-c37e-4408-90ab-cc54ef8246ad" | Gupshup ID for enqueued/failed, WhatsApp ID for DLR events |
| `gsId`        | Gupshup Message ID      | "ee4a68a0-1203-4c85-8dc3-49d0b3226a35" | Only present for DLR events (sent, delivered, read)        |
| `type`        | Message event type      | "sent"                                 | See individual event types below                           |
| `destination` | Recipient phone number  | "918x98xx21x4"                         | E.164 format                                               |
| `ts`          | Meta timestamp          | 1585344475                             | Present for sent, delivered, read events                   |
| `timestamp`   | Gupshup event timestamp | 1580546677791                          | When Gupshup generated the event                           |

> **Important Note**: Events received after a week of sending the message will not have the GSID available in the notification payload.

### Message Event Types

#### 1. Enqueued

Received when a message is successfully sent to the WhatsApp Business API client.

```json
{
    "app": "DemoAPI",
    "timestamp": 1580546677791,
    "version": 2,
    "type": "message-event",
    "payload": {
        "id": "59f8db90-c37e-4408-90ab-cc54ef8246ad",
        "type": "enqueued",
        "destination": "91XX985XX10X",
        "payload": {
            "whatsappMessageId": "gBEGkYaYVSEEAgkD7bRi9syGnBk",
            "type": "session"
        }
    }
}
```

**Payload Fields:**

-   `whatsappMessageId`: WhatsApp message ID generated while sending
-   `type`: Message type indicator (session, template, etc.)

#### 2. Failed (Sync)

Received when message sending fails synchronously.

```json
{
    "app": "DemoAPI",
    "timestamp": 1580546677791,
    "version": 2,
    "type": "message-event",
    "payload": {
        "id": "ee4a68a0-1203-4c85-8dc3-49d0b3226a35",
        "type": "failed",
        "destination": "91XX985XX10X",
        "payload": {
            "code": 1002,
            "reason": "Number Does Not Exist On WhatsApp"
        }
    }
}
```

**Payload Fields:**

-   `code`: Failure/exception code
-   `reason`: Human-readable failure reason
-   `id`: Gupshup Message ID

#### 3. Failed (Async)

Received when messages fail asynchronously (by WhatsApp docker).

```json
{
    "app": "DemoAPI",
    "timestamp": 1580546677791,
    "version": 2,
    "type": "message-event",
    "payload": {
        "gsId": "72f61f22-5aa4-4615-a970-943edf6da01c",
        "type": "failed",
        "destination": "91XX985XX10X",
        "payload": {
            "code": 1002,
            "reason": "Number Does Not Exists On WhatsApp"
        }
    }
}
```

**Payload Fields:**

-   `code`: Failure/exception code
-   `reason`: Human-readable failure reason
-   `gsId`: Gupshup Message ID

#### 4. Sent

Received when the message is sent to the end-user.

```json
{
    "app": "DemoAPI",
    "timestamp": 1580546677791,
    "version": 2,
    "type": "message-event",
    "payload": {
        "id": "gBEGkYaYVSEEAgnZxQ3JmKK6Wvg",
        "gsId": "59f8db90-c37e-4408-90ab-cc54ef8246ad",
        "type": "sent",
        "destination": "91XX985XX10X",
        "payload": {
            "ts": 1585344475
        },
        "conversation": {
            "id": "532b57b5f6e63595ccd74c6010e5c5c7",
            "expiresAt": 1518780636,
            "type": "Marketing"
        },
        "pricing": {
            "policy": "CBP",
            "category": "Marketing"
        }
    }
}
```

**Conversation Object:**

-   `id`: Unique conversation identifier
-   `expiresAt`: Conversation expiration timestamp
-   `type`: Conversation type (FEP, Marketing, Authentication, Utility, Service, marketing_lite)

**Pricing Object:**

-   `policy`: Pricing policy (CBP - Conversation Based Pricing, PMP - Per Message Pricing)
-   `category`: Pricing category (FEP, Marketing, Authentication, Utility, Service, marketing_lite)

#### 5. Delivered

Received when the message sent by your business was delivered to the user's device.

```json
{
    "app": "DemoAPI",
    "timestamp": 1580546677791,
    "version": 2,
    "type": "message-event",
    "payload": {
        "id": "gBEGkYaYVSEEAgnZxQ3JmKK6Wvg",
        "gsId": "59f8db90-c37e-4408-90ab-cc54ef8246ad",
        "type": "delivered",
        "destination": "91XX985XX10X",
        "payload": {
            "ts": 1585344475
        }
    }
}
```

#### 6. Read

Received when the message sent by your business is read by the user.

```json
{
    "app": "DemoAPI",
    "timestamp": 1580546677791,
    "version": 2,
    "type": "message-event",
    "payload": {
        "id": "gBEGkYaYVSEEAgnZxQ3JmKK6Wvg",
        "gsId": "59f8db90-c37e-4408-90ab-cc54ef8246ad",
        "type": "read",
        "destination": "91XX985XX10X",
        "payload": {
            "ts": 1585344475
        }
    }
}
```

**Important Notes:**

-   Read notifications only available for users with read receipts enabled
-   For users without read receipts, only delivered notifications are sent
-   If a message is read almost simultaneously with delivery, read notification might not be sent as delivery is implied

#### 7. Delete

**[No longer supported by Meta]** Received when a user deletes a message for everyone.

```json
{
    "app": "DemoAPI",
    "timestamp": 1580546677791,
    "version": 2,
    "type": "message-event",
    "payload": {
        "id": "gBEGkYaYVSEEAgnZxQ3JmKK6Wvg",
        "gsId": "59f8db90-c37e-4408-90ab-cc54ef8246ad",
        "type": "deleted",
        "destination": "91XX985XX10X",
        "payload": {
            "ts": 1585344475
        }
    }
}
```

#### 8. Mismatch

Triggered when the destination number provided in the API request does not match the WhatsApp ID.

```json
{
    "app": "DemoAPI",
    "timestamp": 1580546677791,
    "version": 2,
    "type": "message-event",
    "payload": {
        "id": "59f8db90-c37e-4408-90ab-cc54ef8246ad",
        "type": "mismatch",
        "destination": "553587654321",
        "payload": {
            "wa_id": "5593587654321",
            "phone": "553587654321"
        }
    }
}
```

**Payload Fields:**

-   `wa_id`: WhatsApp ID of the destination number
-   `phone`: Dialable number/given destination number

#### 9. Referral (CTX)

Received when a user clicks on a Click-to-WhatsApp ad.

```json
{
    "app": "DemoAPI",
    "timestamp": 1580546677791,
    "version": 2,
    "type": "message-event",
    "payload": {
        "id": "59f8db90-c37e-4408-90ab-cc54ef8246ad",
        "type": "referral",
        "destination": "91XX985XX10X",
        "payload": {
            "referral": {
                "source_url": "https://www.meta.com/ad/12345",
                "source_type": "ad",
                "source_id": "1234567890",
                "headline": "Get 20% off on your first order!",
                "body": "Shop now and save on your favorite items.",
                "media_type": "image",
                "image_url": "https://www.meta.com/ad/12345/image.jpg",
                "video_url": "https://www.meta.com/ad/12345/video.mp4",
                "thumbnail_url": "https://www.meta.com/ad/12345/thumbnail.jpg",
                "ctwa_clid": "abc123xyz456"
            }
        }
    }
}
```

**Referral Object Fields:**

-   `source_url`: Meta URL that leads to the clicked ad/post
-   `source_type`: Source type (ad or post)
-   `source_id`: Meta ID for the ad or post
-   `headline`: Headline used in the ad or post
-   `body`: Body text for the ad or post
-   `media_type`: Media type (image or video)
-   `image_url`: Image URL (when media_type is image)
-   `video_url`: Video URL (when media_type is video)
-   `thumbnail_url`: Video thumbnail URL (when media_type is video)
-   `ctwa_clid`: Click ID generated by Meta for Click-to-WhatsApp ads

**Supported Message Types for Referral:**

-   text
-   location
-   contact
-   image
-   video
-   document
-   voice
-   sticker

#### 10. MM Lite Events

Marketing Lite events have similar payload to regular events but with `marketing_lite` category.

```json
{
    "app": "AbdDef",
    "timestamp": 1729588576346,
    "version": 2,
    "type": "message-event",
    "payload": {
        "id": "wamid.HBgMOTE5OTg3OTkzMjc0FQIAERgSMTBEQjFDNkQzMUVBRjExRDI1AA==",
        "type": "sent",
        "destination": "919987993274",
        "payload": {
            "ts": 1729588575
        },
        "conversation": {
            "id": "b463ee712d95412611865832987e7a26",
            "expiresAt": 1729599000,
            "type": "marketing_lite"
        },
        "pricing": {
            "policy": "CBP/PMP",
            "category": "marketing_lite"
        }
    }
}
```

#### 11. Others

Miscellaneous events received asynchronously from WhatsApp Business API client.

```json
{
    "app": "DemoAPI",
    "timestamp": 1580546677791,
    "version": 2,
    "type": "message-event",
    "payload": {
        "id": "59f8db90-c37e-4408-90ab-cc54ef8246ad",
        "type": "others",
        "destination": "91XX985XX10X",
        "payload": {
            "eventType": "unknown_event",
            "description": "Ad hoc event from WABA docker"
        }
    }
}
```

## Event Payload Structure

### Common Webhook Structure

All Gupshup webhooks follow this base structure:

```json
{
  "app": "string",           // Application name
  "timestamp": number,       // Unix timestamp
  "version": number,         // Always 2
  "type": "string",         // Event type
  "payload": object         // Event-specific data
}
```

### HTTP Request Details

**Method**: POST
**Content-Type**: application/json
**Headers**:

-   User-Agent: Gupshup-Webhook/1.0
-   X-Gupshup-Signature: (when configured)

### Timestamp Handling

-   `timestamp`: When Gupshup generated the event (always present)
-   `ts`: Meta timestamp for DLR events (sent, delivered, read)
-   All timestamps are in Unix epoch format (milliseconds)

### ID Field Variations

-   **For enqueued/failed events**: `id` contains Gupshup Message ID
-   **For DLR events (sent/delivered/read)**: `id` contains WhatsApp Message ID
-   **For DLR events**: `gsId` contains Gupshup Message ID (if available)

## Implementation Guidelines

### Webhook Endpoint Setup

1. **HTTPS Required**: Webhook URLs must use HTTPS protocol
2. **Response Time**: Respond within 5 seconds to avoid timeouts
3. **Response Code**: Return HTTP 200 for successful processing
4. **Idempotency**: Handle duplicate events gracefully using unique event IDs

### Recommended Webhook Handler Structure

```javascript
app.post('/gupshup-webhook', async (req, res) => {
    try {
        const event = req.body

        // Validate webhook signature (if configured)
        if (!validateSignature(req.headers['x-gupshup-signature'], req.body)) {
            return res.status(401).send('Invalid signature')
        }

        // Process based on event type
        switch (event.type) {
            case 'user-event':
                await handleUserEvent(event)
                break
            case 'message-event':
                await handleMessageEvent(event)
                break
            case 'template-event':
                await handleTemplateEvent(event)
                break
            case 'account-event':
                await handleAccountEvent(event)
                break
            default:
                console.log('Unknown event type:', event.type)
        }

        res.status(200).send('OK')
    } catch (error) {
        console.error('Webhook processing error:', error)
        res.status(500).send('Internal Server Error')
    }
})
```

### Event Processing Best Practices

1. **Asynchronous Processing**: Handle events asynchronously to ensure quick response
2. **Queue Implementation**: Use message queues for reliable event processing
3. **Retry Logic**: Implement retry mechanism for failed webhook deliveries
4. **Logging**: Comprehensive logging for debugging and monitoring
5. **Database Storage**: Store events for audit trail and analysis

### Message State Tracking

Implement a state machine to track message lifecycle:

```javascript
const MessageStates = {
    PENDING: 'pending',
    ENQUEUED: 'enqueued',
    SENT: 'sent',
    DELIVERED: 'delivered',
    READ: 'read',
    FAILED: 'failed'
}

function updateMessageState(messageId, newState, eventData) {
    // Update message state in database
    // Log state transition
    // Trigger downstream processes
}
```

## Error Handling

### Common Error Scenarios

1. **Network Timeouts**: Webhook delivery failures due to network issues
2. **Invalid JSON**: Malformed payload structure
3. **Missing Fields**: Required fields not present in payload
4. **Duplicate Events**: Same event delivered multiple times
5. **Out-of-Order Events**: Events arriving in different sequence

### Error Response Handling

```javascript
// Return appropriate HTTP status codes
if (eventNotFound) {
    return res.status(404).send('Event not found')
}

if (validationError) {
    return res.status(400).send('Invalid event format')
}

if (processingError) {
    return res.status(500).send('Processing failed')
}

// Success
res.status(200).send('OK')
```

### Retry Strategy

Gupshup implements exponential backoff for failed webhook deliveries:

1. Initial retry after 1 second
2. Subsequent retries with increasing intervals
3. Maximum retry attempts: 10
4. Final retry after 24 hours

## Security Considerations

### Webhook Signature Verification

Enable webhook signature verification for production environments:

```javascript
const crypto = require('crypto')

function validateSignature(signature, payload, secret) {
    const expectedSignature = crypto.createHmac('sha256', secret).update(JSON.stringify(payload)).digest('hex')

    return signature === `sha256=${expectedSignature}`
}
```

### IP Whitelisting

Whitelist Gupshup IP addresses for additional security:

```
// Gupshup webhook IP ranges
52.66.99.0/24
52.66.100.0/24
```

### Data Privacy

1. **PII Handling**: Secure handling of phone numbers and user data
2. **Data Retention**: Implement appropriate data retention policies
3. **Encryption**: Encrypt sensitive data at rest and in transit
4. **Access Control**: Implement role-based access to webhook data

## Testing and Validation

### Sandbox Testing

Use Gupshup sandbox environment for testing:

1. Configure sandbox app with webhook URL
2. Test user events using proxy bot commands
3. Validate message event flows with test messages
4. Verify error handling scenarios

### Event Validation Checklist

-   [ ] All required fields present
-   [ ] Timestamp format validation
-   [ ] Phone number format validation (E.164)
-   [ ] Event type validation
-   [ ] Payload structure validation
-   [ ] Signature verification (if enabled)

### Monitoring and Alerting

Implement monitoring for:

1. **Webhook Response Time**: Monitor processing latency
2. **Error Rates**: Track failed webhook processing
3. **Event Volume**: Monitor unexpected traffic spikes
4. **Missing Events**: Detect gaps in event sequences

### Testing Tools

```bash
# Test webhook endpoint with curl
curl -X POST https://your-domain.com/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "app": "TestApp",
    "timestamp": 1580546677791,
    "version": 2,
    "type": "user-event",
    "payload": {
      "phone": "918x98xx21x4",
      "type": "opted-in"
    }
  }'
```

### Load Testing

Test webhook endpoint performance:

```javascript
// Use tools like Artillery.js for load testing
// artillery.yml configuration
config:
  target: 'https://your-domain.com'
  phases:
    - duration: 60
      arrivalRate: 10
scenarios:
  - name: "Webhook Load Test"
    requests:
      - post:
          url: "/webhook"
          json:
            app: "TestApp"
            timestamp: 1580546677791
            version: 2
            type: "message-event"
            payload:
              id: "test-message-id"
              type: "sent"
              destination: "918x98xx21x4"
```

---

## Appendices

### A. Language Codes Reference

Common language codes used in template events:

| Code  | Language             |
| ----- | -------------------- |
| en_US | English (US)         |
| hi_IN | Hindi (India)        |
| es_ES | Spanish (Spain)      |
| fr_FR | French (France)      |
| de_DE | German (Germany)     |
| pt_BR | Portuguese (Brazil)  |
| ar_AR | Arabic               |
| zh_CN | Chinese (Simplified) |

### B. Error Codes Reference

Common error codes in failed message events:

| Code | Description                       |
| ---- | --------------------------------- |
| 1001 | Invalid phone number              |
| 1002 | Number does not exist on WhatsApp |
| 1003 | Message template not found        |
| 1004 | Invalid template parameters       |
| 1005 | Rate limit exceeded               |
| 1006 | Insufficient wallet balance       |
| 1007 | Account suspended                 |
| 1008 | Invalid message format            |

### C. Phone Number Format

All phone numbers in webhooks follow E.164 format:

```
Format: +[country code][phone number]
Example: +919876543210
```

### D. Conversation Types

| Type           | Description           | Billing |
| -------------- | --------------------- | ------- |
| FEP            | Free Entry Point      | Free    |
| Marketing      | Marketing messages    | Paid    |
| Authentication | OTP/Auth messages     | Paid    |
| Utility        | Utility notifications | Paid    |
| Service        | Customer service      | Paid    |
| marketing_lite | MM Lite marketing     | Paid    |

### E. Pricing Policies

| Policy | Description                |
| ------ | -------------------------- |
| CBP    | Conversation Based Pricing |
| PMP    | Per Message Pricing        |

---

This comprehensive documentation covers all aspects of Gupshup webhook events (excluding MM Lite and billing events as requested). Use this as a reference for implementing robust webhook handling in your applications.
